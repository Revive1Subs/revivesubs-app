<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReviveSubs - نظام إدارة فريق الترجمة</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --text-main: #f7fafc; 
            --text-secondary: #a0aec0; 
            --border-color: #4a5568; 

            --header-gradient-start: #0f172a;
            --header-gradient-end: #1e293b;
            
            --footer-text: var(--text-secondary);
            --footer-border: var(--border-color);

            --report-header-bg-var: #2c3e50; 
            --report-table-th-bg-var: #34495e; 

            --money-positive-bg: rgba(16, 185, 129, 0.2);
            --money-negative-bg: rgba(239, 68, 68, 0.2);
            --money-zero-bg: rgba(245, 159, 11, 0.2);

            --accent-purple: #8b5cf6;
            --accent-blue: #3b82f6; 
            --accent-green: #10b981; 
            --accent-yellow: #f59e0b; 
            --accent-red: #ef4444; 

            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.2), 0 1px 2px 0 rgba(0, 0, 0, 0.16);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.16);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.2);

            --gradient-purple: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            --gradient-blue: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            --gradient-green: linear-gradient(135deg, var(--accent-green) 0%, #047857 100%);
            --gradient-red: linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
            --gradient-yellow: linear-gradient(135deg, var(--accent-yellow) 0%, #d97706 100%);
            --gradient-secondary: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);

            --bg-primary-user: #0f0f0f; 
            --bg-secondary-user: #1a1a1a; 
            --bg-card-user: #242424; 
            --bg-hover-user: #2a2a2a; 
            --input-bg: #4a5568;

            --card-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        html, body {
            height: 100%;
            overflow: hidden; 
        }
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .top-bar {
            height: 50px;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            z-index: 100;
            box-shadow: var(--shadow);
            flex-shrink: 0;
        }
        .top-bar-logo {
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .main-layout {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 260px;
            background: var(--bg-secondary-user);
            padding: 2rem 1rem;
            overflow-y: auto;
            border-left: 1px solid var(--border-color); 
            flex-shrink: 0;
        }
        .nav-menu { list-style: none; }
        .nav-item { margin-bottom: 0.5rem; }
        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            font-size: 0.95rem;
        }
        .nav-link:hover {
            color: var(--text-main);
            background: var(--bg-hover-user);
        }
        .nav-link.active {
            color: var(--accent-purple);
            background: rgba(139, 92, 246, 0.1);
        }
        .nav-link.active::before {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 70%;
            background: var(--accent-purple);
            border-radius: 2px;
        }
        .nav-icon { font-size: 1.1rem; width: 1.1rem; }
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .content-header {
            padding: 1rem 2rem;
            display: flex;
            justify-content: flex-end; 
            align-items: center;
            flex-shrink: 0;
        }
        .header-actions .btn-icon { display: none; }
        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 50px; right: -260px; height: calc(100vh - 50px); z-index: 999; box-shadow: var(--shadow-lg); transition: right 0.3s ease; }
            .sidebar.mobile-open { right: 0; }
            .header-actions .btn-icon { display: inline-flex; }
            .content-header { padding: 1rem; }
            .page-title { font-size: 1.25rem; }
            .content-body { padding: 1rem; }
        }
        body { padding-bottom: 0; }

        body {
            font-family: 'Segoe UI', Tahoma, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-primary-user); 
            color: var(--text-main);
            line-height: 1.6;
            direction: rtl;
            overflow-x: hidden;
        }

        #appContent { 
            padding-top: 0; 
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }
        .hidden { display: none !important; }

        .header-social-links {
            display: flex; gap: 12px; z-index: 3; 
        }
        .header-social-links a {
            color: var(--text-main); font-size: 1.1em;
            transition: all 0.25s ease-out;
            background-color: rgba(0, 0, 0, 0.35); border-radius: 50%;
            width: 32px; height: 32px;
            display: inline-flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .header-social-links a:hover {
            color: var(--accent-purple); background-color: rgba(139, 92, 246, 0.3); 
            transform: scale(1.12) translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.25);
        }

        .nav-tabs { display: flex; background-color: var(--bg-secondary-user); border-radius: 12px; overflow: hidden; margin-top: 20px; box-shadow: var(--shadow-md); }
        .nav-tab { flex: 1; padding: 16px 20px; text-align: center; cursor: pointer; background-color: var(--bg-secondary-user); border: none; font-size: 1.05em; font-weight: 500; transition: all 0.3s ease; position: relative; color: var(--text-main); }
        .nav-tab:hover { background-color: var(--bg-hover-user); }
        .nav-tab.active { background: var(--gradient-blue); color: var(--text-main); }
        .nav-tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--accent-blue); }

        .sub-nav-tabs { display: flex; justify-content: center; margin-bottom: 20px; background-color: transparent; padding: 0; border-radius: 0; box-shadow: none; gap: 10px; }
        .sub-nav-tab { padding: 10px 20px; border: none; border-radius: 6px; background-color: var(--input-bg); color: var(--text-main); cursor: pointer; transition: background-color 0.3s ease; }
        .sub-nav-tab:hover { background-color: var(--accent-blue); }
        .sub-nav-tab.active { background-color: var(--accent-purple); font-weight: bold; }

        .tab-content { background-color: transparent; padding: 0; border-radius: 12px; min-height: 500px; margin-top: 20px; }
        .tab-pane { display: none; animation: fadeIn 0.4s ease-in-out; }
        .tab-pane.active { display: block; }
        .project-sub-view { display: none; } 
        .project-sub-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 0.85em; }
        .info-item { display: flex; }
        .info-item label { font-weight: 500; color: var(--text-secondary); margin-left: 5px; white-space: nowrap; }
        .info-item span { color: var(--text-main); word-break: break-word; }
        .info-item span.clickable-meta { cursor: pointer; text-decoration: underline dotted; transition: color 0.2s ease; }
        .info-item span.clickable-meta:hover { color: var(--accent-blue); }
        .cost-breakdown .cost-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; }
        .cost-breakdown .cost-item span:first-child { color: var(--text-secondary); }
        .cost-breakdown .cost-item.total { font-weight: 600; border-top: 1px solid var(--border-color); padding-top: 5px; margin-top: 5px; }
        .project-notes-modal-content p { font-size: 0.9em; line-height: 1.5; color: var(--text-secondary); white-space: pre-wrap; }
        .project-modal-section h5 { font-size: 1em; margin-bottom: 8px; color: var(--text-main); }

        .action-btn.primary { background-color: var(--accent-blue); }
        .action-btn.secondary { background-color: var(--text-secondary); }
        .action-btn.danger { background-color: var(--accent-red); }
        .action-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .project-card-link-btn:hover { color: var(--accent-blue); }
        .project-card-link-btn i { vertical-align: middle; }
        .status-indicator.active, .status-indicator.jar { background-color: var(--accent-green); color: var(--text-main); }
        .status-indicator.upcoming, .status-indicator.qryb { background-color: var(--accent-yellow); color: var(--bg-primary-user); }
        .status-indicator.completed, .status-indicator.mktml { background-color: var(--accent-blue); color: var(--text-main); }
        .status-indicator.stopped, .status-indicator.mtqf { background-color: var(--accent-red); color: var(--text-main); }

        .circular-progress svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .circular-progress .circle-bg { fill: none; stroke: var(--border-color); stroke-width: 3; }
        .circular-progress .circle { fill: none; stroke: var(--accent-purple); stroke-width: 3; stroke-linecap: round; transition: stroke-dasharray 0.3s ease; }
        .progress-text .completed, .progress-text .total { font-size: 0.9em; }
        .progress-text .completed { color: var(--accent-blue); }
        .progress-text .separator { color: var(--text-secondary); margin: 0 1px; font-size: 0.8em; }
        .progress-text .total { color: var(--text-secondary); }
        .circular-progress { width: 60px; height: 60px; position: relative; }
        .episode-controls { display: flex; align-items: center; gap: 5px; position: relative; }
        .episode-control-btn { width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--border-color); background-color: var(--bg-secondary-user); color: var(--text-main); font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; padding: 0; line-height: 1; }
        .episode-control-btn:hover { background-color: var(--accent-purple); border-color: var(--accent-purple); transform: scale(1.1); }
        .episode-control-btn:active { transform: scale(0.95); }
        .episode-control-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .episode-control-btn:disabled:hover { background-color: var(--bg-secondary-user); border-color: var(--border-color); transform: none; }
        .project-team-avatars .avatar-group img:hover { transform: scale(1.2); z-index: 1; }
        .btn-icon { background: none; border: none; color: var(--text-secondary); font-size: 1.5em; cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s, color 0.3s ease, opacity 0.3s ease; }
        .btn-icon:hover:not(:disabled) { background-color: rgba(255,255,255,0.1); color: var(--accent-purple); }
        .btn-icon:disabled { color: #666; cursor: not-allowed; }

        .card { background: var(--bg-card-user); border-radius: 12px; box-shadow: var(--shadow); padding: 24px; margin-bottom: 20px; transition: var(--card-transition); border: 1px solid var(--border-color); position: relative; }
        .card:hover { box-shadow: var(--shadow-md); border-color: var(--accent-purple); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: 1.25em; font-weight: 600; color: var(--text-main); }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.95em; font-weight: 500; cursor: pointer; transition: all 0.3s ease; margin: 0 5px; display: inline-flex; align-items: center; gap: 8px; color: var(--text-main); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn-sm { padding: 6px 12px; font-size: 0.85em; }
        .btn-primary { background: var(--gradient-blue); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn-success { background: var(--gradient-green); }
        .btn-danger { background: var(--gradient-red); }
        .btn-warning { background: var(--gradient-yellow); color: var(--bg-primary-user);  }
        .btn-secondary { background: var(--gradient-secondary); }
        .btn-info { background: var(--gradient-blue); } 

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-main); }
        .form-control { width: 100%; padding: 10px 14px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1em; transition: all 0.3s ease; background-color: var(--input-bg); color: var(--text-main); }
        .form-control:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }

        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 12px; box-shadow: var(--shadow); background-color: var(--bg-card-user); }
        table { width: 100%; border-collapse: collapse; background-color: var(--bg-card-user); table-layout: auto; }
        th { background: linear-gradient(135deg, var(--bg-secondary-user) 0%, var(--bg-primary-user) 100%); color: var(--text-main); padding: 14px 12px; text-align: right; font-weight: 600; position: sticky; top: 0; z-index: 10; white-space: nowrap; border-bottom: 1px solid var(--border-color); }
        td { padding: 12px 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; white-space: normal; word-break: break-word; }
        tr:hover { background-color: var(--bg-hover-user); }

        .money-positive { color: var(--accent-green); font-weight: 600; }
        .money-zero { color: var(--accent-yellow); font-weight: 600; }
        .money-negative { color: var(--accent-red); font-weight: 600; }
        .stat-value.money-positive, .stat-value.money-zero, .stat-value.money-negative { padding: 2px 6px; border-radius: 4px; }
        .stat-value.money-positive { background-color: var(--money-positive-bg); }
        .stat-value.money-zero { background-color: var(--money-zero-bg); }
        .stat-value.money-negative { background-color: var(--money-negative-bg); }

        .icon { width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-left: 5px; margin-right: 0; }
        .member-social-links a { margin: 0 4px; color: var(--text-secondary); }
        .member-social-links a:hover { color: var(--accent-blue); }
        .member-social-links svg { width: 20px; height: 20px; vertical-align: middle; fill: currentColor; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.65); backdrop-filter: blur(5px); animation: fadeIn 0.3s ease; }
        .modal-content { background-color: var(--bg-card-user); margin: 3% auto; padding: 0; border-radius: 16px; width: 90%; max-width: 800px; animation: slideInModal 0.3s ease; box-shadow: var(--shadow-lg); }
        @keyframes slideInModal { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { background: linear-gradient(135deg, var(--bg-secondary-user) 0%, var(--bg-primary-user) 100%); color: var(--text-main); padding: 20px 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.5em; font-weight: 600; }
        .modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 20px 24px; border-top: 1px solid var(--border-color); text-align: left; display: flex; justify-content: flex-start; gap: 10px; }
        .close { color: var(--text-main); font-size: 28px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; line-height: 1; }
        .close:hover { transform: rotate(90deg); color: var(--accent-red); }

        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background-color: transparent; padding: 0; border-radius: 0; flex-wrap: wrap; gap: 10px; box-shadow: none; }
        .search-box { padding: 10px 16px; border: 2px solid var(--border-color); border-radius: 8px; width: 300px; font-size: 0.95em; background-color: var(--input-bg); color: var(--text-main); }
        .search-box:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
        .toolbar .form-control { width: auto; min-width: 200px; }

        .footer { text-align: center; padding: 30px 20px; margin-top: 50px; color: var(--footer-text); border-top: 1px solid var(--footer-border); }

        .text-center { text-align: center; }
        .text-sm { font-size: 0.875em; }
        .text-muted { color: var(--text-secondary); } 
        .flex { display: flex; }
        .gap-10 { gap: 10px; }
        .gap-15 { gap: 15px; }
        .gap-20 { gap: 20px; }
        .flex-wrap { flex-wrap: wrap; }
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .ai-loading-indicator { font-size: 0.9em; color: var(--text-secondary); margin-right: 10px; }

        #imagePreviewModal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
        #imagePreviewModal img { max-width: 90%; max-height: 90%; border-radius: 8px; }
        #imagePreviewModal .close-preview { position: absolute; top: 20px; right: 35px; left: auto; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }

        .spinner { border: 4px solid rgba(59,130,246,0.2); border-top: 4px solid var(--accent-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .lazy-load-sentinel { height: 20px; width: 100%; }

        .alert { position: fixed; top: 20px; left: 20px; padding: 15px 20px; border-radius: 8px; color: var(--text-main); font-weight: 500; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10001; animation: slideInAlert 0.3s ease, fadeOutAlert 0.3s ease 2.7s forwards; }
        .alert-success { background-color: var(--accent-green); }
        .alert-danger { background-color: var(--accent-red); }
        .alert-warning { background-color: var(--accent-yellow); color: var(--bg-primary-user); }
        .alert-info { background-color: var(--accent-blue); }
        @keyframes slideInAlert { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOutAlert { from { opacity: 1; } to { opacity: 0; } }

        .global-actions-container {
            position: fixed;
            bottom: 20px;
            left: 20px; 
            z-index: 1500;
            display: flex;
            gap: 10px;
            background-color: var(--bg-secondary-user);
            padding: 10px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            align-items: center;
        }
        .global-actions-container .btn-icon {
            font-size: 1.3em;
            padding: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .global-actions-container .search-box { 
            width: 250px;
            padding: 8px 12px;
            font-size: 0.9em;
            margin-left: 5px;
        }

        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            bottom: 100%; 
            left: 0;
            background-color: var(--bg-card-user);
            min-width: 160px;
            box-shadow: var(--shadow-md);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .dropdown-content a {
            color: var(--text-secondary);
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }
        .dropdown-content a:hover { 
            background-color: var(--bg-hover-user);
            color: var(--text-main);
        }
        .dropdown:hover .dropdown-content { display: block; }


        @media (max-width: 768px) {
            .header-social-links { display: none; } 
            .nav-tabs { flex-direction: column; }
            .toolbar { flex-direction: column; gap: 15px; align-items: stretch; }
            .toolbar > div { width: 100%; }
            .toolbar .form-control { width: 100%; }
            .modal-content { width: 95%; margin: 5% auto; }
            .modal-body > form > div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; gap: 10px !important; }
            .stats-hero-section, .charts-section, .active-projects-kanban .kanban-board, .financial-overview .finance-cards { grid-template-columns: 1fr !important; }
            .sub-nav-tabs { flex-direction: column; }
            .global-actions-container {
                flex-direction: row; 
                flex-wrap: wrap; 
                justify-content: center;
                bottom: 10px; left: 10px; right: 10px; width: auto;
            }
            .global-actions-container .search-box { width: calc(100% - 50px); margin-left: 0; margin-right: 5px;}
        }

        .cards-grid, .projects-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(340px, calc(100% - 20px)), 1fr)); gap: 24px; margin-top: 20px; padding: 0; box-sizing: border-box; }
        @media (min-width: 1600px) { .cards-grid, .projects-grid, #archiveCardGrid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
        @media (min-width: 1200px) and (max-width: 1599px) { .cards-grid, .projects-grid, #archiveCardGrid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        @media (min-width: 768px) and (max-width: 1199px) { .cards-grid, .projects-grid, #archiveCardGrid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (max-width: 767px) { .cards-grid, .projects-grid, #archiveCardGrid { grid-template-columns: 1fr; gap: 20px; } }

        .member-card, .project-card { width: 100%; min-width: 0; box-sizing: border-box; display: flex; flex-direction: column; height: 100%; cursor: default; animation: slideIn 0.4s ease-out; }
        .member-card *, .project-card * { min-width: 0; box-sizing: border-box; }
        .member-card .card-header { padding: 16px; background-color: rgba(255,255,255,0.03); display: flex; align-items: center; gap: 15px; }
        .member-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-left: 0; border: 2px solid var(--border-color); cursor: pointer; flex-shrink: 0; }
        .member-info { flex: 1; min-width: 0; }
        .member-info h3 { margin: 0 0 4px 0; font-size: 1.2em; font-weight: 600; color: var(--text-main); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .member-roles { display: flex; flex-wrap: wrap; gap: 6px; }
        .role-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 500; color: var(--text-main); text-transform: capitalize; }
        .role-badge.translator { background-color: var(--accent-blue); }
        .role-badge.editor { background-color: var(--accent-green); }
        .role-badge.timer { background-color: var(--accent-yellow); color: var(--bg-primary-user); } 
        .role-badge.subtitler { background-color: #5a6268; }
        .card-actions { margin-left: auto; padding-left: 10px; flex-shrink: 0; }
        .member-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .card-stats { padding: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; border-bottom: 1px solid var(--border-color); }
        .stat-item { text-align: center; padding: 8px; background-color: rgba(255,255,255,0.03); border-radius: 8px; }
        .stat-label { display: block; font-size: 0.8em; color: var(--text-secondary); margin-bottom: 4px; }
        .stat-value { font-size: 1.1em; font-weight: 600; color: var(--text-main); }
        .card-footer { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.02); border-top: 1px solid var(--border-color); margin-top: auto; gap: 10px; flex-wrap: wrap; }
        .btn-text { background: none; border: none; color: var(--accent-blue); font-weight: 500; cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: background-color 0.2s, color 0.2s; white-space: nowrap; font-size: 0.85em; }
        .btn-text:hover { background-color: rgba(59, 130, 246, 0.1); color: var(--accent-blue); }
        .social-links { display: flex; gap: 8px; flex-shrink: 0; }
        .social-links a svg { width: 18px; height: 18px; }
        @media (max-width: 400px) { .member-card .card-footer { flex-direction: column; gap: 10px; align-items: stretch; } .social-links { justify-content: center; } }

        .project-title { font-size: 1.15em; font-weight: 600; margin: 0; color: var(--text-main); line-height: 1.4; overflow: visible; text-overflow: initial; display: block; white-space: normal; word-wrap: break-word; hyphens: auto; min-height: 2.8em; }
        .project-card .project-header {
            display: flex;
            padding: 18px;
            gap: 18px;
            align-items: flex-start;
            flex-grow: 1;
        }
        .project-poster { position: relative; flex-shrink: 0; width: 90px; height: 135px; }
        .project-poster img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; }
        .project-type-badge { position: absolute; top: 5px; right: 5px; background-color: var(--accent-purple); color: var(--text-main); padding: 2px 6px; border-radius: 4px; font-size: 0.7em; font-weight: 500; }
        .project-main-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 8px; }
        .project-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.75em; color: var(--text-secondary); margin: 0; }
        .project-meta .meta-item { display: flex; align-items: center; gap: 3px; white-space: nowrap; }
        .project-meta .meta-item i { color: var(--accent-blue); font-size: 0.9em; }
        .project-genres { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .genre-tag { background-color: var(--bg-secondary-user); color: var(--text-secondary); padding: 2px 6px; border-radius: 10px; font-size: 0.7em; }
        .genre-tag.clickable-meta { cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; }
        .genre-tag.clickable-meta:hover { background-color: var(--accent-blue); color: var(--text-main); }
        .project-status-widget {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border-color);
            background-color: rgba(0,0,0,0.03);
        }
        .project-status-widget .status-badge {
            font-size: 0.8rem !important;
            padding: 5px 14px !important;
            border-radius: 15px !important;
        }
        .status-indicator { font-weight: 600; padding: 3px 8px; border-radius: 6px; font-size: 0.75em; display: inline-block; white-space: nowrap; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7em; font-weight: 600; display: flex; align-items: baseline; justify-content: center; }
        .progress-label { font-size: 0.7em; color: var(--text-secondary); margin: 0; }
        
        .project-cost-details-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: linear-gradient(135deg, var(--bg-card-user) 0%, rgba(36, 36, 36, 0.95) 100%);
            border: 2px solid var(--accent-purple);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(139, 92, 246, 0.2);
            padding: 24px;
            z-index: 2500;
            font-size: 0.9em;
            line-height: 1.8;
            animation: popupSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(10px);
        }

        @keyframes popupSlideIn {
            from { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            to { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .project-cost-details-popup h5,
        .project-cost-details-popup h6 {
            font-size: 1.15em;
            color: var(--accent-purple);
            margin: 0 0 16px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .project-cost-details-popup .cost-popup-content {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .project-cost-details-popup .cost-summary-section {
            background: rgba(255, 255, 255, 0.03);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .project-cost-details-popup .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .project-cost-details-popup .cost-item:last-child {
            border-bottom: none;
        }

        .project-cost-details-popup .cost-item strong {
            color: var(--text-main);
        }

        .project-cost-details-popup .member-payment {
            background: linear-gradient(to right, rgba(139, 92, 246, 0.1), transparent);
            border-right: 3px solid var(--accent-purple);
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .project-cost-details-popup .member-payment:hover {
            background: rgba(139, 92, 246, 0.15);
            transform: translateX(-5px);
        }

        .project-cost-details-popup .close-cost-popup {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1.5em;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .project-cost-details-popup .close-cost-popup:hover {
            background: var(--accent-red);
            color: white;
            transform: rotate(90deg);
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 2400;
            animation: fadeIn 0.3s ease;
        }
        .project-title a {
            color: inherit;
            text-decoration: none;
            transition: color 0.2s ease-in-out;
        }

        .project-title a:hover {
            color: var(--accent-blue);
            text-decoration: underline;
        }

        .project-actions {
            padding: 10px 12px;
            background-color: rgba(0,0,0,0.1);
            border-top: 1px solid var(--border-color);
        }
        .project-actions-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            width: 100%;
        }
        .project-card-checkbox { position: absolute; top: 10px; right: 10px; width: 22px; height: 22px; cursor: pointer; z-index: 5; accent-color: var(--accent-purple); }
        .project-card-delete-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 6;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(239, 68, 68, 0.5);
            color: white;
            border: none;
            font-size: 16px;
            font-weight: bold;
            line-height: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0;
            transform: scale(0.8);
        }
        .project-card:hover .project-card-delete-btn {
            opacity: 1;
            transform: scale(1);
        }
        .project-card-delete-btn:hover {
            background-color: var(--accent-red);
            transform: scale(1.1) rotate(90deg);
        }
        #archiveCardGrid .project-card-delete-btn {
            display: none;
        }
        .action-btn { flex: 1 1 auto; min-width: 60px; padding: 8px 10px; border-radius: 8px; font-size: 0.85em; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; color: var(--text-main); border: 1px solid var(--border-color); text-align: center; background: rgba(255,255,255,0.05); }
        .action-btn:hover:not(:disabled) { background: rgba(255,255,255,0.1); transform: translateY(-1px); border-color: var(--accent-blue); }
        .action-btn.danger { background-color: rgba(239, 68, 68, 0.1); border-color: var(--accent-red); }
        .action-btn.danger:hover:not(:disabled) { background-color: rgba(239, 68, 68, 0.2); }
        
        #archiveCardGrid .project-actions { flex-wrap: wrap; justify-content: space-between; padding: 10px; }
        #archiveCardGrid .action-btn { flex: 1 1 calc(50% - 4px); min-width: 90px; }

        @media (max-width: 450px) {
            .project-card .project-header { padding: 15px; gap: 12px; min-height: auto; flex-direction: column; text-align: center; }
            .project-poster { width: 100px; height: 150px; margin: 0 auto; }
            .project-main-info { text-align: center; }
            .project-status-widget { border-right: none; border-top: 1px solid var(--border-color); padding-top: 15px; padding-right: 0; width: 100%; flex-direction: column; }
            .project-title { font-size: 1.1em; min-height: auto; }
            .project-actions { padding: 12px; gap: 8px; flex-direction: column; align-items: stretch; }
        }
        
        #dashboardContent { display: flex; flex-direction: column; gap: 20px; padding: 20px 0; width: 100%; box-sizing: border-box; }
        #dashboardContent > div { width: 100%; box-sizing: border-box; }
        #dashboardContent .card { width: 100%; min-width: unset; max-width: unset; margin: 0; box-sizing: border-box; }
        .section-header { font-size: 1.3em; color: var(--text-main); margin: 20px 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid var(--accent-purple); display: flex; align-items: center; justify-content: space-between; gap: 10px; clear: both; }
        .section-header .header-title { display: flex; align-items: center; gap: 10px; }
        .section-header .header-controls { margin-right: auto; }
        #dashboardContent > div:first-child .section-header:first-child { margin-top: 0; }
        .section-header i { color: var(--accent-purple); }
        
        .charts-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; width: 100%; }
        .chart-card { padding: 15px; height: 300px; background: var(--bg-card-user); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border-color); position: relative; box-sizing: border-box; display: flex; flex-direction: column; }
        .chart-card h3 { font-size: 1.05em; margin: 0 0 15px 0; color: var(--text-main); display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .chart-card canvas { max-height: calc(100% - 45px) !important; height: auto !important; width: 100% !important; flex: 1; }
        
        #recentActivitySection .card { padding: 15px; }
        #recentActivitySection ul { list-style: none; padding: 0; margin: 0; max-height: 125px; overflow-y: auto; }
        #recentActivitySection li {
            padding: 8px 12px; 
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9em;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        #recentActivitySection li:last-child { border-bottom: none; }
        #recentActivitySection li:hover { background-color: var(--bg-hover-user); }
        #recentActivitySection li .activity-time { font-size: 0.8em; color: var(--text-main); margin-left: 10px; white-space: nowrap; }

        .financial-summaries-section { margin-top: 20px; width: 100%; clear: both; }
        .financial-summary-card { padding: 20px; margin-bottom: 20px; background: linear-gradient(135deg, var(--bg-card-user) 0%, rgba(36, 36, 36, 0.6) 100%); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border-color); box-sizing: border-box; width: 100%; }
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 10px; }
        .summary-header h4 { margin: 0; font-size: 1.1em; display: flex; align-items: center; gap: 8px; }
        .summary-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 500; background: var(--gradient-secondary); color: var(--text-main); }
        .summary-badge.anime { background: var(--gradient-purple); }
        .summary-badge.series { background: var(--gradient-green); }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; width: 100%; }
        .summary-item { text-align: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 10px; transition: all 0.3s ease; min-height: 90px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .summary-item:hover { background: rgba(255,255,255,0.05); transform: translateY(-2px); }
        .summary-item label { display: block; font-size: 0.85em; color: var(--text-secondary); margin-bottom: 6px; }
        .summary-item .amount, .summary-item .value { font-size: 1.3em; font-weight: 600; color: var(--text-main); }
        .financial-summary-card.total-summary { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border: 1px solid rgba(139, 92, 246, 0.3); }
        .financial-summary-card.anime-summary {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        .financial-summary-card.series-summary {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(4, 120, 87, 0.1) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .detailed-stats-section { margin-top: 20px; width: 100%; clear: both; }
        .detailed-stats-section .card { box-sizing: border-box; width: 100%; }
        .detailed-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding: 20px; width: 100%; box-sizing: border-box; }
        .stat-box { padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.3s ease; min-height: auto; box-sizing: border-box; }
        .stat-box:hover { background: rgba(255,255,255,0.05); border-color: var(--accent-purple); }
        .stat-box h5 { font-size: 1em; color: var(--accent-purple); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .stat-box ul { list-style: none; padding: 0; margin: 0; }
        .stat-box li { padding: 6px 0; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .stat-box li:not(:last-child) { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .stat-box li span { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .stat-box li strong { color: var(--text-main); flex-shrink: 0; margin-left: 10px; }
        .text-green { color: var(--accent-green); } .text-yellow { color: var(--accent-yellow); } .text-red { color: var(--accent-red); } .text-blue { color: var(--accent-blue); }
        .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); }
        .empty-state i { font-size: 3em; color: var(--accent-purple); margin-bottom: 15px; }
        @media (max-width: 768px) {
            #dashboardContent { gap: 20px; }
            .stats-hero-section, .charts-section { grid-template-columns: 1fr; }
            .chart-card { height: 300px; }
            .chart-card canvas { max-height: calc(100% - 45px) !important; height: auto !important; }
            .summary-grid { grid-template-columns: 1fr 1fr; gap: 15px; }
            .translator-item { flex-direction: column; text-align: center; gap: 10px; }
            .translator-info { margin: 10px 0; }
            .detailed-stats-grid { grid-template-columns: 1fr; padding: 15px; }
        }
        @media (max-width: 480px) { .summary-grid { grid-template-columns: 1fr; } }

        #archiveProjectsView { overflow: visible; }
        #archiveProjectsView h2 { margin-bottom: 20px; }
        #archiveCardGrid .project-card { width: 100%; min-width: 0; box-sizing: border-box; }
        .card-placeholder { display: flex; justify-content: center; align-items: center; min-height: 150px; color: var(--text-secondary); font-style: italic; background-color: var(--bg-card-user); padding: 20px; border-radius: 12px; grid-column: 1 / -1; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        #memberDetailsModal .modal-body { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { #memberDetailsModal .modal-body { grid-template-columns: 250px 1fr; } }
        #memberDetailsModal .member-details-main-info { text-align: center; }
        #memberDetailsModal .member-details-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin: 0 auto 15px auto; border: 3px solid var(--border-color); cursor: pointer; }
        #memberDetailsModal .member-details-roles { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 10px; }
        #memberDetailsModal .member-details-social { margin-top: 15px; text-align: center; }
        #memberDetailsModal .member-details-social a { margin: 0 8px; font-size: 1.5em; }
        #memberDetailsModal .member-projects-section h4 { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
        #memberDetailsModal .member-project-item { background-color: var(--bg-secondary-user); padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9em; cursor: pointer; transition: background-color 0.2s ease; }
        #memberDetailsModal .member-project-item:hover { background-color: var(--bg-hover-user); }
        #memberDetailsModal .member-project-item strong { color: var(--accent-purple); }

        #projectTeamModal .team-member-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        #projectTeamModal .team-member-item:last-child { border-bottom: none; }
        #projectTeamModal .team-member-item img { width: 40px; height: 40px; border-radius: 50%; margin-left: 15px; }
        #projectTeamModal .team-member-info h5 { margin: 0 0 5px 0; color: var(--text-main); }
        #projectTeamModal .team-member-info p { margin: 0; font-size: 0.9em; color: var(--text-secondary); }
        #projectTeamModal .team-member-info .role { font-weight: bold; color: var(--accent-blue); }
        #projectTeamModal .team-member-info .payment { color: var(--accent-green); }

        #projectDetailsModal .modal-body { display: grid; grid-template-columns: 1fr; gap: 20px; }
        #projectDetailsModal .project-modal-section { background-color: var(--bg-secondary-user); padding: 15px; border-radius: 8px; }
        #projectDetailsModal .project-modal-section h5 { font-size: 1.1em; color: var(--accent-purple); margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
        #projectDetailsModal .series-overview-modal { font-size: 0.9em; line-height: 1.6; color: var(--text-secondary); margin-top:10px; white-space: pre-wrap; }
        @media (min-width: 768px) { #projectDetailsModal .modal-body { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); } }

        #settings .settings-section {
            background: none;
            padding: 0;
            border: none;
            box-shadow: none;
            margin-bottom: 24px;
        }
        #settings .settings-section::before,
        #settings .settings-section::after {
            display: none;
        }
        #settings .settings-section:hover {
             transform: none;
             box-shadow: none;
             border: none;
        }
        #reportContent {
            background: transparent;
            border: none !important;
            box-shadow: none !important;
            backdrop-filter: none;
            padding: 0;
        }
        
        .settings-section h3.section-title { font-size: 1.6em; color: var(--text-main); margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--accent-purple); position: relative; display: flex; align-items: center; gap: 12px; }
        .settings-section h3.section-title::before { content: ''; width: 4px; height: 24px; background: var(--gradient-purple); border-radius: 2px; }
        .settings-section .form-group { margin-bottom: 24px; position: relative; }
        .settings-section .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-main); font-size: 0.95em; transition: color 0.3s ease; }
        .settings-section .form-control { background-color: rgba(74, 85, 104, 0.3); border: 2px solid transparent; transition: all 0.3s ease; backdrop-filter: blur(10px); }
        .settings-section .form-control:hover { background-color: rgba(74, 85, 104, 0.5); border-color: rgba(139, 92, 246, 0.3); }
        .settings-section .form-control:focus { background-color: rgba(74, 85, 104, 0.6); border-color: var(--accent-purple); box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.15); }
        .settings-section .toolbar { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; background: transparent; padding: 0; margin-top: 0; box-shadow: none; }
        .settings-section .btn { position: relative; overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .settings-section .btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(255, 255, 255, 0.2); border-radius: 50%; transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
        .settings-section .btn:hover::before { width: 300px; height: 300px; }
        .settings-section .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3); }
        .settings-section h3.section-title::after { content: ''; font-family: 'Font Awesome 5 Free'; font-weight: 900; margin-right: auto; opacity: 0.3; font-size: 1.2em; }
        #settings > .settings-section:nth-of-type(1) h3.section-title::after { content: '\f200'; }
        #settings > .settings-section:nth-of-type(2) h3.section-title::after { content: '\f0c1'; }


        #reportContent { background: rgba(36, 36, 36, 0.6); border: 1px solid rgba(139, 92, 246, 0.2); backdrop-filter: blur(10px); }
        @media print {
            .header, .nav-tabs, .footer, .alert, .modal, .toolbar, .global-actions-container,
            #settings > h2, 
            .settings-section:not(:has(#reportContent)), 
            .settings-section:has(#reportContent) > h3.section-title, 
            .settings-section:has(#reportContent) > .toolbar,
            .top-bar, .sidebar, .content-header
            { display: none !important; }

            @page { size: A4 portrait; margin: 15mm; } 
            body { background: white !important; color: black !important; font-family: 'Arial', 'Tahoma', sans-serif !important; font-size: 10pt !important; line-height: 1.4 !important; direction: rtl !important; margin: 0 !important; padding: 0 !important; height: auto; overflow: visible; }
            .app-container, .main-layout, .content-area, .content-body { display: block !important; overflow: visible !important; height: auto; }
            
            #appContent { padding: 0 !important; }
            .container { padding: 0 !important; margin: 0 !important; max-width: 100% !important; }
            .tab-content { padding: 0 !important; margin: 0 !important; border: none !important; box-shadow: none !important; }
            #settings.tab-pane.active { display: block !important; } 
            
            #reportContent { 
                display: block !important; visibility: visible !important; 
                background: white !important; color: black !important; 
                border: none !important; box-shadow: none !important; 
                padding: 0 !important; margin: 0 !important; 
                width: 100% !important; max-width: none !important; 
            }
            #reportContent .report-header { background: #f0f0f0 !important; color: black !important; border: 1px solid #333 !important; padding: 10px !important; margin-bottom: 15px !important; page-break-inside: avoid !important; }
            #reportContent .report-header h3 { font-size: 14pt !important; margin: 0 0 8px 0 !important; }
            #reportContent .report-header p { font-size: 9pt !important; margin: 0 !important; }
            #reportContent .report-section { background: white !important; border: 1px solid #ccc !important; padding: 10px !important; margin-bottom: 10px !important; page-break-inside: avoid !important; }
            #reportContent .report-section h4 { font-size: 12pt !important; margin: 0 0 8px 0 !important; border-bottom: 1px solid #666 !important; padding-bottom: 4px !important; }
            #reportContent .report-section ul { padding-right: 20px !important; margin: 0 0 10px 0; font-size: 9pt; }
            #reportContent .report-section li { margin-bottom: 4px; }
            #reportContent .table-container { overflow: visible !important; }
            #reportContent table { width: 100% !important; border-collapse: collapse !important; margin: 10px 0 !important; page-break-inside: auto !important; }
            #reportContent th, #reportContent td { border: 1px solid #666 !important; padding: 5px !important; text-align: right !important; font-size: 9pt !important; word-break: break-word !important; }
            #reportContent th { background-color: #e9e9e9 !important; font-weight: bold; }
            thead { display: table-header-group !important; }
            tfoot { display: table-footer-group !important; }
            tr { page-break-inside: avoid !important; page-break-after: auto !important; }
            a { color: #0066cc !important; text-decoration: none !important; }
            .money-positive { color: #008000 !important; }
            .money-zero { color: #f59e0b !important; }
            .money-negative { color: #cc0000 !important; }
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            
            --bg-main: #0a0e27;
            --bg-secondary: #151837;
            --bg-card: #1a1f3a;
            --bg-hover: #242943;
            
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            
            --border-color: rgba(148, 163, 184, 0.1);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.25);
        }

        body {
            background: var(--bg-main);
            background-image: 
                radial-gradient(ellipse at top left, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
            min-height: 100vh;
        }

        .top-bar {
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            height: 60px;
        }

        .top-bar-logo {
            font-size: 1.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar {
            background: rgba(21, 24, 55, 0.95);
            backdrop-filter: blur(10px);
            border-left: 1px solid var(--border-color);
        }

        .nav-link {
            border-radius: 12px;
            margin: 4px 0;
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: var(--primary-gradient);
            opacity: 0.1;
            transition: width 0.3s ease;
        }

        .nav-link:hover::before {
            width: 100%;
        }

        .nav-link.active {
            background: var(--primary-gradient);
            color: white;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .member-card {
            background: var(--bg-card);
            padding: 0;
            overflow: hidden;
        }

        .member-card .member-header {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 20px;
            text-align: center;
        }

        .member-card .member-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid transparent;
            background: linear-gradient(white, white) padding-box,
                        var(--primary-gradient) border-box;
            margin: 0 auto 15px;
            transition: transform 0.3s ease;
        }

        .member-card:hover .member-avatar {
            transform: scale(1.1) rotate(5deg);
        }

        .member-card .member-info h3 {
            font-size: 1.25rem;
            margin-bottom: 10px;
        }

        .member-card .member-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            padding: 0;
            border: none;
        }

        .member-card .member-stats > div {
            padding: 20px 10px;
            border-right: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.02);
        }

        .member-card .member-stats > div:last-child {
            border-right: none;
        }

        .member-card .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
        }

        .member-card .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 5px;
        }

        .member-card .member-footer {
            background: rgba(255, 255, 255, 0.02);
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        .project-card {
            background: var(--bg-card);
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .project-card .project-header {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, transparent 100%);
            padding: 20px;
            min-height: auto;
            flex-grow: 1;
        }

        .project-card .project-poster-wrapper {
            position: relative;
        }

        .project-card .project-poster {
            width: 100px;
            height: 150px;
            border-radius: 12px;
            object-fit: cover;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .project-card:hover .project-poster {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
        }

        .project-card .project-type-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--primary-gradient);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .project-card .project-info {
            padding: 0 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .project-card .project-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .project-card .project-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .project-card .meta-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .project-card .meta-item:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .project-card .project-genres {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: auto;
        }

        .project-card .genre-tag {
            background: var(--primary-gradient);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .project-card .genre-tag:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .project-card .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .project-card .status-badge:hover {
            transform: scale(1.05);
        }

        .circular-progress {
            width: 70px;
            height: 70px;
            margin: 10px auto;
        }

        .circular-progress svg {
            filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.3));
        }

        .circular-progress .circle-bg {
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 6;
        }

        .circular-progress .circle {
            stroke: url(#progressGradient);
            stroke-width: 6;
            stroke-linecap: round;
        }

        .circular-progress svg defs {
            content: '<linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#667eea" /><stop offset="100%" style="stop-color:#764ba2" /></linearGradient>';
        }

        .episode-control-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .episode-control-btn:hover:not(:disabled) {
            background: var(--primary-gradient);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .action-btn {
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            padding: 10px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: var(--primary-gradient);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            border-color: transparent;
        }

        .action-btn.danger:hover {
            background: var(--danger-gradient);
        }

        .btn {
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--danger-gradient);
        }

        .btn-success {
            background: var(--success-gradient);
        }

        .form-control {
            background: var(--bg-hover);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            background: var(--bg-card);
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        table {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }

        th {
            background: var(--bg-hover);
            color: var(--text-primary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
            padding: 16px 12px;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .project-cost-details-popup {
            background: var(--bg-card);
            border: 2px solid rgba(102, 126, 234, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .project-cost-details-popup h5,
        .project-cost-details-popup h6 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .project-cost-details-popup .cost-summary-section {
            background: rgba(102, 126, 234, 0.05);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
        }

        .modal-header {
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border-color);
        }

        .spinner {
            border: 3px solid rgba(102, 126, 234, 0.1);
            border-top-color: #667eea;
        }

        .alert {
            border-radius: 10px;
            padding: 16px 20px;
            font-weight: 500;
        }

        .alert-success {
            background: var(--success-gradient);
        }

        .alert-danger {
            background: var(--danger-gradient);
        }

        .alert-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
        }

        .alert-info {
            background: var(--primary-gradient);
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 20px;
        }

        .stat-box {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .role-badge.translator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .role-badge.editor {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .role-badge.timer {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
        }

        .role-badge.subtitler {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }

        .meta-clickable,
        .info-clickable,
        .info-genre-tag {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .meta-clickable:hover,
        .info-clickable:hover {
            color: #667eea;
            text-decoration: underline;
        }

        .info-genre-tag {
            display: inline-block;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 2px 8px;
            border-radius: 12px;
            margin: 0 2px;
            font-size: 0.85rem;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .info-genre-tag:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .project-card .project-header {
                text-align: center;
            }
            
            .project-card .project-poster-wrapper {
                margin: 0 auto;
            }
            
            .project-card .project-info {
                text-align: center;
                margin-top: 15px;
            }
            
            .project-card .project-meta {
                justify-content: center;
            }
            
            .project-card .project-genres {
                justify-content: center;
            }
            
            .member-card .member-stats {
                grid-template-columns: 1fr;
            }
            
            .member-card .member-stats > div {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .member-card .member-stats > div:last-child {
                border-bottom: none;
            }
        }

        .project-card .project-actions {
            margin-top: 0 !important;
            padding: 10px 12px;
        }

        .project-card > * {
            margin-bottom: 0;
        }

        .project-header {
            margin-bottom: 0 !important;
        }
    </style>
</head>
<body>
    <svg style="position: absolute; width: 0; height: 0;">
        <defs>
            <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#667eea" />
                <stop offset="100%" style="stop-color:#764ba2" />
            </linearGradient>
        </defs>
    </svg>
    <div class="app-container">
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="top-bar-logo">
                <i class="fas fa-film"></i>
                <span>ReviveSubs</span>
            </div>
            <div class="header-social-links">
                 <a href="#" id="headerLinkWebsite" target="_blank" title="الموقع الرسمي"><i class="fas fa-globe"></i></a>
                 <a href="#" id="headerLinkDiscord" target="_blank" title="Discord"><i class="fab fa-discord"></i></a>
                 <a href="#" id="headerLinkTelegram" target="_blank" title="Telegram"><i class="fab fa-telegram-plane"></i></a>
                 <a href="#" id="headerLinkDrive" target="_blank" title="Google Drive"><i class="fab fa-google-drive"></i></a>
            </div>
        </header>
    
        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <nav>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" data-page="dashboard" onclick="navigateToTab('dashboard')">
                                <i class="fas fa-chart-line nav-icon"></i>
                                <span>لوحة المعلومات</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-page="members" onclick="navigateToTab('members')">
                                <i class="fas fa-users nav-icon"></i>
                                <span>الأعضاء</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-page="projects" onclick="navigateToTab('projects')">
                                <i class="fas fa-folder-open nav-icon"></i>
                                <span>المشاريع</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-page="settings" onclick="navigateToTab('settings')">
                                <i class="fas fa-cog nav-icon"></i>
                                <span>التقارير</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>
            
            <!-- Content Area -->
            <main class="content-area">
                <!-- Content Header -->
                <header class="content-header">
                    <div class="header-actions">
                        <button class="btn-icon d-md-none" id="menuToggle" onclick="toggleSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                </header>
    
                <!-- Content Body -->
                <div class="content-body" id="contentBody">
                    <div class="tab-content">
                        <section id="dashboard" class="tab-pane active">
                            <div id="dashboardContent">
                                
                                <div class="charts-section">
                                    <div class="card chart-card"> <h3><i class="fas fa-chart-line"></i> نشاط الفريق (آخر 30 يوم)</h3> <canvas id="activityChart"></canvas> </div>
                                    <div class="card chart-card"> <h3><i class="fas fa-chart-pie"></i> توزيع المشاريع حسب الحالة</h3> <canvas id="projectStatusChart"></canvas> </div>
                                    <div class="card chart-card"> <h3><i class="fas fa-dollar-sign"></i> المدفوعات الشهرية</h3> <canvas id="monthlyPaymentsChart"></canvas> </div>
                                </div>
        
                                <div id="recentActivitySection">
                                    <h3 class="section-header">
                                        <div class="header-title"><i class="fas fa-history"></i> سجل آخر التعديلات</div>
                                    </h3>
                                    <div class="card">
                                        <ul id="recentActivityList">
                                            <li class="text-center text-muted">لا يوجد نشاط حديث.</li>
                                        </ul>
                                    </div>
                                </div>
                        
                                <div class="financial-summaries-section" id="financialSummariesSectionContainer">
                                    <h3 class="section-header">
                                        <div class="header-title"><i class="fas fa-money-bill-wave"></i> الملخصات المالية</div>
                                        <div class="header-controls">
                                            <select id="financialSummarySelect" class="form-control" onchange="showFinancialSummary(this.value)" style="width: auto;">
                                                <option value="total">الملخص الإجمالي</option>
                                                <option value="anime">ملخص الأنميات</option>
                                                <option value="series">ملخص المسلسلات</option>
                                            </select>
                                        </div>
                                    </h3>
                                    <div id="totalSummaryCard" class="financial-summary-card total-summary">
                                        <div class="summary-header"> <h4><i class="fas fa-chart-bar"></i> الملخص المالي الإجمالي</h4> <span class="summary-badge">كل المشاريع</span> </div>
                                        <div class="summary-grid">
                                            <div class="summary-item"> <label>إجمالي التكلفة</label> <span class="amount" id="totalProjectsCost">$0.00</span> </div>
                                            <div class="summary-item"> <label>المدفوع للأعضاء</label> <span class="amount" id="totalPaidAmount">$0.00</span> </div>
                                            <div class="summary-item"> <label>المستحقات المتبقية</label> <span class="amount" id="totalRemainingAmount">$0.00</span> </div>
                                            <div class="summary-item"> <label>متوسط التكلفة/حلقة</label> <span class="amount" id="avgCostPerEpisodeTotal">$0.00</span> </div>
                                        </div>
                                    </div>
                                    <div id="animeSummaryCard" class="financial-summary-card anime-summary hidden">
                                        <div class="summary-header"> <h4><i class="fas fa-tv"></i> الملخص المالي للأنميات</h4> <span class="summary-badge anime">أنمي</span> </div>
                                        <div class="summary-grid">
                                            <div class="summary-item"> <label>عدد الأنميات</label> <span class="value" id="animeProjectCount">0</span> </div>
                                            <div class="summary-item"> <label>الحلقات المنجزة</label> <span class="value" id="animeCompletedEpisodes">0</span> </div>
                                            <div class="summary-item"> <label>إجمالي التكلفة</label> <span class="amount" id="animeTotalCost">$0.00</span> </div>
                                            <div class="summary-item"> <label>متوسط التكلفة/حلقة</label> <span class="amount" id="animeAvgCostPerEpisode">$0.00</span> </div>
                                        </div>
                                    </div>
                                    <div id="seriesSummaryCard" class="financial-summary-card series-summary hidden">
                                        <div class="summary-header"> <h4><i class="fas fa-film"></i> الملخص المالي للمسلسلات</h4> <span class="summary-badge series">مسلسل</span> </div>
                                        <div class="summary-grid">
                                            <div class="summary-item"> <label>عدد المسلسلات</label> <span class="value" id="seriesProjectCount">0</span> </div>
                                            <div class="summary-item"> <label>الحلقات المنجزة</label> <span class="value" id="seriesCompletedEpisodes">0</span> </div>
                                            <div class="summary-item"> <label>إجمالي التكلفة</label> <span class="amount" id="seriesTotalCost">$0.00</span> </div>
                                            <div class="summary-item"> <label>متوسط التكلفة/حلقة</label> <span class="amount" id="seriesAvgCostPerEpisode">$0.00</span> </div>
                                        </div>
                                    </div>
                                </div>
                        
                                <div class="detailed-stats-section">
                                    <h3 class="section-header"><div class="header-title"><i class="fas fa-chart-area"></i> إحصائيات تفصيلية</div></h3>
                                    <div class="card"> <div class="detailed-stats-grid" id="detailedStatsContainer"> <div class="spinner"></div> </div> </div>
                                </div>
                            </div>
                        </section>
        
                        <section id="members" class="tab-pane">
                            <div class="toolbar">
                                <div class="flex gap-15 flex-wrap" style="align-items: center;">
                                    <button class="btn btn-primary" onclick="showEntityModal('member')"> <i class="fas fa-user-plus"></i> إضافة عضو </button>
                                    <button class="btn btn-danger" onclick="deleteSelected('members')"> <i class="fas fa-trash-alt"></i> حذف المحدد </button>
                                    <label for="selectAllMembersCard" style="display: flex; align-items: center; gap: 8px; cursor:pointer; margin-right: 10px;">
                                        <input type="checkbox" id="selectAllMembersCard" onchange="toggleSelectAllCards('members')">
                                        <span>تحديد الكل</span>
                                    </label>
                                </div>
                                <div class="flex gap-10 flex-wrap">
                                     <select id="memberSortSelect" class="form-control" onchange="sortAndLoadData('members', this.value)">
                                        <option value="name_asc" selected>الاسم (أ-ي)</option> <option value="name_desc">الاسم (ي-أ)</option>
                                        <option value="lastDelivery_desc">آخر نشاط (الأحدث)</option> <option value="lastDelivery_asc">آخر نشاط (الأقدم)</option>
                                        <option value="totalProjectEpisodes_desc">إجمالي الحلقات (الأكثر)</option> <option value="totalProjectEpisodes_asc">إجمالي الحلقات (الأقل)</option>
                                        <option value="remainingAmount_desc">المبلغ المتبقي (الأكثر)</option> <option value="remainingAmount_asc">المبلغ المتبقي (الأقل)</option>
                                    </select>
                                </div>
                            </div>
                            <div id="membersCardGrid" class="cards-grid"> <div class="card-placeholder">جاري تحميل الأعضاء...</div> </div>
                        </section>
        
                        <section id="projects" class="tab-pane">
                            <div class="sub-nav-tabs">
                                <button class="sub-nav-tab active" onclick="showProjectSubView('animeProjectsView', this)">الأنميات</button>
                                <button class="sub-nav-tab" onclick="showProjectSubView('seriesProjectsView', this)">المسلسلات</button>
                                <button class="sub-nav-tab" onclick="showProjectSubView('archiveProjectsView', this)">الأرشيف</button>
                            </div>
        
                            <div id="animeProjectsView" class="project-sub-view active">
                                <div class="toolbar">
                                    <div class="flex gap-15 flex-wrap" style="align-items: center;">
                                        <button class="btn btn-primary" onclick="showEntityModal('anime')"><i class="fas fa-plus"></i> إضافة أنمي</button>
                                        <button class="btn btn-danger" onclick="deleteSelected('anime')"><i class="fas fa-trash"></i> حذف المحدد</button>
                                        <label for="selectAllAnimeCard" style="display: flex; align-items: center; gap: 8px; cursor:pointer; margin-right: 10px;">
                                            <input type="checkbox" id="selectAllAnimeCard" onchange="toggleSelectAllCards('anime')">
                                            <span>تحديد الكل</span>
                                        </label>
                                    </div>
                                    <div class="flex gap-10 flex-wrap">
                                        <select id="animeSortSelect" class="form-control" onchange="sortAndLoadData('anime', this.value)">
                                            <option value="name_asc" selected>الاسم (أ-ي)</option> <option value="name_desc">الاسم (ي-أ)</option>
                                            <option value="totalEpisodes_desc">عدد الحلقات (الأكثر)</option> <option value="totalEpisodes_asc">عدد الحلقات (الأقل)</option>
                                            <option value="premiered_desc">تاريخ العرض (الأحدث)</option> <option value="premiered_asc">تاريخ العرض (الأقدم)</option>
                                            <option value="status">الحالة</option> <option value="duration_desc">مدة الحلقة (الأطول)</option> <option value="duration_asc">مدة الحلقة (الأقصر)</option> 
                                        </select>
                                        <select id="animeStatusFilter" class="form-control" style="width: 200px;" onchange="filterProjects('anime', this.value)">
                                            <option value="">جميع الحالات (النشطة)</option> <option value="جارٍ">جارٍ</option><option value="قريباً">قريباً</option><option value="متوقف">متوقف</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="animeCardGrid" class="projects-grid"> <div class="card-placeholder" id="animeCardPlaceholder">لا توجد أنميات لعرضها.</div> </div>
                            </div>
        
                            <div id="seriesProjectsView" class="project-sub-view">
                                <div class="toolbar">
                                    <div class="flex gap-15 flex-wrap" style="align-items: center;">
                                        <button class="btn btn-primary" onclick="showEntityModal('series')"><i class="fas fa-plus"></i> إضافة مسلسل</button>
                                        <button class="btn btn-danger" onclick="deleteSelected('series')"><i class="fas fa-trash"></i> حذف المحدد</button>
                                        <label for="selectAllSeriesCard" style="display: flex; align-items: center; gap: 8px; cursor:pointer; margin-right: 10px;">
                                            <input type="checkbox" id="selectAllSeriesCard" onchange="toggleSelectAllCards('series')">
                                            <span>تحديد الكل</span>
                                        </label>
                                    </div>
                                    <div class="flex gap-10 flex-wrap">
                                         <select id="seriesSortSelect" class="form-control" onchange="sortAndLoadData('series', this.value)">
                                            <option value="name_asc" selected>الاسم (أ-ي)</option> <option value="name_desc">الاسم (ي-أ)</option>
                                            <option value="totalEpisodes_desc">عدد الحلقات (الأكثر)</option> <option value="totalEpisodes_asc">عدد الحلقات (الأقل)</option>
                                            <option value="seriesYear_desc">سنة الإنتاج (الأحدث)</option> <option value="seriesYear_asc">سنة الإنتاج (الأقدم)</option>
                                            <option value="status">الحالة</option> <option value="duration_desc">مدة الحلقة (الأطول)</option> <option value="duration_asc">مدة الحلقة (الأقصر)</option> 
                                        </select>
                                        <select id="seriesStatusFilter" class="form-control" style="width: 200px;" onchange="filterProjects('series', this.value)">
                                            <option value="">جميع الحالات (النشطة)</option> <option value="جارٍ">جارٍ</option><option value="قريباً">قريباً</option><option value="متوقف">متوقف</option>
                                        </select>
                                    </div>
                                </div>
                                 <div id="seriesCardGrid" class="projects-grid"> <div class="card-placeholder" id="seriesCardPlaceholder">لا توجد مسلسلات لعرضها.</div> </div>
                            </div>
        
                            <div id="archiveProjectsView" class="project-sub-view">
                                <h2>أرشيف المشاريع المكتملة</h2>
                                 <div class="toolbar">
                                    <div class="flex gap-10 flex-wrap"></div>
                                    <div class="flex gap-10 flex-wrap">
                                        <select id="archiveTypeFilter" class="form-control" onchange="loadArchivedProjects(this.value)">
                                            <option value="all">جميع الأنواع</option> <option value="anime">أنمي فقط</option> <option value="series">مسلسلات فقط</option>
                                        </select>
                                        <select id="archiveSortSelect" class="form-control" onchange="sortAndLoadData('archive', this.value)">
                                            <option value="completionDate_desc" selected>تاريخ الإكمال (الأحدث)</option> <option value="completionDate_asc">تاريخ الإكمال (الأقدم)</option>
                                            <option value="name_asc">الاسم (أ-ي)</option> <option value="name_desc">الاسم (ي-أ)</option>
                                            <option value="totalEpisodes_desc">عدد الحلقات (الأكثر)</option> <option value="totalEpisodes_asc">عدد الحلقات (الأقل)</option>
                                            <option value="duration_desc">مدة الحلقة (الأطول)</option> <option value="duration_asc">مدة الحلقة (الأقصر)</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="archiveCardGrid" class="projects-grid"> <div class="card-placeholder" id="archiveCardPlaceholder">لا توجد مشاريع مكتملة في الأرشيف حالياً.</div> </div>
                            </div>
                        </section>
        
                        <section id="settings" class="tab-pane">
                            <h2>التقارير</h2>
                            <section class="settings-section">
                                <h3 class="section-title">إنشاء التقارير</h3>
                                <div class="toolbar flex-wrap gap-15" style="align-items: center;">
                                    <div>
                                        <h4 style="margin-bottom: 10px; color: var(--text-secondary);">التقارير العامة</h4>
                                        <button class="btn btn-primary" onclick="generateReport('projects')"><i class="fas fa-clipboard-list"></i> تقرير حالة المشاريع</button>
                                        <button class="btn btn-primary" onclick="generateReport('financial')"><i class="fas fa-dollar-sign"></i> تقرير مالي شامل</button>
                                    </div>
                                    <div style="border-right: 2px solid var(--border-color); padding-right: 15px; margin-right: 15px;">
                                        <h4 style="margin-bottom: 10px; color: var(--text-secondary);">التقارير المخصصة</h4>
                                        <select id="reportMemberSelect" class="form-control" onchange="generateReport('memberDetailed')" style="min-width: 250px; display: inline-block; width: auto;"> 
                                            <option value="">اختر عضوًا لتقرير مفصل...</option>
                                        </select>
                                    </div>
                                    <div style="border-right: 2px solid var(--border-color); padding-right: 15px;">
                                        <h4 style="margin-bottom: 10px; color: var(--text-secondary);">تقرير فترة الدفع</h4>
                                        <div class="flex-wrap gap-10" style="align-items: flex-end;">
                                            <div class="form-group" style="margin-bottom:0;">
                                                <label for="reportStartDate" style="font-size: 0.9em; margin-bottom: 4px;">من تاريخ</label>
                                                <input type="date" id="reportStartDate" class="form-control" style="width: 180px;">
                                            </div>
                                            <div class="form-group" style="margin-bottom:0;">
                                                <label for="reportEndDate" style="font-size: 0.9em; margin-bottom: 4px;">إلى تاريخ</label>
                                                <input type="date" id="reportEndDate" class="form-control" style="width: 180px;">
                                            </div>
                                            <button class="btn btn-primary" onclick="generateNewBillingReport()"><i class="fas fa-file-invoice-dollar"></i> إنشاء التقرير</button>
                                        </div>
                                    </div>
                                    <div style="margin-right: auto;">
                                        <h4 style="margin-bottom: 10px; color: var(--text-secondary);">إجراءات التقرير</h4>
                                        <button class="btn btn-success" onclick="printReport()"><i class="fas fa-print"></i> طباعة</button>
                                        <button class="btn btn-warning" onclick="saveReportAsHTML()"><i class="fas fa-save"></i> حفظ HTML</button>
                                    </div>
                                </div>
                                <div id="reportContent" class="mt-20"> <p class="text-center text-muted">اختر نوع التقرير لعرضه.</p> </div>
                            </section>
                        </section>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <footer class="footer"> <div class="brand">ReviveSubs</div> <p>جميع البيانات محفوظة محلياً في المتصفح (IndexedDB)</p> </footer>

    <!-- Global Actions Toolbar -->
    <div class="global-actions-container">
        <input type="text" id="globalSearchInput" class="search-box hidden" placeholder="بحث عام..." onkeyup="debouncedGlobalSearch()">
        <button id="globalSearchToggleBtn" class="btn-icon" title="بحث عام"><i class="fas fa-search"></i></button>
        
        <div class="dropdown">
            <button id="globalImportBtn" class="btn-icon" title="استيراد JSON"><i class="fas fa-file-import"></i></button>
            <div class="dropdown-content">
                <a href="#" onclick="importData('local')"><i class="fas fa-desktop"></i> من الجهاز</a>
                <a href="#" onclick="importFromCloudURL()"><i class="fas fa-cloud-download-alt"></i> من السحابة</a>
            </div>
        </div>
        
        <button id="globalUndoBtn" class="btn-icon" title="تراجع" onclick="handleUndo()" disabled><i class="fas fa-undo"></i></button>

        <div class="dropdown">
            <button id="globalExportBtn" class="btn-icon" title="تصدير JSON"><i class="fas fa-file-export"></i></button>
            <div class="dropdown-content">
                <a href="#" onclick="exportData('local')"><i class="fas fa-save"></i> إلى الجهاز</a>
                <a href="#" onclick="exportDataToCloud()"><i class="fas fa-cloud-upload-alt"></i> إلى السحابة</a>
            </div>
        </div>
    </div>


    <!-- Combined Member/Project Modal -->
    <div id="entityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="entityModalTitle"></h2><span class="close" onclick="closeModal('entityModal')">×</span>
            </div>
            <div class="modal-body">
                <form id="entityForm" onsubmit="event.preventDefault(); saveEntity();">
                    <input type="hidden" id="entityId" value="">
                    <input type="hidden" id="entityType" value="">
                    <div id="formContentContainer">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('entityModal')">إلغاء</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="memberDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;"> <div class="modal-header"> <h2 id="memberDetailsModalTitle">تفاصيل العضو</h2> <span class="close" onclick="closeModal('memberDetailsModal')">×</span> </div>
            <div class="modal-body">
                <div class="member-details-main-info">
                    <img id="memberDetailsAvatar" src="" class="member-details-avatar" alt="Avatar">
                    <h3 id="memberDetailsName" style="font-size: 1.5em; margin-bottom: 5px;"></h3>
                    <div id="memberDetailsRoles" class="member-details-roles"></div>
                    <div id="memberDetailsSocial" class="member-details-social"></div>
                    <div class="mt-20"> <h4>المبلغ المستلم:</h4> <p id="memberDetailsAmountReceived" class="text-sm text-muted"></p> </div>
                    <div class="mt-10"> <h4>طريقة الدفع:</h4> <p id="memberDetailsPaymentMethod" class="text-sm text-muted"></p> </div>
                    <div class="mt-20"> <h4>ملاحظات:</h4> <p id="memberDetailsNotes" class="text-sm text-muted" style="white-space: pre-wrap;"></p> </div>
                </div>
                <div class="member-projects-section"> <h4>المشاريع التي عمل عليها</h4> <div id="memberDetailsProjectsList" style="max-height: 40vh; overflow-y: auto;"></div> </div>
            </div>
            <div class="modal-footer"> <button type="button" class="btn btn-secondary" onclick="closeModal('memberDetailsModal')">إغلاق</button> </div>
        </div>
    </div>

    <div id="instructionsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="instructionsModalTitle"></h2>
                <span class="close" onclick="closeModal('instructionsModal')">×</span>
            </div>
            <div class="modal-body" id="instructionsModalBody" style="line-height: 1.8;">
            </div>
            <div class="modal-footer" id="instructionsModalFooter">
            </div>
        </div>
    </div>

    <div id="tmdbResultsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"> <h2>نتائج البحث في TMDB</h2> <span class="close" onclick="closeModal('tmdbResultsModal')">×</span> </div>
            <div class="modal-body"> <p>اختر المسلسل الصحيح من القائمة:</p> <ul id="tmdbResultsList"></ul> </div>
            <div class="modal-footer"> <button type="button" class="btn btn-secondary" onclick="closeModal('tmdbResultsModal')">إلغاء</button> </div>
        </div>
    </div>

    <div id="imagePreviewModal" class="modal" onclick="this.style.display='none'"> <span class="close-preview" onclick="closeModal('imagePreviewModal')">×</span> <img id="previewImage" src="" alt="معاينة الصورة"> </div>

    <div id="projectTeamModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header"> <h2 id="projectTeamModalTitle">فريق عمل المشروع</h2> <span class="close" onclick="closeModal('projectTeamModal')">×</span> </div>
            <div class="modal-body" id="projectTeamModalBody"> <p class="text-center text-muted">جاري تحميل تفاصيل الفريق...</p> </div>
            <div class="modal-footer"> <button type="button" class="btn btn-secondary" onclick="closeModal('projectTeamModal')">إغلاق</button> </div>
        </div>
    </div>

    <div id="projectDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header"> <h2 id="projectDetailsModalTitle">تفاصيل المشروع</h2> <span class="close" onclick="closeModal('projectDetailsModal')">×</span> </div>
            <div class="modal-body" id="projectDetailsModalBody"></div>
             <div class="modal-footer"> <button type="button" class="btn btn-secondary" onclick="closeModal('projectDetailsModal')">إغلاق</button> </div>
        </div>
    </div>

    <template id="memberCardTemplate">
        <article class="member-card card" style="padding:0; overflow:hidden;">
            <div class="member-header" style="padding:1rem; display:flex; gap:1rem; align-items:center; background-color: rgba(255,255,255,0.03);">
                <img src="" class="member-avatar" alt="Avatar" style="width:60px; height:60px; border-radius:50%; object-fit:cover; border:2px solid var(--border-color); cursor:pointer;">
                <div class="member-info" style="flex:1; min-width:0;">
                    <h3 style="margin:0 0 4px 0; font-size:1.1rem;"></h3>
                    <div class="member-roles" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
                </div>
                <input type="checkbox" class="member-checkbox" title="تحديد العضو" style="width:20px; height:20px; cursor:pointer;">
            </div>
            <div class="member-stats" style="padding:1rem; display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; text-align:center; border-top:1px solid var(--border-color); border-bottom:1px solid var(--border-color);">
                <div> <span class="stat-label" style="font-size:0.8em; color:var(--text-secondary);">الحلقات</span> <span class="stat-value episodes" style="font-size:1.2rem; font-weight:600;">0</span> </div>
                <div> <span class="stat-label" style="font-size:0.8em; color:var(--text-secondary);">المستحقات</span> <span class="stat-value dues" style="font-size:1.2rem; font-weight:600;">$0.00</span> </div>
                <div> <span class="stat-label" style="font-size:0.8em; color:var(--text-secondary);">آخر نشاط</span> <span class="stat-value last-activity" style="font-size:1.0rem;">غير معروف</span> </div>
            </div>
            <div class="member-footer" style="padding:1rem; display:flex; justify-content:space-between; align-items:center; margin-top:auto;">
                <div class="social-links" style="display:flex; gap:0.5rem;"></div>
                <div class="member-actions" style="display:flex; gap:0.5rem;">
                    <button class="btn-text edit-btn"><i class="fas fa-edit"></i> تعديل</button>
                    <button class="btn-text view-details-btn"><i class="fas fa-eye"></i> عرض التفاصيل</button>
                </div>
            </div>
        </article>
    </template>
    
    <template id="projectCardTemplate">
        <article class="project-card card" style="padding:0; overflow:hidden;">
            <button class="project-card-delete-btn" title="حذف المشروع مباشرة">×</button>
            <input type="checkbox" class="project-card-checkbox">
            <div class="project-header">
                <div class="project-poster-wrapper" style="position: relative; flex-shrink: 0;">
                    <img src="" class="project-poster" style="width: 90px; height: 135px; border-radius: 8px; object-fit: cover; cursor: pointer;">
                    <span class="project-type-badge" style="position: absolute; top: 5px; right: 5px; padding: 2px 6px; background: var(--accent-purple); color: white; border-radius: 4px; font-size: 0.7rem;"></span>
                </div>
                <div class="project-info" style="flex: 1; min-width: 0; display: flex; flex-direction: column;">
                    <h3 class="project-title" style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.3;"></h3>
                    <div class="project-meta" style="display: flex; gap: 0.75rem; flex-wrap: wrap; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;"></div>
                    <div class="project-genres" style="display: flex; gap: 4px; flex-wrap: wrap; margin-top: auto;"></div>
                </div>
            </div>
            <div class="project-status-widget">
                <span class="status-badge" style="padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;"></span>
                <div class="progress-circle" style="width: 60px; height: 60px; position: relative;">
                     <svg viewBox="0 0 36 36"><path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" style="fill:none; stroke:var(--border-color); stroke-width:3;"></path><path class="circle-progress" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" style="fill:none; stroke:var(--accent-purple); stroke-width:3; stroke-linecap:round;"></path></svg>
                     <div class="progress-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.75rem; font-weight: 600; display:flex; align-items:baseline;"></div>
                </div>
                <p class="progress-label" style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;"></p>
                <div class="episode-controls" style="display: flex; align-items: center; gap: 0.25rem;"></div>
            </div>
            <div class="project-actions">
                <div class="project-actions-buttons">
                    <!-- Action buttons will be inserted here by JS -->
                </div>
            </div>
        </article>
    </template>

    
    <template id="memberFormTemplate">
        <div class="form-group">
            <label for="member-form-name">اسم العضو *</label>
            <input type="text" class="form-control" id="member-form-name" required>
        </div>
        <div class="form-group">
            <label for="member-form-avatarUrl">رابط صورة العضو (Avatar URL)</label>
            <input type="url" class="form-control" id="member-form-avatarUrl" placeholder="https://example.com/avatar.png">
        </div>
        <div class="form-group">
            <label>الأدوار *</label>
            <fieldset style="border: 1px solid var(--border-color); padding: 10px; border-radius: 8px;">
                <div class="flex gap-20 flex-wrap">
                    <label><input type="checkbox" id="member-form-role-translator" value="translator"> مترجم</label>
                    <label><input type="checkbox" id="member-form-role-editor" value="editor"> مدقق</label>
                    <label><input type="checkbox" id="member-form-role-timer" value="timer"> محاكي</label>
                    <label><input type="checkbox" id="member-form-role-subtitler" value="subtitler"> موقت</label>
                </div>
            </fieldset>
        </div>
        <div class="form-group">
            <label for="member-form-amountReceived">المبلغ المستلم</label>
            <input type="number" class="form-control" id="member-form-amountReceived" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
            <label for="member-form-paymentMethod">طريقة الدفع</label>
            <input type="text" class="form-control" id="member-form-paymentMethod" placeholder="مثال: PayPal, بنك محلي, Binance">
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div class="form-group">
                <label for="member-form-twitterHandle">حساب X (Twitter)</label>
                <input type="text" class="form-control" id="member-form-twitterHandle" placeholder="@username أو رابط">
            </div>
            <div class="form-group">
                <label for="member-form-discordHandle">حساب ديسكورد</label>
                <input type="text" class="form-control" id="member-form-discordHandle" placeholder="username#0000">
            </div>
            <div class="form-group">
                <label for="member-form-telegramHandle">حساب تيليجرام</label>
                <input type="text" class="form-control" id="member-form-telegramHandle" placeholder="@username أو رابط">
            </div>
        </div>
        <div class="form-group">
            <label for="member-form-blog">المدونة/الموقع</label>
            <input type="url" class="form-control" id="member-form-blog" placeholder="https://example.com">
        </div>
        <div class="form-group">
            <label for="member-form-notes">ملاحظات</label>
            <textarea class="form-control" id="member-form-notes" rows="3"></textarea>
        </div>
    </template>

    <script>
        const API_PROXY_URL = '/api/github-proxy';

        function debounce(func, delay) { let timeout; return function(...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), delay); }; }
        function isValidUrl(string) { try { new URL(string); return true; } catch (_) { return false; } }
        function isValidSocialHandle(handle, pattern) { return pattern.test(handle) || isValidUrl(handle); }
        const twitterPattern = /^@?[a-zA-Z0-9_]{1,15}$/;
        const telegramPattern = /^@?[a-zA-Z0-9_]{5,32}$/;

        function getEl(id) { return document.getElementById(id); }
        function getVal(id) { const el = getEl(id); return el ? el.value.trim() : ''; }
        function setVal(id, value) { const el = getEl(id); if (el) el.value = value || ''; }
        
        function toggleVisibility(id, show, useActiveClass = false) { 
            const el = getEl(id); 
            if (el) {
                if (useActiveClass) {
                    if (show) el.classList.add('active');
                    else el.classList.remove('active');
                } else {
                    el.classList.toggle('hidden', !show);
                }
            }
        }

        function setChecked(id, checked) { const el = getEl(id); if (el) el.checked = checked; }
        function isChecked(id) { const el = getEl(id); return el ? el.checked : false; }
        function setHTML(id, html) { const el = getEl(id); if (el) el.innerHTML = html; }
        function setText(id, text) { const el = getEl(id); if (el) el.textContent = text; }
        function setDisabled(id, disabled) { const el = getEl(id); if (el) el.disabled = disabled; }
        function setStyle(id, property, value) { const el = getEl(id); if (el) el.style[property] = value; }
        function addClass(id, className) { const el = getEl(id); if (el) el.classList.add(className); }
        function removeClass(id, className) { const el = getEl(id); if (el) el.classList.remove(className); }


        const DB_NAME = "ReviveSubsDB", STORE_NAME = "appDataStore", DB_VERSION = 2, MAIN_DATA_KEY = "mainApplicationData";
        let data = { version: "3.0.0" };
        
        let undoStack = [];
        const MAX_UNDO_STACK_SIZE = 20;

        const PROJECT_BASE_CONFIG = {
            formFields: ['projectStatus', 'totalEpisodes', 'completedEpisodesProject', 'projectTranslator', 'projectEditor', 'projectTimer', 'projectSubtitler', 'translationPrice', 'editingPrice', 'timerPrice', 'subtitlerPrice', 'translationBonus', 'editingBonus', 'timerBonus', 'subtitlerBonus', 'rawUrl'],
            numberFields: ['totalEpisodes', 'completedEpisodesProject', 'translationPrice', 'editingPrice', 'timerPrice', 'subtitlerPrice', 'translationBonus', 'editingBonus', 'timerBonus', 'subtitlerBonus'],
            selectFields: ['projectStatus', 'projectTranslator', 'projectEditor', 'projectTimer', 'projectSubtitler']
        };

        const PROJECT_CONFIG = {
            anime: {
                ...PROJECT_BASE_CONFIG, type: 'anime', nameLabel: 'اسم الأنمي', modalTitleAdd: 'إضافة أنمي جديد', modalTitleEdit: 'تعديل بيانات الأنمي',
                fetchDataFnName: 'fetchExternalData', fetchButtonId: 'fetchMalDataBtn', fetchLoaderId: 'malFetchLoader',
                externalApiFields: ['projectMalId', 'projectUrl', 'projectImageUrl', 'projectAnimeType', 'projectStudio', 'projectSource', 'projectPremiered', 'projectGenres', 'projectThemes', 'projectDuration', 'projectRating', 'projectScore', 'projectSynopsis'],
                dataProperties: { malId: 'projectMalId', url: 'projectUrl', imageUrl: 'projectImageUrl', animeType: 'projectAnimeType', studio: 'projectStudio', source: 'projectSource', premiered: 'projectPremiered', genres: 'projectGenres', themes: 'projectThemes', duration: 'projectDuration', rating: 'projectRating', score: 'projectScore', synopsis: 'projectSynopsis' },
                genreProperty: 'genres', posterProperty: 'imageUrl', yearProperty: 'premiered', ratingProperty: 'score', durationProperty: 'duration',
                externalLinkProperty: 'url', externalLinkName: 'MAL', primaryLinkSelector: '.mal-link', secondaryLinkSelector: '.tmdb-link',
                statusFilterId: 'animeStatusFilter', cardGridId: 'animeCardGrid', selectAllCheckboxId: 'selectAllAnimeCard'
            },
            series: {
                ...PROJECT_BASE_CONFIG, type: 'series', nameLabel: 'اسم المسلسل', modalTitleAdd: 'إضافة مسلسل جديد', modalTitleEdit: 'تعديل بيانات المسلسل',
                fetchDataFnName: 'fetchExternalData', fetchButtonId: 'fetchTmdbDataBtn', fetchLoaderId: 'tmdbFetchLoader',
                externalApiFields: ['projectSeriesNameSearch', 'projectTmdbUrl', 'projectSeriesYear', 'projectSeriesNetwork', 'projectSeriesStatusTMDB', 'projectSeriesOverview', 'projectSeriesGenres', 'projectSeriesVoteAverage', 'projectSeriesPosterUrl', 'projectSeriesOriginCountry', 'projectSeriesOriginalLanguage', 'projectSeriesEpisodeRunTime'],
                dataProperties: { seriesNameSearch:'projectSeriesNameSearch', url: 'projectTmdbUrl', seriesYear: 'projectSeriesYear', seriesNetwork: 'projectSeriesNetwork', seriesStatusTMDB: 'projectSeriesStatusTMDB', seriesOverview: 'projectSeriesOverview', seriesGenres: 'projectSeriesGenres', seriesVoteAverage: 'projectSeriesVoteAverage', seriesPosterUrl: 'projectSeriesPosterUrl', seriesOriginCountry: 'projectSeriesOriginCountry', seriesOriginalLanguage: 'projectSeriesOriginalLanguage', seriesEpisodeRunTime: 'projectSeriesEpisodeRunTime' },
                genreProperty: 'seriesGenres', posterProperty: 'seriesPosterUrl', yearProperty: 'seriesYear', ratingProperty: 'seriesVoteAverage', durationProperty: 'seriesEpisodeRunTime',
                externalLinkProperty: 'url', externalLinkName: 'TMDB', primaryLinkSelector: '.tmdb-link', secondaryLinkSelector: '.mal-link',
                statusFilterId: 'seriesStatusFilter', cardGridId: 'seriesCardGrid', selectAllCheckboxId: 'selectAllSeriesCard'
            }
        };

        let unsavedChanges = false;
        let selectedItems = { members: new Set(), anime: new Set(), series: new Set(), archive: new Set() };
        let currentSort = { members: 'name_asc', anime: 'name_asc', series: 'name_asc', archive: 'completionDate_desc' };
        let chartInstances = {};
        const LAZY_LOAD_BATCH_SIZE = 10;
        let lazyLoadCounters = { members: 0, anime: 0, series: 0, archive: 0 };
        let intersectionObservers = { members: null, anime: null, series: null, archive: null };
        let currentFilteredAndSortedItems = { members: [], anime: [], series: [], archive: [] };
        
        let globalSearchQuery = "";
        const debouncedGlobalSearch = debounce(handleGlobalSearch, 300);
        
        async function importFromCloudURL() {
            if (unsavedChanges && !confirm('لديك تغييرات غير محفوظة. هل أنت متأكد من المتابعة؟')) {
                return;
            }
            if (!confirm('سيؤدي استيراد البيانات من السحابة إلى الكتابة فوق جميع البيانات الحالية. هل أنت متأكد؟')) {
                return;
            }

            showAlert('جاري استيراد البيانات من السحابة...', 'info', 5000);

            try {
                const response = await fetch(API_PROXY_URL);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`فشل جلب الملف: ${errorData.message || response.statusText}`);
                }

                const fileData = await response.json();
                
                if (!fileData.content) {
                     throw new Error("الملف موجود في المستودع لكنه فارغ.");
                }
                
                const contentBase64 = fileData.content;
                const contentString = decodeURIComponent(escape(window.atob(contentBase64)));
                const imported = JSON.parse(contentString);

                const defaultStructure = initializeDefaultDataStructure(false);
                if (imported && Array.isArray(imported.members)) {
                    // --- هذا هو الجزء المصحح ---
                    data = { ...defaultStructure, ...imported };
                    data.settings = { ...defaultStructure.settings, ...(imported.settings || {}) };
                    if (!Array.isArray(data.recentActivityLog)) data.recentActivityLog = [];
                    // --- نهاية الجزء المصحح ---
                    
                    await saveData();
                    unsavedChanges = false;
                    logRecentActivity(`تم استيراد البيانات بنجاح من السحابة.`);
                    showAlert('تم استيراد البيانات بنجاح. سيتم إعادة تحميل الصفحة.', 'success', 5000);
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    showAlert('ملف البيانات من السحابة غير صالح.', 'danger');
                }
            } catch (error) {
                console.error("Error importing from cloud:", error);
                showAlert(`خطأ أثناء استيراد البيانات من السحابة: ${error.message}`, 'danger');
            }
        }
        
        async function exportDataToCloud() {
    if (!confirm('هل أنت متأكد من رغبتك في تصدير البيانات الحالية إلى السحابة؟')) {
        return;
    }
    
    showAlert('جاري التصدير إلى السحابة...', 'info', 15000);
    
    try {
        // الخطوة 1: جلب حالة الملف الحالية للحصول على SHA
        const getFileResponse = await fetch(API_PROXY_URL);
        if (!getFileResponse.ok) {
            // إذا كان الملف غير موجود (404)، فالـ sha سيكون null
            if (getFileResponse.status === 404) {
                console.log("File doesn't exist yet. Proceeding without sha.");
            } else {
                throw new Error(`فشل جلب حالة الملف: ${getFileResponse.statusText}`);
            }
        }
        
        const fileData = getFileResponse.ok ? await getFileResponse.json() : {};
        const sha = fileData.sha || null;

        // الخطوة 2: تجهيز البيانات وإرسالها إلى الوسيط
        const dataToExport = { ...data, version: data.version, lastCloudExport: new Date().toISOString() };
        const contentString = JSON.stringify(dataToExport, null, 2);
        const contentBase64 = btoa(unescape(encodeURIComponent(contentString)));

        const updateResponse = await fetch(API_PROXY_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: contentBase64, sha: sha })
        });

        if (!updateResponse.ok) {
            const errorData = await updateResponse.json();
            throw new Error(`فشل التصدير: ${errorData.message || updateResponse.statusText}`);
        }
        
        showAlert('تم تصدير البيانات بنجاح إلى السحابة!', 'success');
        logRecentActivity(`تم تصدير البيانات بنجاح إلى GitHub.`);
        
    } catch (error) {
        console.error("Cloud export error:", error);
        showAlert(`خطأ في التصدير السحابي: ${error.message}`, 'danger');
    }
}

        function importData(source = 'local') {
            if (source === 'local') {
                handleLocalImport();
            } else if (source === 'cloud') {
                importFromCloudURL();
            }
        }

        function navigateToTab(tabName) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.page === tabName);
            });

            const titles = {
                dashboard: 'لوحة المعلومات',
                members: 'الأعضاء',
                projects: 'المشاريع',
                settings: 'التقارير'
            };
            
            document.getElementById('sidebar').classList.remove('mobile-open');
            
            showTab(null, tabName); 
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        }

        function showTab(event, tabName) {
            requestAnimationFrame(() => {
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                const currentTabPane = getEl(tabName);
                if (currentTabPane) currentTabPane.classList.add('active');

                const actions = {
                    'dashboard': updateDashboard, 
                    'members': () => sortAndLoadData('members', currentSort.members),
                    'projects': () => { 
                        const activeSubNav = document.querySelector('#projects .sub-nav-tab.active');
                        if (activeSubNav) {
                            const viewId = activeSubNav.getAttribute('onclick').match(/'([^']+)'/)[1];
                            showProjectSubView(viewId, activeSubNav);
                        } else {
                            showProjectSubView('animeProjectsView', document.querySelector('#projects .sub-nav-tab[onclick*="animeProjectsView"]'));
                        }
                    },
                    'settings': loadSettings 
                };
                if (actions[tabName]) actions[tabName]();
                if (tabName === 'dashboard') {
                    updateRecentActivityDisplay();
                    showFinancialSummary(getVal('financialSummarySelect'));
                }
            });
        }

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => { const db = event.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME); };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => { console.error("IndexedDB error:", event.target.error); reject(event.target.error); };
            });
        }

        async function loadData() {
            try {
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, "readonly");
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(MAIN_DATA_KEY);
                return new Promise((resolve, reject) => {
                    request.onsuccess = async (event) => {
                        const savedData = event.target.result;
                        const defaultStructure = initializeDefaultDataStructure(false);
                        if (savedData) {
                            if (savedData.version !== data.version) console.warn(`Data version mismatch. Current: ${data.version}, Saved: ${savedData.version}. Attempting to merge.`);
                            data = { ...defaultStructure, ...savedData }; 
                            data.settings = { ...defaultStructure.settings, ...savedData.settings }; // Ensure settings are merged
                            data.members = (savedData.members || []); 
                            data.anime = savedData.anime || []; data.series = savedData.series || []; 
                            data.recentActivityLog = savedData.recentActivityLog || []; 
                        } else {
                            data = defaultStructure; await saveData(); 
                        }
                        updateHeaderSocialLinks();
                        unsavedChanges = false; resolve();
                    };
                    request.onerror = (event) => { console.error('Error loading data from IndexedDB:', event.target.error); requestAnimationFrame(() => showAlert('خطأ في تحميل البيانات. سيتم استخدام البيانات الافتراضية.', 'danger')); data = initializeDefaultDataStructure(false); resolve(); };
                });
            } catch (error) { console.error("Failed to open DB for loading:", error); requestAnimationFrame(() => showAlert('فشل فتح قاعدة البيانات. سيتم استخدام البيانات الافتراضية.', 'danger')); data = initializeDefaultDataStructure(false); return Promise.resolve(); }
        }

        function initializeDefaultDataStructure(setGlobal = true) {
            const defaultStructure = {
                version: "3.0.0", lastSaved: new Date().toISOString(),
                settings: { 
                    headerLinkWebsiteUrl: "https://revivesubs.com/", 
                    headerLinkDiscordUrl: "https://discord.com/channels/1374998765420810331/1374998766096220223", 
                    headerLinkTelegramUrl: "https://t.me/FartCloud0", 
                    headerLinkDriveUrl: "https://drive.google.com/drive/folders/1MUM7NMtiHxi__MDNBwKAuTzTU1dT-LXR" 
                },
                members: [], anime: [], series: [], 
                recentActivityLog: [] 
            };
            if (setGlobal) data = JSON.parse(JSON.stringify(defaultStructure));
            return defaultStructure;
        }

        async function saveData() {
            try {
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, "readwrite");
                const store = transaction.objectStore(STORE_NAME);
                data.lastSaved = new Date().toISOString();
                const request = store.put(data, MAIN_DATA_KEY);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => { unsavedChanges = false; console.log('Data saved to IndexedDB successfully.'); resolve(true); };
                    request.onerror = (event) => { console.error('Error saving data to IndexedDB:', event.target.error); requestAnimationFrame(() => showAlert('خطأ أثناء حفظ البيانات في IndexedDB!', 'danger')); reject(false); };
                });
            } catch (error) { console.error("Failed to open DB for saving:", error); requestAnimationFrame(() => showAlert('فشل فتح قاعدة البيانات للحفظ!', 'danger')); return Promise.resolve(false); }
        }
        
        function pushToUndoStack(actionType, dataBefore, description) {
            undoStack.push({ actionType, dataBefore, description, timestamp: new Date() });
            if (undoStack.length > MAX_UNDO_STACK_SIZE) {
                undoStack.shift();
            }
            updateUndoButtonState();
        }

        function updateUndoButtonState() {
            const undoBtn = getEl('globalUndoBtn');
            if (undoBtn) {
                undoBtn.disabled = undoStack.length === 0;
            }
        }

        async function handleUndo() {
    const lastAction = undoStack.pop();
    if (!lastAction) return;

    const { actionType, dataBefore, description } = lastAction;
    let success = false;
    let undoDescription = '';

    try {
        let undoLogDetails = null;

        switch (actionType) {
            case 'ADD_MEMBER':
                data.members = data.members.filter(m => m.id !== dataBefore.id);
                undoDescription = `إضافة العضو ${description}`;
                break;
            case 'UPDATE_MEMBER':
                const memberUpdateIndex = data.members.findIndex(m => m.id === dataBefore.member.id);
                if (memberUpdateIndex > -1) data.members[memberUpdateIndex] = dataBefore.member;
                undoDescription = `تعديل العضو ${description}`;
                break;
            case 'DELETE_MEMBER':
                data.members.push(...dataBefore.items);
                undoDescription = `حذف ${description}`;
                break;

            case 'ADD_PROJECT':
                data[dataBefore.type] = data[dataBefore.type].filter(p => p.id !== dataBefore.id);
                undoDescription = `إضافة المشروع ${description}`;
                break;
            case 'UPDATE_PROJECT':
                const projectUpdateIndex = data[dataBefore.project.type].findIndex(p => p.id === dataBefore.project.data.id);
                if (projectUpdateIndex > -1) data[dataBefore.project.type][projectUpdateIndex] = dataBefore.project.data;
                undoDescription = `تعديل المشروع ${description}`;
                break;
            case 'DELETE_PROJECT':
                data[dataBefore.type].push(...dataBefore.items);
                undoDescription = `حذف ${description}`;
                break;
            case 'DIRECT_DELETE_PROJECT':
                data[dataBefore.type].push(dataBefore.item);
                undoDescription = `حذف المشروع ${description}`;
                break;

            case 'UPDATE_EPISODES':
                const originalProject = data[dataBefore.type].find(p => p.id === dataBefore.project.id);
                const originalCompleted = originalProject ? originalProject.completedEpisodes : 0;
                
                const projIndex = data[dataBefore.type].findIndex(p => p.id === dataBefore.project.id);
                if(projIndex > -1) data[dataBefore.type][projIndex] = dataBefore.project;

                const newCompleted = dataBefore.project.completedEpisodes;
                const change = newCompleted - originalCompleted;
                
                if (change !== 0) {
                    undoLogDetails = {
                        type: 'EPISODE_PROGRESS',
                        projectId: dataBefore.project.id,
                        projectType: dataBefore.type,
                        change: change, 
                        episodeNumber: originalCompleted,
                        costChange: (
                            (dataBefore.project.translationPrice || 0) + 
                            (dataBefore.project.editingPrice || 0) + 
                            (dataBefore.project.timerPrice || 0) + 
                            (dataBefore.project.subtitlerPrice || 0)
                        ) * change,
                        team: {
                            translator: { id: dataBefore.project.translatorId, price: dataBefore.project.translationPrice || 0 },
                            editor: { id: dataBefore.project.editorId, price: dataBefore.project.editingPrice || 0 },
                            timer: { id: dataBefore.project.timerId, price: dataBefore.project.timerPrice || 0 },
                            subtitler: { id: dataBefore.project.subtitlerId, price: dataBefore.project.subtitlerPrice || 0 },
                        }
                    };
                }
                
                undoDescription = `تحديث حلقات ${description}`;
                break;
            
            case 'RECORD_PAYMENT':
                const paymentUndoIndex = data.members.findIndex(m => m.id === dataBefore.member.id);
                if (paymentUndoIndex > -1) {
                    data.members[paymentUndoIndex] = dataBefore.member; 
                }
                undoDescription = `تسجيل ${description}`;
                break;
        }
        
        recalculateAllMemberData();
        
        if (undoLogDetails) {
            logRecentActivity(`(تراجع) ${undoDescription}`, undoLogDetails);
        }

        success = await saveData();
    } catch (err) {
        console.error("Error during undo operation:", err);
        showAlert('حدث خطأ أثناء عملية التراجع.', 'danger');
        undoStack.push(lastAction);
    }

    if (success) {
        showAlert(`تم التراجع عن: ${undoDescription}`, 'info', 4000);
        updateAllDisplays();
    }
    updateUndoButtonState();
}

        document.addEventListener('DOMContentLoaded', async function() {
            initializeApp();
            getEl('globalSearchToggleBtn').addEventListener('click', () => {
                const searchInput = getEl('globalSearchInput');
                searchInput.classList.toggle('hidden');
                if (!searchInput.classList.contains('hidden')) {
                    searchInput.focus();
                }
            });
        });

        async function initializeApp() {
            try { 
                await loadData(); 
                validateProjectData(); 
            } catch (error) { 
                console.error("Error during initial data load:", error); 
                requestAnimationFrame(() => showAlert("حدث خطأ أثناء تحميل البيانات الأولية.", "danger")); 
                data = initializeDefaultDataStructure(false); 
            }
            
            recalculateAllMemberData();
            
            const animeStatusFilterEl = getEl(PROJECT_CONFIG.anime.statusFilterId);
            if (animeStatusFilterEl) animeStatusFilterEl.value = '';
            
            const seriesStatusFilterEl = getEl(PROJECT_CONFIG.series.statusFilterId);
            if (seriesStatusFilterEl) seriesStatusFilterEl.value = '';
            
            updateAllDisplays(); 
            populateMemberReportDropdown();
            
            window.addEventListener('beforeunload', (e) => {
                if (unsavedChanges) {
                    requestAnimationFrame(() => showAlert(
                        'تنبيه: لديك تغييرات غير محفوظة. إغلاق الصفحة الآن قد يؤدي إلى فقدان هذه التغييرات.',
                        'warning',
                        7000
                    ));
                    const confirmationMessage = 'لديك تغييرات غير محفوظة. هل أنت متأكد أنك تريد المغادرة وفقدان هذه التغييرات؟';
                    e.preventDefault(); 
                    e.returnValue = confirmationMessage; 
                    return confirmationMessage; 
                }
            });
            
            showProjectSubView('animeProjectsView', document.querySelector('.sub-nav-tab[onclick*="animeProjectsView"]'));
            ['members', 'anime', 'series'].forEach(type => updateDeleteButtonText(type));
            updateUndoButtonState();
        }

        function updateAllDisplays() {
            updateDashboard();
            sortAndLoadData('members', currentSort.members);
            const activeProjectSubViewButton = document.querySelector('#projects .sub-nav-tab.active');
            if (activeProjectSubViewButton) {
                if (activeProjectSubViewButton.textContent.includes("الأنميات")) sortAndLoadData('anime', currentSort.anime);
                else if (activeProjectSubViewButton.textContent.includes("المسلسلات")) sortAndLoadData('series', currentSort.series);
                else if (activeProjectSubViewButton.textContent.includes("الأرشيف")) loadArchivedProjects(getVal('archiveTypeFilter'));
            } else sortAndLoadData('anime', currentSort.anime); 
            loadSettings(); 
            updateRecentActivityDisplay(); 
        }
        
        function showProjectSubView(viewId, clickedButton) {
            requestAnimationFrame(() => {
                document.querySelectorAll('#projects .sub-nav-tab').forEach(btn => btn.classList.remove('active'));
                if (clickedButton) clickedButton.classList.add('active');
                document.querySelectorAll('.project-sub-view').forEach(view => {
                    if (view.id === viewId) view.classList.add('active');
                    else view.classList.remove('active');
                });

                if (viewId === 'animeProjectsView') sortAndLoadData('anime', currentSort.anime);
                else if (viewId === 'seriesProjectsView') sortAndLoadData('series', currentSort.series);
                else if (viewId === 'archiveProjectsView') loadArchivedProjects(getVal('archiveTypeFilter'));
            });
        }

        function closeModal(modalId) { requestAnimationFrame(() => setStyle(modalId, 'display', 'none')); }
        function getMoneyClass(amount) { const num = Number(amount); return num > 0 ? 'money-positive' : num === 0 ? 'money-zero' : 'money-negative'; }
        function formatMoney(amount) { const num = Number(amount); return `${num < 0 ? '-' : ''}$${Math.abs(num).toFixed(2)}`; }
        function generateUniqueId() { return Date.now().toString(36) + Math.random().toString(36).substring(2); }
        function formatDate(dateString) {
            if (!dateString) return '-';
            try { 
                const date = new Date(dateString); 
                if (isNaN(date.getTime())) { 
                    if (/^\d{4}(-\d{2})?$/.test(dateString)) return dateString.split('T')[0];
                    return dateString; 
                } 
                return date.toLocaleDateString('en-GB'); 
            } catch (e) { 
                return dateString; 
            }
        }
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            try { const date = new Date(dateString); return date.toLocaleString('ar-EG', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }); } catch (e) { return dateString; }
        }
        function roleToArabic(role) { const map = {translator:'مترجم',editor:'مدقق',timer:'محاكي',subtitler:'موقت'}; return map[role]||role; }
        function getDurationInMinutes(item, itemType) { 
            let durationStr = itemType === 'anime' ? item.duration : itemType === 'series' ? item.seriesEpisodeRunTime : "";
            if (!durationStr) return 0; if (typeof durationStr === 'number') return durationStr;
            if (Array.isArray(durationStr)) { const nums = durationStr.map(d => parseInt(d, 10)).filter(n => !isNaN(n)); return nums.length > 0 ? nums[0] : 0; }
            const matches = String(durationStr).match(/(\d+)\s*hr/i) || String(durationStr).match(/(\d+)\s*min/i) || String(durationStr).match(/^\s*(\d+)\s*$/);
            return matches && matches[1] ? parseInt(matches[1]) * (String(durationStr).includes('hr') ? 60 : 1) : 0;
        }

        function getProcessedItemsForType(type) { 
            let itemsToProcess = [];
            const projectConf = PROJECT_CONFIG[type];
            const statusFilterValue = projectConf ? getVal(projectConf.statusFilterId) : '';

            try {
                if (type === 'archive') {
                    const archiveTypeFilter = getVal('archiveTypeFilter');
                    const archivedAnime = data.anime.filter(p => p.status === 'مكتمل');
                    const archivedSeries = data.series.filter(p => p.status === 'مكتمل');
                    if (archiveTypeFilter === 'all' || archiveTypeFilter === 'anime') {
                        itemsToProcess.push(...archivedAnime.map(p => ({...p, projectTypeInternal: 'anime'})));
                    }
                    if (archiveTypeFilter === 'all' || archiveTypeFilter === 'series') {
                        itemsToProcess.push(...archivedSeries.filter(s => !itemsToProcess.some(it => it.id === s.id))
                                                        .map(p => ({...p, projectTypeInternal: 'series'})));
                    }
                } else { 
                    itemsToProcess = [...data[type === 'member' ? 'members' : type]]; 
                    if (type === 'anime' || type === 'series') {
                        itemsToProcess = itemsToProcess.filter(p => p.status !== 'مكتمل'); 
                        if (statusFilterValue && statusFilterValue !== "") {
                            itemsToProcess = itemsToProcess.filter(p => p.status === statusFilterValue);
                        }
                    }
                }

                if (globalSearchQuery) {
                    const query = globalSearchQuery.toLowerCase();
                    itemsToProcess = itemsToProcess.filter(item => {
                        try {
                            const searchableFields = [];
                            
                            if (item.name) {
                                searchableFields.push(item.name.toLowerCase());
                            }
                            
                            if (type === 'member' || type === 'members') {
                                if (Array.isArray(item.roles)) {
                                    item.roles.forEach(role => {
                                        searchableFields.push(roleToArabic(role).toLowerCase());
                                        searchableFields.push(role.toLowerCase());
                                    });
                                }
                                
                                [...data.anime, ...data.series].forEach(project => {
                                    if (project.translatorId === item.id || 
                                        project.editorId === item.id || 
                                        project.timerId === item.id || 
                                        project.subtitlerId === item.id) {
                                        if (project.name) {
                                            searchableFields.push(project.name.toLowerCase());
                                        }
                                    }
                                });
                                
                            } else { 
                                const currentConfig = PROJECT_CONFIG[item.projectTypeInternal || type];
                                
                                if (item.status) {
                                    searchableFields.push(item.status.toLowerCase());
                                }
                                
                                ['translatorId', 'editorId', 'timerId', 'subtitlerId'].forEach(roleId => {
                                    if (item[roleId]) {
                                        const member = data.members.find(m => m.id === item[roleId]);
                                        if (member && member.name) {
                                            searchableFields.push(member.name.toLowerCase());
                                        }
                                    }
                                });
                                
                                if (currentConfig && currentConfig.genreProperty && item[currentConfig.genreProperty]) {
                                    const genres = item[currentConfig.genreProperty];
                                    if (Array.isArray(genres)) {
                                        genres.forEach(genre => {
                                            if (genre != null) {
                                                searchableFields.push(String(genre).toLowerCase());
                                            }
                                        });
                                    }
                                }
                                
                                if (currentConfig && currentConfig.yearProperty && item[currentConfig.yearProperty]) {
                                    const yearValue = item[currentConfig.yearProperty];
                                    if (yearValue != null) {
                                        const year = String(yearValue).split('-')[0];
                                        if (year) {
                                            searchableFields.push(year);
                                        }
                                    }
                                }
                                
                                if (item.studio && typeof item.studio === 'string') searchableFields.push(item.studio.toLowerCase());
                                if (item.seriesNetwork && typeof item.seriesNetwork === 'string') searchableFields.push(item.seriesNetwork.toLowerCase());
                                if (item.animeType && typeof item.animeType === 'string') searchableFields.push(item.animeType.toLowerCase());
                                if (item.duration != null) searchableFields.push(String(item.duration).toLowerCase());
                                if (item.rating != null) searchableFields.push(String(item.rating).toLowerCase());
                                if (item.score != null) searchableFields.push(String(item.score).toLowerCase());
                            }
                            
                            return searchableFields.some(field => field.includes(query));
                            
                        } catch (error) {
                            console.error('Error processing search for item:', item, error);
                            return false; 
                        }
                    });
                }

                const [field, order] = (currentSort[type === 'member' ? 'members' : type] || 'name_asc').split('_');
                const isAsc = order === 'asc';
                
                const sortVal = (item, fieldName) => {
                    switch(fieldName) {
                        case 'name': return (item.name || '').toLowerCase();
                        case 'lastDelivery': return item.lastDelivery ? new Date(item.lastDelivery).getTime() : (isAsc ? Infinity : -Infinity);
                        case 'totalProjectEpisodes': return (item.projectTranslatedEpisodes||0)+(item.projectEditedEpisodes||0)+(item.projectTimedEpisodes||0)+(item.projectSubtitledEpisodes||0);
                        case 'remainingAmount': return (item.totalFee || 0) - (item.amountReceived || 0);
                        case 'totalEpisodes': return item.totalEpisodes || 0;
                        case 'premiered': 
                            const dA = item.premiered ? (item.premiered.split('T')[0] || item.premiered) : null; 
                            return dA ? (new Date(dA).getTime() || parseInt(dA, 10) || 0) : (isAsc ? Infinity : -Infinity);
                        case 'seriesYear': return parseInt(item.seriesYear, 10) || (isAsc ? Infinity : -Infinity);
                        case 'status': 
                            const sO = { 'جارٍ': 1, 'قريباً': 2, 'متوقف': 3, 'مكتمل': 4 }; 
                            return sO[item.status] || 5;
                        case 'completionDate': return item.completionDate ? new Date(item.completionDate).getTime() : (isAsc ? Infinity : -Infinity);
                        case 'duration': return getDurationInMinutes(item, type === 'archive' ? item.projectTypeInternal : type);
                        default: return (item.name || '').toLowerCase();
                    }
                };
                
                itemsToProcess.sort((a, b) => {
                    let valA = sortVal(a, field), valB = sortVal(b, field);
                    if (valA < valB) return isAsc ? -1 : 1; 
                    if (valA > valB) return isAsc ? 1 : -1;
                    if (field !== 'name') { 
                        let nA = (a.name || '').toLowerCase(), nB = (b.name || '').toLowerCase(); 
                        if (nA < nB) return -1; 
                        if (nA > nB) return 1; 
                    }
                    return 0;
                });
                
            } catch (error) {
                console.error('Error in getProcessedItemsForType:', error);
                showAlert('حدث خطأ أثناء معالجة البيانات. يرجى التحقق من وحدة التحكم.', 'danger');
            }
            
            return itemsToProcess;
        }

        function handleGlobalSearch() {
            globalSearchQuery = getEl('globalSearchInput').value.toLowerCase().trim();
            const currentOpenTab = document.querySelector('.tab-pane.active')?.id;

            if (currentOpenTab) {
                if (currentOpenTab === 'dashboard') {
                    updateDashboard(); 
                } else if (currentOpenTab === 'members') {
                    sortAndLoadData('members', currentSort.members);
                } else if (currentOpenTab === 'projects') {
                    const activeSubNav = document.querySelector('#projects .sub-nav-tab.active');
                    const activeSubViewId = activeSubNav ? Array.from(activeSubNav.attributes).find(attr => attr.name === 'onclick')?.value.match(/'([^']+)'/)[1] : null;
                    if (activeSubViewId === 'animeProjectsView') sortAndLoadData('anime', currentSort.anime);
                    else if (activeSubViewId === 'seriesProjectsView') sortAndLoadData('series', currentSort.series);
                    else if (activeSubViewId === 'archiveProjectsView') loadArchivedProjects(getVal('archiveTypeFilter'));
                }
            }
        }

        function quickSearch(searchTerm) {
            const cleanTerm = String(searchTerm).trim();
            if (!cleanTerm) return;
            
            const searchInput = getEl('globalSearchInput');
            if (searchInput) {
                searchInput.value = cleanTerm;
                
                if (searchInput.classList.contains('hidden')) {
                    searchInput.classList.remove('hidden');
                }
                
                globalSearchQuery = cleanTerm.toLowerCase();
                
                updateCurrentView();
                
                searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                searchInput.focus();
                searchInput.select();
            }
        }
        
        function updateCurrentView() {
            const currentTab = document.querySelector('.tab-pane.active')?.id;
            
            if (currentTab === 'dashboard') {
                updateDashboard();
            } else if (currentTab === 'members') {
                sortAndLoadData('members', currentSort.members);
            } else if (currentTab === 'projects') {
                const activeSubView = document.querySelector('.sub-nav-tab.active');
                if (activeSubView?.textContent.includes('الأنميات')) {
                    sortAndLoadData('anime', currentSort.anime);
                } else if (activeSubView?.textContent.includes('المسلسلات')) {
                    sortAndLoadData('series', currentSort.series);
                } else if (activeSubView?.textContent.includes('الأرشيف')) {
                    loadArchivedProjects(getVal('archiveTypeFilter'));
                }
            }
        }


        function sortAndLoadData(type, sortValue) { 
            const effectiveType = type === 'member' ? 'members' : type;
            currentSort[effectiveType] = sortValue; 
            currentFilteredAndSortedItems[effectiveType] = getProcessedItemsForType(type);
            loadDataIntoGrid(type, currentFilteredAndSortedItems[effectiveType]); 
        }
        function filterProjects(type, statusFilter) { currentFilteredAndSortedItems[type] = getProcessedItemsForType(type); loadDataIntoGrid(type, currentFilteredAndSortedItems[type]); }

        function loadDataIntoGrid(type, itemsToLoad) { 
            const effectiveType = type === 'member' ? 'members' : type;
            const gridContainerId = PROJECT_CONFIG[effectiveType]?.cardGridId || `${effectiveType}CardGrid`;
            const gridContainer = getEl(gridContainerId);
            const placeholderId = `${effectiveType}CardPlaceholder`; 
            const placeholder = getEl(placeholderId);
            if (!gridContainer) return;

            requestAnimationFrame(() => {
                gridContainer.innerHTML = ''; 
                if (intersectionObservers[effectiveType]) { intersectionObservers[effectiveType].disconnect(); intersectionObservers[effectiveType] = null; }
                lazyLoadCounters[effectiveType] = 0; 

                if (itemsToLoad.length === 0) {
                    const entityName = type === 'members' ? 'أعضاء' : (PROJECT_CONFIG[type]?.nameLabel || 'عناصر');
                    if (placeholder) { placeholder.textContent = `لا يوجد ${entityName} لعرضهم.`; placeholder.style.display = 'block'; gridContainer.appendChild(placeholder); } 
                    else gridContainer.innerHTML = `<div class="card-placeholder">لا يوجد ${entityName} لعرضهم.</div>`;
                    updateMasterCheckbox(type); return;
                }
                if (placeholder) placeholder.style.display = 'none';
                currentFilteredAndSortedItems[effectiveType] = itemsToLoad; loadNextBatch(type); 
            });
        }

        function loadNextBatch(type) {
            const effectiveType = type === 'member' ? 'members' : type;
            const gridContainerId = PROJECT_CONFIG[effectiveType]?.cardGridId || `${effectiveType}CardGrid`;
            const gridContainer = getEl(gridContainerId);
            const templateId = type === 'members' ? 'memberCardTemplate' : 'projectCardTemplate';
            const template = getEl(templateId);
            if (!gridContainer || !template) return;

            const itemsToLoad = currentFilteredAndSortedItems[effectiveType];
            if (!itemsToLoad) return;

            const startIndex = lazyLoadCounters[effectiveType];
            const endIndex = Math.min(startIndex + LAZY_LOAD_BATCH_SIZE, itemsToLoad.length);
            const fragment = document.createDocumentFragment();

            for (let i = startIndex; i < endIndex; i++) {
                const item = itemsToLoad[i]; if (!item || !item.id) continue;
                const clone = template.content.cloneNode(true);
                const cardElement = clone.querySelector('.member-card, .project-card');
                cardElement.dataset.id = item.id; cardElement.style.cursor = 'default'; 
                let itemSpecificType = type === 'archive' ? (item.projectTypeInternal || (data.anime.some(a => a.id === item.id) ? 'anime' : 'series')) : type;
                cardElement.dataset.type = itemSpecificType; 
                type === 'members' ? populateMemberCard(cardElement, item) : populateProjectCard(cardElement, item, itemSpecificType);
                fragment.appendChild(clone);
            }
            
            requestAnimationFrame(() => {
                gridContainer.appendChild(fragment); lazyLoadCounters[effectiveType] = endIndex;
                const oldSentinel = gridContainer.querySelector('.lazy-load-sentinel'); if (oldSentinel) oldSentinel.remove();
                if (endIndex < itemsToLoad.length) {
                    const sentinel = document.createElement('div'); sentinel.className = 'lazy-load-sentinel'; gridContainer.appendChild(sentinel);
                    if (intersectionObservers[effectiveType]) intersectionObservers[effectiveType].disconnect();
                    intersectionObservers[effectiveType] = new IntersectionObserver(entries => { if (entries[0].isIntersecting) loadNextBatch(type); }, { rootMargin: '200px' });
                    intersectionObservers[effectiveType].observe(sentinel);
                }
                updateMasterCheckbox(type);
            });
        }
        
        function updateCardInDOM(originalType, itemId, itemData) {
            const typeForGrid = originalType === 'member' ? 'members' : originalType;
            let gridContainerId = PROJECT_CONFIG[typeForGrid]?.cardGridId || `${typeForGrid}CardGrid`;
            if (originalType !== 'member' && itemData.status === 'مكتمل') {
                gridContainerId = 'archiveCardGrid';
            }
            
            const cardElement = document.querySelector(`#${gridContainerId} .card[data-id="${itemId}"]`);

            if (cardElement && itemData) {
                requestAnimationFrame(() => {
                    const parent = cardElement.parentElement, scrollTop = parent ? parent.scrollTop : 0;
                    let itemSpecificType = originalType; 
                     if (originalType === 'archive' && itemData) { 
                        itemSpecificType = itemData.projectTypeInternal || (data.anime.some(a => a.id === itemId) ? 'anime' : 'series');
                    }

                    if (originalType === 'member') { 
                        populateMemberCard(cardElement, itemData);
                    } else { 
                        populateProjectCard(cardElement, itemData, itemSpecificType);
                    }
                    if (parent) parent.scrollTop = scrollTop;
                });
                return true; 
            }
            return false; 
        }
        
        function updateAffectedMembersDisplayDOM(memberIdsSet) { if (!memberIdsSet || memberIdsSet.size === 0) return; memberIdsSet.forEach(memberId => { const memberData = data.members.find(m => m.id === memberId); if (memberData) updateCardInDOM('member', memberId, memberData); }); } 

        function populateMemberCard(card, member) {
            const avatarImg = card.querySelector('.member-avatar');
            avatarImg.src = member.avatarUrl || `https://placehold.co/60x60/718096/e5e7eb?text=${member.name.charAt(0)}`;
            avatarImg.alt = member.name;
            avatarImg.onclick = () => showImagePreview(avatarImg.src);

            card.querySelector('.member-info h3').textContent = member.name;
            card.querySelector('.member-roles').innerHTML = (member.roles || []).map(role => `<span class="role-badge ${role}">${roleToArabic(role)}</span>`).join('');
            
            const totalEps = (member.projectTranslatedEpisodes||0)+(member.projectEditedEpisodes||0)+(member.projectTimedEpisodes||0)+(member.projectSubtitledEpisodes||0);
            const remaining = (member.totalFee || 0) - (member.amountReceived || 0);

            card.querySelector('.stat-value.episodes').textContent = totalEps;
            const duesEl = card.querySelector('.stat-value.dues');
            duesEl.textContent = formatMoney(remaining);
            duesEl.className = `stat-value dues ${getMoneyClass(remaining)}`;
            card.querySelector('.stat-value.last-activity').textContent = member.lastDelivery ? formatDate(member.lastDelivery) : 'غير معروف';
            
            const socialLinks = card.querySelector('.social-links');
            socialLinks.innerHTML = '';
            const addSocial = (handle, urlPrefix, iconClass, titleText, clickFn) => {
                if (handle) {
                    const url = handle.startsWith('@') ? `${urlPrefix}${handle.substring(1)}` : (isValidUrl(handle) ? handle : '#');
                    const effectiveTitle = titleText; 
                    socialLinks.innerHTML += clickFn ?
                        `<a href="#" onclick="${clickFn}" title="${effectiveTitle}"><i class="fab ${iconClass}"></i></a>` :
                        `<a href="${url}" target="_blank" title="${effectiveTitle}"><i class="fab ${iconClass}"></i></a>`;
                }
            };
            addSocial(member.twitterHandle, 'https://x.com/', 'fa-twitter', `X (Twitter): ${member.twitterHandle || ''}`);
            if (member.discordHandle) {
                if (isValidUrl(member.discordHandle)) {
                    addSocial(member.discordHandle, '', 'fa-discord', `Discord: ${member.discordHandle}`);
                } else {
                    const discordHandleDisplay = member.discordHandle;
                    const discordHandleForJs = member.discordHandle.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    const discordCopyFn = `event.preventDefault(); navigator.clipboard.writeText('${discordHandleForJs}').then(() => showAlert('تم نسخ: ${discordHandleForJs}', 'success', 2000)).catch(err => showAlert('فشل النسخ.', 'danger')); return false;`;
                    addSocial(discordHandleDisplay, '#', 'fa-discord', `Discord: ${discordHandleDisplay} (اضغط للنسخ)`, discordCopyFn);
                }
            }
            addSocial(member.telegramHandle, 'https://t.me/', 'fa-telegram-plane', `Telegram: ${member.telegramHandle || ''}`);
            if (member.blog && isValidUrl(member.blog)) socialLinks.innerHTML += `<a href="${member.blog}" target="_blank" title="Blog/Website"><i class="fas fa-globe"></i></a>`;
            if (socialLinks.innerHTML === '') socialLinks.innerHTML = '<span class="text-muted text-sm">-</span>';


            card.querySelector('.edit-btn').onclick = () => showEntityModal('member', member.id);
            card.querySelector('.view-details-btn').onclick = () => showMemberDetailsModal(member.id);
            
            const checkbox = card.querySelector('.member-checkbox');
            checkbox.onchange = () => toggleItemSelection('members', member.id);
            checkbox.checked = selectedItems.members.has(member.id);
        }
        
        function populateProjectCard(card, project, type) { 
            const config = PROJECT_CONFIG[type]; 
            if (!config) return;
            card.dataset.type = type;

            const checkbox = card.querySelector('.project-card-checkbox');
            const deleteBtn = card.querySelector('.project-card-delete-btn');
            
            if (type === 'archive') {
                if(checkbox) checkbox.style.display = 'none';
                if(deleteBtn) deleteBtn.style.display = 'none';
            } else {
                if(checkbox) {
                    checkbox.style.display = 'block';
                    checkbox.onchange = () => toggleItemSelection(type, project.id);
                    checkbox.checked = selectedItems[type]?.has(project.id) || false;
                }
                if(deleteBtn) {
                    deleteBtn.style.display = '';
                    const actualProjectType = data.anime.some(a => a.id === project.id) ? 'anime' : 'series';
                    deleteBtn.onclick = (e) => { e.stopPropagation(); directDeleteProject(project.id, actualProjectType, project.name); };
                }
            }
            
            const posterUrl = project[config.posterProperty] || 'https://placehold.co/90x135/242424/b0b0b0?text=N/A';
            const posterImg = card.querySelector('.project-poster');
            posterImg.src = posterUrl; 
            posterImg.alt = project.name;
            posterImg.onclick = () => showImagePreview(posterUrl);
            
            const typeBadge = card.querySelector('.project-type-badge');
            const typeText = type === 'anime' ? (project.animeType || 'أنمي') : 'مسلسل';
            typeBadge.textContent = typeText;
            typeBadge.style.cursor = 'pointer';
            typeBadge.onclick = () => quickSearch(typeText);
            
            const titleElement = card.querySelector('.project-title');
            const projectUrl = project[config.externalLinkProperty];

            if (projectUrl && isValidUrl(projectUrl)) {
                titleElement.innerHTML = `<a href="${projectUrl}" target="_blank" rel="noopener noreferrer">${project.name}</a>`;
            } else {
                titleElement.textContent = project.name;
            }

            let metaHtml = '';
            const addMeta = (icon, value, searchTerm = null) => { 
                if(value) {
                    const cleanVal = String(value).split('T')[0];
                    const term = searchTerm || cleanVal; 
                    metaHtml += `<span class="meta-item" style="cursor: pointer;" onclick="quickSearch('${String(term).replace(/'/g, "\\'")}')"><i class="fas fa-${icon}"></i> <span class="meta-clickable">${cleanVal}</span></span>`; 
                }
            };
            
            const yearValue = project[config.yearProperty] ? String(project[config.yearProperty]).split('-')[0] : null;
            addMeta('calendar', formatDate(project[config.yearProperty]), yearValue);
            addMeta('star', project[config.ratingProperty]);
            const durationMins = getDurationInMinutes(project, type);
            if (durationMins > 0) addMeta('clock', `${durationMins} دقيقة`, String(durationMins));
            
            if (type === 'anime' && project.studio) {
                addMeta('building', project.studio);
            } else if (type === 'series' && project.seriesNetwork) {
                addMeta('tv', project.seriesNetwork);
            }
            
            card.querySelector('.project-meta').innerHTML = metaHtml;
            
            card.querySelector('.project-genres').innerHTML = (project[config.genreProperty] || [])
                .slice(0, 5)
                .map(g => `<span class="genre-tag" onclick="quickSearch('${String(g).replace(/'/g, "\\'")}')">${g}</span>`)
                .join('');

            const statusWidget = card.querySelector('.project-status-widget');
            const statusBadge = statusWidget.querySelector('.status-badge');
            statusBadge.textContent = project.status;
            statusBadge.style.cursor = 'pointer';
            statusBadge.onclick = () => quickSearch(project.status);
            
            const statusClass = {'جارٍ':'ongoing', 'مكتمل':'completed', 'متوقف':'stopped', 'قريباً':'upcoming'}[project.status] || 'default';
            const statusColors = {'ongoing':'#10b981', 'completed':'#3b82f6', 'stopped':'#ef4444', 'upcoming':'#f59e0b'};
            statusBadge.style.backgroundColor = `rgba(${parseInt(statusColors[statusClass].slice(1,3),16)}, ${parseInt(statusColors[statusClass].slice(3,5),16)}, ${parseInt(statusColors[statusClass].slice(5,7),16)}, 0.15)`;
            statusBadge.style.color = statusColors[statusClass];

            const percent = project.totalEpisodes > 0 ? ((project.completedEpisodes / project.totalEpisodes) * 100) : 0;
            statusWidget.querySelector('.circle-progress').style.strokeDasharray = `${percent}, 100`;
            statusWidget.querySelector('.progress-text').innerHTML = `<span style="color:var(--accent-blue);">${project.completedEpisodes||0}</span><span style="color:var(--text-secondary); margin: 0 2px;">/</span><span>${project.totalEpisodes||'?'}</span>`;
            statusWidget.querySelector('.progress-label').textContent = project.status === 'مكتمل' && project.completionDate ? `أكمل: ${formatDate(project.completionDate)}` : `${percent.toFixed(0)}% مكتمل`;
            
            const epControls = statusWidget.querySelector('.episode-controls');
            epControls.innerHTML = '';
            if (project.status !== 'مكتمل' && type !== 'archive') {
                const decreaseBtn = document.createElement('button');
                decreaseBtn.className = 'episode-control-btn'; 
                decreaseBtn.innerHTML = '<i class="fas fa-minus"></i>';
                decreaseBtn.disabled = (project.completedEpisodes || 0) <= 0;
                decreaseBtn.onclick = (e) => { 
                    e.stopPropagation(); 
                    const actualType = data.anime.some(a => a.id === project.id) ? 'anime' : 'series';
                    updateProjectEpisodes(actualType, project.id, -1); 
                };
                
                const increaseBtn = document.createElement('button');
                increaseBtn.className = 'episode-control-btn'; 
                increaseBtn.innerHTML = '<i class="fas fa-plus"></i>';
                increaseBtn.disabled = project.totalEpisodes > 0 && (project.completedEpisodes || 0) >= project.totalEpisodes;
                increaseBtn.onclick = (e) => { 
                    e.stopPropagation(); 
                    const actualType = data.anime.some(a => a.id === project.id) ? 'anime' : 'series';
                    updateProjectEpisodes(actualType, project.id, 1); 
                };

                epControls.appendChild(decreaseBtn);
                epControls.appendChild(increaseBtn);
            }
            
            const actionsContainer = card.querySelector('.project-actions-buttons');
            actionsContainer.innerHTML = '';
            const createAction = (text, icon, clickHandler, customClasses = "") => {
                const btn = document.createElement('button');
                btn.className = `action-btn ${customClasses}`;
                btn.innerHTML = `<i class="fas fa-${icon}"></i> ${text}`;
                btn.onclick = clickHandler;
                return btn;
            };

            const fragment = document.createDocumentFragment();

            const actualProjectType = data.anime.some(a => a.id === project.id) ? 'anime' : 'series';

            fragment.appendChild(createAction('تعديل', 'edit', () => showEntityModal(actualProjectType, project.id)));
            fragment.appendChild(createAction('تفاصيل', 'info-circle', () => showProjectDetailsModal(project.id, actualProjectType)));
            fragment.appendChild(createAction('التكلفة', 'calculator', (e) => { 
                e.stopPropagation(); 
                toggleProjectCostPopup(project.id, actualProjectType, card); 
            }));

            if (type === 'archive' || project.status === 'مكتمل') {
                fragment.appendChild(createAction('فريق العمل', 'users', () => showProjectTeamModal(project.id, actualProjectType)));
                fragment.appendChild(createAction('ملاحظات', 'sticky-note', () => showProjectNotesModal(project.id, actualProjectType)));
                fragment.appendChild(createAction('الخام', 'link', () => openRawLink(project.rawUrl)));
            } else {
                fragment.appendChild(createAction('فريق العمل', 'users', () => showProjectTeamModal(project.id, actualProjectType)));
                fragment.appendChild(createAction('ملاحظات', 'sticky-note', () => showProjectNotesModal(project.id, actualProjectType)));
                fragment.appendChild(createAction('الخام', 'link', () => openRawLink(project.rawUrl)));
            }
            actionsContainer.appendChild(fragment);
        }

        async function updateProjectEpisodes(projectType, projectId, change) {
            let project = [...data.anime, ...data.series].find(p => p.id === projectId);
            if (!project) return;
            const actualType = data.anime.some(a => a.id === projectId) ? 'anime' : 'series';
            
            const currentCompleted = project.completedEpisodes || 0;
            const newCompleted = currentCompleted + change;
            const totalEpisodes = project.totalEpisodes || 0;
            if (newCompleted < 0 || (totalEpisodes > 0 && newCompleted > totalEpisodes)) return;

            const projectBefore = JSON.parse(JSON.stringify(project));
            pushToUndoStack('UPDATE_EPISODES', { type: actualType, project: projectBefore }, `'${project.name}'`);
            
            project.completedEpisodes = newCompleted;
            project.totalCost = (project.completedEpisodes * (project.translationPrice || 0)) + (project.translationBonus || 0) + 
                               (project.completedEpisodes * (project.editingPrice || 0)) + (project.editingBonus || 0) + 
                               (project.completedEpisodes * (project.timerPrice || 0)) + (project.timerBonus || 0) + 
                               (project.completedEpisodes * (project.subtitlerPrice || 0)) + (project.subtitlerBonus || 0);
            
            const affectedMemberIds = new Set([project.translatorId, project.editorId, project.timerId, project.subtitlerId].filter(Boolean));
            
            const costDelta = ((project.translationPrice || 0) + (project.editingPrice || 0) + (project.timerPrice || 0) + (project.subtitlerPrice || 0)) * change;
            const activityDetails = {
                type: 'EPISODE_PROGRESS', projectId: project.id, projectType: actualType,
                change: change, episodeNumber: newCompleted, costChange: costDelta,
                team: {
                    translator: { id: project.translatorId, price: project.translationPrice || 0 },
                    editor: { id: project.editorId, price: project.editingPrice || 0 },
                    timer: { id: project.timerId, price: project.timerPrice || 0 },
                    subtitler: { id: project.subtitlerId, price: project.subtitlerPrice || 0 },
                }
            };
            
            logRecentActivity(`تحديث حلقات مشروع (${actualType}) ${project.name}: ${change > 0 ? 'زيادة' : 'نقص'} حلقة (${currentCompleted} ← ${newCompleted})`, activityDetails);

            unsavedChanges = true; 
            recalculateSpecificMembersData(affectedMemberIds);
            
            const success = await saveData();
            if (success) { 
                updateCardInDOM(actualType, projectId, project); 
                updateAffectedMembersDisplayDOM(affectedMemberIds); 
                updateDashboard(); 
                requestAnimationFrame(() => showAlert(`تم تحديث الحلقة بنجاح (${newCompleted})`, 'success', 1500)); 
            } else { 
                unsavedChanges = true; 
                undoStack.pop();
                updateUndoButtonState();
            }
        }

        function updateMemberDropdowns() {
            const populate = (sel, role) => {
                if (!sel) return;
                const currentVal = sel.value;
                sel.innerHTML = '<option value="">اختر...</option>';
                data.members.filter(m => (m.roles || []).includes(role)).forEach(m => {
                    sel.innerHTML += `<option value="${m.id}">${m.name}</option>`;
                });
                if (Array.from(sel.options).some(o => o.value === currentVal)) {
                     sel.value = currentVal;
                }
            };
            document.querySelectorAll('#projectTranslator, #projectEditor, #projectTimer, #projectSubtitler').forEach(select => {
                if (select.id === 'projectTranslator') populate(select, 'translator');
                if (select.id === 'projectEditor') populate(select, 'editor');
                if (select.id === 'projectTimer') populate(select, 'timer');
                if (select.id === 'projectSubtitler') populate(select, 'subtitler');
            });
        }
        
        function showEntityModal(type, entityId = null) {
            requestAnimationFrame(() => {
                const formContainer = getEl('formContentContainer');
                formContainer.innerHTML = '';
                
                setVal('entityId', entityId || '');
                setVal('entityType', type);

                if (type === 'member') {
                    setText('entityModalTitle', entityId ? 'تعديل بيانات العضو' : 'إضافة عضو جديد');
                    
                    const template = getEl('memberFormTemplate').content.cloneNode(true);
                    formContainer.appendChild(template);
                    
                    if (entityId) {
                        const member = data.members.find(m => m.id === entityId);
                        if (!member) { showAlert('العضو غير موجود!', 'danger'); return; }
                        setVal('member-form-name', member.name);
                        setVal('member-form-avatarUrl', member.avatarUrl || '');
                        (member.roles || []).forEach(role => setChecked(`member-form-role-${role}`, true));
                        setVal('member-form-amountReceived', member.amountReceived || 0);
                        setVal('member-form-paymentMethod', member.paymentMethod || '');
                        setVal('member-form-twitterHandle', member.twitterHandle || '');
                        setVal('member-form-discordHandle', member.discordHandle || '');
                        setVal('member-form-telegramHandle', member.telegramHandle || '');
                        setVal('member-form-blog', member.blog || '');
                        setVal('member-form-notes', member.notes || '');
                    }
                } else {
                    const projectConfig = PROJECT_CONFIG[type];
                    if (!projectConfig) return;

                    setText('entityModalTitle', entityId ? projectConfig.modalTitleEdit : projectConfig.modalTitleAdd);
                    
                    const projectFormHtml = `
                        <div class="form-group">
                            <label for="entityName">${projectConfig.nameLabel} *</label>
                            <input type="text" class="form-control" id="entityName" required>
                        </div>
                        
                        <div id="malFieldsContainer" class="${type === 'anime' ? '' : 'hidden'}">
                             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group"> <label for="projectMalId">معرف MAL</label> <input type="text" class="form-control" id="projectMalId" placeholder="مثال: 5114"> </div>
                                <div class="form-group"> <label for="projectUrl">رابط MAL</label> <input type="url" class="form-control" id="projectUrl" placeholder="https://myanimelist.net/anime/..."> </div>
                            </div>
                            <button type="button" class="btn btn-info btn-sm mb-10" id="fetchMalDataBtn" onclick="fetchExternalData('anime')"><i class="fas fa-sync-alt"></i> جلب بيانات من MAL</button>
                            <span id="malFetchLoader" class="ai-loading-indicator hidden">جاري جلب البيانات...</span>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div class="form-group"> <label for="projectAnimeType">نوع الأنمي</label> <input type="text" class="form-control" id="projectAnimeType"> </div>
                                <div class="form-group"> <label for="projectStudio">الاستوديو</label> <input type="text" class="form-control" id="projectStudio"> </div>
                                <div class="form-group"> <label for="projectSource">مصدر الاقتباس</label> <input type="text" class="form-control" id="projectSource"> </div>
                                <div class="form-group"> <label for="projectPremiered">تاريخ أول عرض</label> <input type="text" class="form-control" id="projectPremiered"> </div>
                                <div class="form-group"> <label for="projectDuration">مدة الحلقة</label> <input type="text" class="form-control" id="projectDuration"> </div>
                                <div class="form-group"> <label for="projectRating">التصنيف العمري</label> <input type="text" class="form-control" id="projectRating"> </div>
                                <div class="form-group"> <label for="projectScore">التقييم (Score)</label> <input type="text" class="form-control" id="projectScore"> </div>
                            </div>
                            <div class="form-group"> <label for="projectGenres">التصنيفات (Genres)</label> <input type="text" class="form-control" id="projectGenres" placeholder="مثال: Action, Comedy"> </div>
                            <div class="form-group"> <label for="projectThemes">المواضيع (Themes)</label> <input type="text" class="form-control" id="projectThemes" placeholder="مثال: Super Power, Mecha"> </div>
                            <div class="form-group"> <label for="projectImageUrl">رابط الصورة</label> <input type="url" class="form-control" id="projectImageUrl"> </div>
                            <div class="form-group"> <label for="projectSynopsis">نبذة MAL</label> <textarea class="form-control" id="projectSynopsis" rows="3"></textarea> </div>
                            <div class="form-group"> <label for="anime-projectNotes">ملاحظات داخلية</label> <textarea class="form-control" id="anime-projectNotes" rows="2" placeholder="ملاحظات لا تظهر إلا للفريق..."></textarea> </div>
                        </div>
                        <div id="tvdbFieldsContainer" class="${type === 'series' ? '' : 'hidden'}">
                            <div class="form-group"> <label for="projectSeriesNameSearch">اسم المسلسل للبحث في TMDB</label> <input type="text" class="form-control" id="projectSeriesNameSearch" placeholder="أدخل اسم المسلسل هنا للبحث..."> </div>
                            <button type="button" class="btn btn-info btn-sm mb-10" id="fetchTmdbDataBtn" onclick="fetchExternalData('series')"><i class="fas fa-sync-alt"></i> جلب بيانات من TMDB</button>
                            <span id="tmdbFetchLoader" class="ai-loading-indicator hidden">جاري جلب البيانات...</span>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div class="form-group"> <label for="projectTmdbUrl">رابط TMDB</label> <input type="url" class="form-control" id="projectTmdbUrl" placeholder="https://www.themoviedb.org/tv/..."> </div>
                                <div class="form-group"> <label for="projectSeriesYear">سنة أول عرض</label> <input type="text" class="form-control" id="projectSeriesYear" placeholder="مثال: 2023"> </div>
                                <div class="form-group"> <label for="projectSeriesNetwork">الشبكة</label> <input type="text" class="form-control" id="projectSeriesNetwork" placeholder="مثال: Netflix, HBO"> </div>
                                <div class="form-group"> <label for="projectSeriesStatusTMDB">حالة المسلسل (TMDB)</label> <input type="text" class="form-control" id="projectSeriesStatusTMDB" placeholder="مثال: Continuing, Ended"> </div>
                                <div class="form-group"> <label for="projectSeriesEpisodeRunTime">مدة الحلقة (دقائق)</label> <input type="text" class="form-control" id="projectSeriesEpisodeRunTime" placeholder="مثال: 45, 22-25"> </div>
                                <div class="form-group"> <label for="projectSeriesGenres">التصنيفات (بالانجليزية)</label> <input type="text" class="form-control" id="projectSeriesGenres"> </div>
                                <div class="form-group"> <label for="projectSeriesVoteAverage">متوسط التقييم (TMDB)</label> <input type="text" class="form-control" id="projectSeriesVoteAverage"> </div>
                                <div class="form-group"> <label for="projectSeriesPosterUrl">رابط البوستر</label> <input type="url" class="form-control" id="projectSeriesPosterUrl"> </div>
                                <div class="form-group"> <label for="projectSeriesOriginCountry">بلد المنتج</label> <input type="text" class="form-control" id="projectSeriesOriginCountry"> </div>
                                <div class="form-group"> <label for="projectSeriesOriginalLanguage">اللغة الأصلية</label> <input type="text" class="form-control" id="projectSeriesOriginalLanguage"> </div>
                            </div>
                            <div class="form-group"> <label for="projectSeriesOverview">نبذة قصيرة</label> <textarea class="form-control" id="projectSeriesOverview" rows="2"></textarea> </div>
                            <div class="form-group"> <label for="series-projectNotes">ملاحظات داخلية</label> <textarea class="form-control" id="series-projectNotes" rows="2" placeholder="ملاحظات لا تظهر إلا للفريق..."></textarea> </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group"><label for="projectStatus">حالة المشروع (في فريقك) *</label><select class="form-control" id="projectStatus" required><option value="">اختر الحالة</option><option value="مكتمل">مكتمل</option><option value="جارٍ">جارٍ</option><option value="قريباً">قريباً</option><option value="متوقف">متوقف</option></select></div>
                            <div class="form-group"><label for="totalEpisodes">عدد الحلقات الكلي</label><input type="number" class="form-control" id="totalEpisodes" value="0" min="0"></div>
                        </div>
                        <div class="form-group"><label for="completedEpisodesProject">الحلقات المنتهية (في المشروع)</label><input type="number" class="form-control" id="completedEpisodesProject" value="0" min="0"></div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div class="form-group"> <label for="projectTranslator">المترجم</label> <select class="form-control" id="projectTranslator"><option value="">اختر المترجم</option></select> <label for="translationPrice" class="mt-10">سعر الترجمة/حلقة</label> <input type="number" class="form-control" id="translationPrice" value="0" min="0" step="0.5"> <label for="translationBonus" class="mt-10">أجرة إضافية/مخصومة للمترجم (إجمالي)</label> <input type="number" class="form-control" id="translationBonus" value="0" step="0.01" placeholder="موجب للإضافة، سالب للخصم"> </div>
                            <div class="form-group"> <label for="projectEditor">المدقق</label> <select class="form-control" id="projectEditor"><option value="">اختر المدقق</option></select> <label for="editingPrice" class="mt-10">سعر التدقيق/حلقة</label> <input type="number" class="form-control" id="editingPrice" value="0" min="0" step="0.5"> <label for="editingBonus" class="mt-10">أجرة إضافية/مخصومة للمدقق (إجمالي)</label> <input type="number" class="form-control" id="editingBonus" value="0" step="0.01" placeholder="موجب للإضافة، سالب للخصم"> </div>
                            <div class="form-group"> <label for="projectTimer">المحاكي</label> <select class="form-control" id="projectTimer"><option value="">اختر المحاكي</option></select> <label for="timerPrice" class="mt-10">سعر المحاكاة/حلقة</label> <input type="number" class="form-control" id="timerPrice" value="0" min="0" step="0.5"> <label for="timerBonus" class="mt-10">أجرة إضافية/مخصومة للمحاكي (إجمالي)</label> <input type="number" class="form-control" id="timerBonus" value="0" step="0.01" placeholder="موجب للإضافة، سالب للخصم"> </div>
                            <div class="form-group"> <label for="projectSubtitler">الموقت</label> <select class="form-control" id="projectSubtitler"><option value="">اختر الموقت</option></select> <label for="subtitlerPrice" class="mt-10">سعر التوقيت/حلقة</label> <input type="number" class="form-control" id="subtitlerPrice" value="0" min="0" step="0.5"> <label for="subtitlerBonus" class="mt-10">أجرة إضافية/مخصومة للموقت (إجمالي)</label> <input type="number" class="form-control" id="subtitlerBonus" value="0" step="0.01" placeholder="موجب للإضافة، سالب للخصم"> </div>
                        </div>
                        <div class="form-group"><label for="rawUrl">رابط الملفات الخام</label><input type="url" class="form-control" id="rawUrl" placeholder="https://..."></div>
                    `;
                    formContainer.innerHTML = projectFormHtml;
                    updateMemberDropdowns();
                    
                    if (entityId) {
                        const project = data[type].find(p => p.id === entityId);
                        if (!project) { showAlert('المشروع غير موجود!', 'danger'); return; }
                        setVal('entityName', project.name);

                        Object.keys(projectConfig.dataProperties).forEach(propKey => { let val = Array.isArray(project[propKey]) ? project[propKey].join(', ') : (project[propKey] || ''); setVal(projectConfig.dataProperties[propKey], val); });
                        
                        if (type === 'anime') {
                            setVal('projectMalId', project.malId || '');
                            setVal('anime-projectNotes', project.notes || '');
                        } else if (type === 'series') {
                            setVal('projectSeriesNameSearch', project.name);
                            setVal('series-projectNotes', project.notes || '');
                        }
                        
                        projectConfig.formFields.forEach(fieldId => {
                            let valueToSet;
                            switch (fieldId) {
                                case 'projectStatus': valueToSet = project.status; break;
                                case 'completedEpisodesProject': valueToSet = project.completedEpisodes; break;
                                case 'projectTranslator': valueToSet = project.translatorId; break;
                                case 'projectEditor': valueToSet = project.editorId; break;
                                case 'projectTimer': valueToSet = project.timerId; break;
                                case 'projectSubtitler': valueToSet = project.subtitlerId; break;
                                default: const propName = fieldId.replace(/^project/, '').replace(/^[A-Z]/, c => c.toLowerCase()); valueToSet = project[propName] !== undefined ? project[propName] : project[fieldId];
                            }
                            setVal(fieldId, valueToSet !== undefined && valueToSet !== null ? String(valueToSet) : (projectConfig.numberFields.includes(fieldId) ? 0 : ''));
                        });
                    }
                }
                setStyle('entityModal', 'display', 'block');
            });
        }
        
        async function saveEntity() {
            const type = getVal('entityType');
            const entityId = getVal('entityId');

            if (type === 'member') {
                await saveMember(entityId);
            } else if (PROJECT_CONFIG[type]) {
                await saveProject(type, entityId);
            } else {
                showAlert('نوع غير معروف للحفظ!', 'danger');
            }
        }

        async function saveMember(memberId) {
            const name = getVal('member-form-name').trim();
            const avatarUrl = getVal('member-form-avatarUrl');
            const roles = [];
            ['translator', 'editor', 'timer', 'subtitler'].forEach(role => {
                if (isChecked(`member-form-role-${role}`)) roles.push(role);
            });
            const amountReceived = parseFloat(getVal('member-form-amountReceived')) || 0;
            const paymentMethod = getVal('member-form-paymentMethod');
            const twitterHandle = getVal('member-form-twitterHandle');
            const discordHandle = getVal('member-form-discordHandle');
            const telegramHandle = getVal('member-form-telegramHandle');
            const blog = getVal('member-form-blog');
            const notes = getVal('member-form-notes');

            if (!name || name.length < 2) {
                showAlert('يجب إدخال اسم صحيح (حرفين على الأقل).', 'danger'); return;
            }
            if (roles.length === 0) {
                showAlert('يجب اختيار دور واحد على الأقل للعضو.', 'danger'); return;
            }
            if (avatarUrl && !isValidUrl(avatarUrl)) {
                showAlert('رابط صورة العضو غير صالح.', 'danger'); return;
            }
            if (blog && !isValidUrl(blog)) {
                showAlert('رابط المدونة/الموقع غير صالح.', 'danger'); return;
            }

            const memberData = { name, avatarUrl, roles, amountReceived, paymentMethod, twitterHandle, discordHandle, telegramHandle, blog, notes };
            const action = memberId ? 'تعديل' : 'إضافة';
            let savedEntityData;

            if (memberId) {
                const index = data.members.findIndex(m => m.id === memberId);
                if (index === -1) { showAlert('خطأ: لم يتم العثور على العضو المراد تعديله.', 'danger'); return; }
                const memberBefore = JSON.parse(JSON.stringify(data.members[index]));
                pushToUndoStack('UPDATE_MEMBER', { member: memberBefore }, `'${memberBefore.name}'`);
                data.members[index] = { ...data.members[index], ...memberData };
                savedEntityData = data.members[index];
            } else {
                savedEntityData = {
                    ...memberData,
                    id: generateUniqueId(),
                    createdDate: new Date().toISOString(),
                    totalFee: 0,
                    lastDelivery: null,
                    projectTranslatedEpisodes: 0,
                    projectEditedEpisodes: 0,
                    projectTimedEpisodes: 0,
                    projectSubtitledEpisodes: 0,
                };
                data.members.push(savedEntityData);
                pushToUndoStack('ADD_MEMBER', { id: savedEntityData.id }, `'${savedEntityData.name}'`);
            }
            
            recalculateSpecificMembersData(new Set([savedEntityData.id]));
            logRecentActivity(`${action} عضو: ${savedEntityData.name}`);
            unsavedChanges = true;

            const saveSuccess = await saveData();
            if (saveSuccess) {
                showAlert(`تم ${action} بيانات العضو بنجاح.`, 'success');
                if (!updateCardInDOM('member', savedEntityData.id, savedEntityData)) {
                    sortAndLoadData('members', currentSort.members);
                }
                updateMemberDropdowns();
                updateDashboard();
                closeModal('entityModal');
            } else {
                showAlert('فشل في حفظ البيانات. يرجى المحاولة مرة أخرى.', 'danger');
                unsavedChanges = true;
                undoStack.pop();
                updateUndoButtonState();
            }
        }
        
        async function saveProject(type, projectId) {
            const projectConfig = PROJECT_CONFIG[type];
            const name = getVal('entityName').trim();
            if (!name) { showAlert('يجب إدخال اسم للمشروع.', 'danger'); return; }
            if (!getVal('projectStatus')) { showAlert('يجب اختيار حالة للمشروع.', 'danger'); return; }

            const completedEpisodes = parseInt(getVal('completedEpisodesProject'), 10) || 0;
            const totalEpisodes = parseInt(getVal('totalEpisodes'), 10) || 0;
            if (totalEpisodes > 0 && completedEpisodes > totalEpisodes) showAlert('عدد الحلقات المنجزة لا يمكن أن يكون أكبر من العدد الكلي.', 'warning');
            
            const projectData = { 
                name, 
                status: getVal('projectStatus'), 
                totalEpisodes, 
                completedEpisodes,
                notes: (type === 'anime' ? getVal('anime-projectNotes') : getVal('series-projectNotes')), 
                translatorId: getVal('projectTranslator') || null, 
                editorId: getVal('projectEditor') || null, 
                timerId: getVal('projectTimer') || null, 
                subtitlerId: getVal('projectSubtitler') || null,
                translationPrice: parseFloat(getVal('translationPrice'))||0, editingPrice: parseFloat(getVal('editingPrice'))||0, timerPrice: parseFloat(getVal('timerPrice'))||0, subtitlerPrice: parseFloat(getVal('subtitlerPrice'))||0,
                translationBonus: parseFloat(getVal('translationBonus'))||0, editingBonus: parseFloat(getVal('editingBonus'))||0, timerBonus: parseFloat(getVal('timerBonus'))||0, subtitlerBonus: parseFloat(getVal('subtitlerBonus'))||0,
                rawUrl: getVal('rawUrl'),
            };
            
            if (type === 'anime') {
                projectData.synopsis = getVal('projectSynopsis');
            } else if (type === 'series') {
                projectData.seriesOverview = getVal('projectSeriesOverview');
            }

            Object.keys(projectConfig.dataProperties).forEach(propKey => {
                if (propKey === 'seriesOverview' || propKey === 'synopsis') return;

                const formFieldId = projectConfig.dataProperties[propKey];
                if (type === 'anime' && formFieldId === 'projectNotes') return;

                let val = getVal(formFieldId);
                if (['genres', 'themes', 'seriesGenres', 'seriesOriginCountry'].some(p => p === propKey)) {
                    val = val ? val.split(',').map(s => s.trim()).filter(s => s) : [];
                } else if (['score', 'seriesVoteAverage'].some(p => p === propKey)) {
                    val = parseFloat(val) || null;
                }
                projectData[propKey] = val || (Array.isArray([]) ? [] : null);
            });

            if (type === 'anime') projectData.malId = getVal('projectMalId') || null;
            projectData.totalCost = (projectData.completedEpisodes * projectData.translationPrice) + projectData.translationBonus + (projectData.completedEpisodes * projectData.editingPrice) + projectData.editingBonus + (projectData.completedEpisodes * projectData.timerPrice) + projectData.timerBonus + (projectData.completedEpisodes * projectData.subtitlerPrice) + projectData.subtitlerBonus;

            const action = projectId ? 'تعديل' : 'إضافة';
            let savedEntityData;
            const affectedMemberIds = new Set();
            let oldProjectAssignments = null;

            if (projectId) {
                const index = data[type].findIndex(p => p.id === projectId);
                if (index === -1) { showAlert('خطأ: لم يتم العثور على المشروع.', 'danger'); return; }
                const projectBefore = JSON.parse(JSON.stringify(data[type][index]));
                pushToUndoStack('UPDATE_PROJECT', { project: { type: type, data: projectBefore } }, `'${projectBefore.name}'`);
                const existingProject = data[type][index];
                oldProjectAssignments = { translatorId: existingProject.translatorId, editorId: existingProject.editorId, timerId: existingProject.timerId, subtitlerId: existingProject.subtitlerId };
                Object.values(oldProjectAssignments).forEach(id => { if (id) affectedMemberIds.add(id); });
                data[type][index] = { ...existingProject, ...projectData };
                savedEntityData = data[type][index];
                if (projectData.status === 'مكتمل' && !savedEntityData.completionDate) savedEntityData.completionDate = new Date().toISOString();
                else if (projectData.status !== 'مكتمل') savedEntityData.completionDate = null;
            } else {
                savedEntityData = { ...projectData, id: generateUniqueId(), createdDate: new Date().toISOString() };
                if (projectData.status === 'مكتمل') savedEntityData.completionDate = new Date().toISOString();
                data[type].push(savedEntityData);
                pushToUndoStack('ADD_PROJECT', { type: type, id: savedEntityData.id }, `'${savedEntityData.name}'`);
            }
            Object.values({ translatorId: savedEntityData.translatorId, editorId: savedEntityData.editorId, timerId: savedEntityData.timerId, subtitlerId: savedEntityData.subtitlerId }).forEach(id => { if (id) affectedMemberIds.add(id); });
            recalculateSpecificMembersData(affectedMemberIds);
            updateMemberFromProjectAssignment(oldProjectAssignments, savedEntityData);

            logRecentActivity(`${action} مشروع (${type}): ${savedEntityData.name}`);
            unsavedChanges = true;

            const saveSuccess = await saveData();
            if (saveSuccess) {
                showAlert(`تم ${action} بيانات المشروع بنجاح.`, 'success');
                if (!updateCardInDOM(type, savedEntityData.id, savedEntityData)) {
                    sortAndLoadData(type, currentSort[type]);
                }
                updateAffectedMembersDisplayDOM(affectedMemberIds);
                updateDashboard();
                closeModal('entityModal');
            } else {
                showAlert('فشل في حفظ البيانات. يرجى المحاولة مرة أخرى.', 'danger');
                unsavedChanges = true;
                undoStack.pop();
                updateUndoButtonState();
            }
        }


        function showMemberDetailsModal(memberId) {
            requestAnimationFrame(() => {
                const member = data.members.find(m => m.id === memberId); if (!member) { showAlert('لم يتم العثور على العضو!', 'danger'); return; }
                setText('memberDetailsModalTitle', `تفاصيل العضو: ${member.name}`);
                const avatarEl = getEl('memberDetailsAvatar'); avatarEl.src = member.avatarUrl || `https://placehold.co/120x120/718096/e5e7eb?text=${member.name.charAt(0)}`; avatarEl.onclick = () => showImagePreview(avatarEl.src); 
                setText('memberDetailsName', member.name); setHTML('memberDetailsRoles', (member.roles || []).map(role => `<span class="role-badge ${role}">${roleToArabic(role)}</span>`).join(''));
                
                const socialContainer = getEl('memberDetailsSocial'); socialContainer.innerHTML = ''; 
                const addSocialLink = (handle, urlPrefix, icon, titleText, clickFn) => {
                    if (handle) {
                        const url = handle.startsWith('@') ? `${urlPrefix}${handle.substring(1)}` : (isValidUrl(handle) ? handle : '#');
                        socialContainer.innerHTML += clickFn ? 
                            `<a href="#" onclick="${clickFn}" title="${titleText}"><i class="fab ${icon}"></i></a>` : 
                            `<a href="${url}" target="_blank" title="${titleText}"><i class="fab ${icon}"></i></a>`;
                    }
                };
                addSocialLink(member.twitterHandle, 'https://x.com/', 'fa-twitter', `X (Twitter): ${member.twitterHandle || ''}`);
                if (member.discordHandle) {
                    if (isValidUrl(member.discordHandle)) {
                        addSocialLink(member.discordHandle, '', 'fa-discord', `Discord: ${member.discordHandle}`);
                    } else {
                        const discordHandleDisplay = member.discordHandle;
                        const discordHandleForJs = member.discordHandle.replace(/'/g, "\\'").replace(/"/g, '\\"');
                        const discordCopyFn = `event.preventDefault(); navigator.clipboard.writeText('${discordHandleForJs}').then(() => showAlert('تم نسخ: ${discordHandleForJs}', 'success', 2000)).catch(err => showAlert('فشل النسخ.', 'danger')); return false;`;
                        addSocialLink(discordHandleDisplay, '#', 'fa-discord', `Discord: ${discordHandleDisplay} (اضغط للنسخ)`, discordCopyFn);
                    }
                }
                addSocialLink(member.telegramHandle, 'https://t.me/', 'fa-telegram-plane', `Telegram: ${member.telegramHandle || ''}`);
                if (member.blog && isValidUrl(member.blog)) socialContainer.innerHTML += `<a href="${member.blog}" target="_blank" title="Blog/Website"><i class="fas fa-globe"></i></a>`;
                
                if (socialContainer.innerHTML === '') socialContainer.innerHTML = '<p class="text-sm text-muted">لا توجد حسابات تواصل.</p>';
                setText('memberDetailsAmountReceived', formatMoney(member.amountReceived || 0));
                setText('memberDetailsPaymentMethod', member.paymentMethod || 'غير محدد'); setText('memberDetailsNotes', member.notes || 'لا توجد ملاحظات.');
                let projectsHtml = '';
                [...data.anime, ...data.series].forEach(project => {
                    let rolesInProject = [], projectType = data.anime.some(a => a.id === project.id) ? 'anime' : 'series';
                    if (project.translatorId === member.id) rolesInProject.push('مترجم'); if (project.editorId === member.id) rolesInProject.push('مدقق');
                    if (project.timerId === member.id) rolesInProject.push('محاكي'); if (project.subtitlerId === member.id) rolesInProject.push('موقت');
                    if (rolesInProject.length > 0) {
                         projectsHtml += `<div class="member-project-item" onclick="closeModal('memberDetailsModal'); showProjectDetailsModal('${project.id}', '${projectType}')"><strong>${project.name}</strong> (${projectType === 'anime' ? 'أنمي' : 'مسلسل'})<br>الأدوار: ${rolesInProject.join('، ')}<br>الحلقات المنجزة: ${project.completedEpisodes||0}/${project.totalEpisodes||'?'}</div>`;
                    }
                });
                setHTML('memberDetailsProjectsList', projectsHtml || '<p class="text-sm text-muted">لم يعمل هذا العضو على أي مشاريع.</p>');
                setStyle('memberDetailsModal', 'display', 'block');
            });
        }

        function recalculateSpecificMembersData(memberIdsSet) {
            if (!memberIdsSet || memberIdsSet.size === 0) return;
            memberIdsSet.forEach(memberId => {
                const member = data.members.find(m => m.id === memberId); if (!member) return;
                member.projectTranslatedEpisodes=0; member.projectEditedEpisodes=0; member.projectTimedEpisodes=0; member.projectSubtitledEpisodes=0; member.totalFee=0;
                [...data.anime, ...data.series].forEach(p => {
                    const eps = p.status === 'مكتمل' ? (p.totalEpisodes || p.completedEpisodes || 0) : (p.completedEpisodes || 0);
                    if (p.translatorId === member.id) { member.projectTranslatedEpisodes += (p.completedEpisodes||0); member.totalFee += (eps * (p.translationPrice||0)) + (p.translationBonus||0); }
                    if (p.editorId === member.id) { member.projectEditedEpisodes += (p.completedEpisodes||0); member.totalFee += (eps * (p.editingPrice||0)) + (p.editingBonus||0); }
                    if (p.timerId === member.id) { member.projectTimedEpisodes += (p.completedEpisodes||0); member.totalFee += (eps * (p.timerPrice||0)) + (p.timerBonus||0); }
                    if (p.subtitlerId === member.id) { member.projectSubtitledEpisodes += (p.completedEpisodes||0); member.totalFee += (eps * (p.subtitlerPrice||0)) + (p.subtitlerBonus||0); }
                });
                member.remainingAmount = (member.totalFee || 0) - (member.amountReceived || 0);
            });
        }
        function recalculateAllMemberData() { recalculateSpecificMembersData(new Set(data.members.map(m => m.id))); }
        function updateMemberFromProjectAssignment(oldAssignments, newProjectData) {
            const newAssignees = new Set([newProjectData.translatorId, newProjectData.editorId, newProjectData.timerId, newProjectData.subtitlerId].filter(Boolean));
            if (newProjectData.status === 'جارٍ' || newProjectData.status === 'مكتمل') {
                const deliveryDate = newProjectData.completionDate || new Date().toISOString(); 
                newAssignees.forEach(memberId => { const member = data.members.find(m => m.id === memberId); if (member && (!member.lastDelivery || new Date(deliveryDate) > new Date(member.lastDelivery))) member.lastDelivery = deliveryDate; });
            }
        }

        function toggleItemSelection(type, itemId) { 
            const set = selectedItems[type] || new Set(); 
            set.has(itemId) ? set.delete(itemId) : set.add(itemId); 
            selectedItems[type] = set; 
            updateMasterCheckbox(type); 
            updateDeleteButtonText(type); 
        }

        function updateMasterCheckbox(type) { 
            const conf = PROJECT_CONFIG[type]; 
            let masterCbId = conf ? conf.selectAllCheckboxId : (type === 'members' ? 'selectAllMembersCard' : null);
            if (type === 'archive' || !masterCbId) return; 
            const masterCb = getEl(masterCbId); if (!masterCb) return;
            const allItems = currentFilteredAndSortedItems[type]; if (!allItems || allItems.length === 0) { masterCb.checked = false; masterCb.indeterminate = false; return; }
            const visibleSelectedCount = allItems.filter(item => selectedItems[type] && selectedItems[type].has(item.id)).length;
            masterCb.checked = allItems.length > 0 && visibleSelectedCount === allItems.length;
            masterCb.indeterminate = visibleSelectedCount > 0 && visibleSelectedCount < allItems.length;
        }

        function toggleSelectAllCards(type) { 
            const conf = PROJECT_CONFIG[type]; 
            let masterCbId = conf ? conf.selectAllCheckboxId : (type === 'members' ? 'selectAllMembersCard' : null); 
            if (!masterCbId) return;
            const masterCb = getEl(masterCbId), isChecked = masterCb.checked, items = currentFilteredAndSortedItems[type]; 
            if (!selectedItems[type]) selectedItems[type] = new Set();
            items.forEach(item => isChecked ? selectedItems[type].add(item.id) : selectedItems[type].delete(item.id));
            requestAnimationFrame(() => { 
                const gridId = conf ? conf.cardGridId : `${type}CardGrid`; 
                const grid = getEl(gridId); 
                if (grid) { 
                    const cbSelector = type === 'members' ? '.member-checkbox' : '.project-card-checkbox'; 
                    grid.querySelectorAll(type==='members'?'.member-card':'.project-card').forEach(card => { 
                        const cb=card.querySelector(cbSelector); 
                        if (cb && items.some(it=>it.id===card.dataset.id)) cb.checked=isChecked; 
                    }); 
                } 
                masterCb.indeterminate=false; 
                updateDeleteButtonText(type); 
            });
        }

        function updateDeleteButtonText(type) { 
            const count = selectedItems[type] ? selectedItems[type].size : 0;
            const btn = document.querySelector(type === 'members' ? '#members .toolbar .btn-danger' : (type === 'anime' ? '#animeProjectsView .toolbar .btn-danger' : '#seriesProjectsView .toolbar .btn-danger'));
            if (btn) btn.innerHTML = `<i class="fas fa-trash-alt"></i> حذف المحدد ${count > 0 ? `(${count})` : ''}`;
        }

        async function deleteSelected(type) {
            if(!selectedItems[type] || selectedItems[type].size === 0){requestAnimationFrame(() => showAlert('يرجى تحديد عناصر للحذف أولاً.','warning'));return;}
            if(confirm(`هل أنت متأكد من حذف ${selectedItems[type].size} عنصر/عناصر محددة؟`)){
                const idsToDelete = new Set(selectedItems[type]);
                const itemsToDelete = data[type].filter(item => idsToDelete.has(item.id));
                pushToUndoStack(type === 'members' ? 'DELETE_MEMBER' : 'DELETE_PROJECT', { type: type, items: JSON.parse(JSON.stringify(itemsToDelete)) }, `${itemsToDelete.length} عنصر/عناصر من قسم ${type}`);
                
                data[type] = data[type].filter(item => !idsToDelete.has(item.id));
                selectedItems[type].clear();
                updateDeleteButtonText(type);
                
                const conf = PROJECT_CONFIG[type];
                let masterCbId = conf ? conf.selectAllCheckboxId : (type === 'members' ? 'selectAllMembersCard' : null);
                if (masterCbId) { const mCb=getEl(masterCbId); if(mCb){mCb.checked=false;mCb.indeterminate=false;} }
                
                logRecentActivity(`حذف متعدد (${type}): ${itemsToDelete.map(i => i.name).join(', ')}`);
                unsavedChanges = true;

                if(type === 'members'){ const affectedPIds = new Set(); [data.anime, data.series].forEach(pList => pList.forEach(p => { let ch=false; if(idsToDelete.has(p.translatorId)){p.translatorId=null;ch=true;} if(idsToDelete.has(p.editorId)){p.editorId=null;ch=true;} if(idsToDelete.has(p.timerId)){p.timerId=null;ch=true;} if(idsToDelete.has(p.subtitlerId)){p.subtitlerId=null;ch=true;} if(ch)affectedPIds.add(p.id); })); affectedPIds.forEach(pId => { let p=data.anime.find(pr=>pr.id===pId)||data.series.find(pr=>pr.id===pId); if(p){p.totalCost=(p.completedEpisodes*(p.translationPrice||0))+(p.translationBonus||0)+(p.completedEpisodes*(p.editingPrice||0))+(p.editingBonus||0)+(p.completedEpisodes*(p.timerPrice||0))+(p.timerBonus||0)+(p.completedEpisodes*(p.subtitlerPrice||0))+(p.subtitlerBonus||0);const pTypeDOM=data.anime.some(a=>a.id===pId)?'anime':'series';updateCardInDOM(pTypeDOM,pId,p);} }); sortAndLoadData('members', currentSort.members); updateMemberDropdowns(); } 
                else sortAndLoadData(type, currentSort[type]); 
                
                recalculateAllMemberData();
                const success = await saveData();
                if(!success) { unsavedChanges = true; undoStack.pop(); updateUndoButtonState(); }
                
                updateDashboard();
                requestAnimationFrame(() => showAlert(`تم حذف العناصر المحددة بنجاح.`,'success'));
            }
        }
        
        async function directDeleteProject(projectId, projectType, projectName) {
            if (confirm(`هل أنت متأكد من حذف المشروع: "${projectName}"؟`)) {
                const index = data[projectType].findIndex(p => p.id === projectId);
                if (index === -1) {
                    showAlert('لم يتم العثور على المشروع.', 'danger');
                    return;
                }

                const itemToDelete = data[projectType][index];
                pushToUndoStack('DIRECT_DELETE_PROJECT', { type: projectType, item: JSON.parse(JSON.stringify(itemToDelete)) }, `'${projectName}'`);

                data[projectType].splice(index, 1);

                logRecentActivity(`حذف مشروع (${projectType}): ${projectName}`);
                unsavedChanges = true;
                recalculateAllMemberData();
                const success = await saveData();

                if (success) {
                    showAlert(`تم حذف المشروع "${projectName}" بنجاح.`, 'success');
                    const card = document.querySelector(`.project-card[data-id="${projectId}"]`);
                    if(card) card.style.animation = 'fadeOut 0.4s ease forwards';
                    setTimeout(() => { if(card) card.remove(); updateAllDisplays(); }, 400);
                } else {
                    unsavedChanges = true;
                    undoStack.pop();
                    updateUndoButtonState();
                }
            }
        }

        function exportData(destination = 'local') {
            const dataToExport = { ...data, version: data.version, exportDate: new Date().toISOString() };
            const jsonStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            const dateStamp = new Date().toISOString().split('T')[0];
            const fileName = `ReviveSubs_Backup_${dateStamp}.json`;
            a.download = fileName;
            document.body.appendChild(a);
            a.click(); 
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('تم تجهيز ملف التصدير وتنزيله.', 'success');
            logRecentActivity(`تصدير البيانات إلى ${destination === 'cloud' ? 'السحابة (يدوي)' : 'الجهاز'}`);
            
            if (destination === 'cloud') {
                setTimeout(() => showCloudExportGuide(fileName), 500);
            }
        }
        
        function handleLocalImport() {
            if (unsavedChanges && !confirm('لديك تغييرات غير محفوظة. هل أنت متأكد من المتابعة؟ قد تفقد هذه التغييرات.')) {
                return;
            }
            const input = document.createElement('input'); 
            input.type = 'file'; 
            input.accept = '.json,application/json';
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (!confirm('سيؤدي استيراد البيانات إلى الكتابة فوق جميع البيانات الحالية. هل أنت متأكد من رغبتك في المتابعة؟')) return;
                    
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            const defaultStructure = initializeDefaultDataStructure(false);
                            if (imported && Array.isArray(imported.members) && Array.isArray(imported.anime) && Array.isArray(imported.series)) {
                                data = { ...defaultStructure, ...imported }; 
                                data.settings = { ...defaultStructure.settings, ...imported.settings }; 
                                if (!Array.isArray(data.recentActivityLog)) data.recentActivityLog = []; 
                                await saveData(); 
                                unsavedChanges = false; 
                                logRecentActivity(`تم استيراد البيانات من ملف: ${file.name}`); 
                                showAlert('تم استيراد البيانات بنجاح. سيتم إعادة تحميل الصفحة لتطبيق التغييرات.', 'success', 5000);
                                setTimeout(() => window.location.reload(), 2000);
                            } else {
                                showAlert('ملف الاستيراد غير صالح أو لا يطابق البنية المطلوبة.', 'danger');
                            }
                        } catch (error) { 
                            console.error("Error importing data:", error); 
                            showAlert(`خطأ أثناء تحليل ملف الاستيراد: ${error.message}`, 'danger');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function showCloudExportGuide(fileName) {
            const driveUrl = data.settings.headerLinkDriveUrl;
            const content = `
                <p class="text-muted" style="color: var(--accent-green); font-weight: bold;">
                    <strong>تم تنزيل ملف النسخة الاحتياطية (${fileName}) بنجاح إلى جهازك.</strong>
                </p>
                <p>الآن، يرجى رفع هذا الملف يدويًا إلى مجلد الفريق المشترك للحفاظ على أحدث نسخة ومشاركتها مع الجميع.</p>
                <ol style="padding-right: 20px;">
                    <li style="margin-bottom: 10px;">
                        افتح مجلد الفريق على Google Drive.
                        ${driveUrl && driveUrl !== '#' ? `<a href="${driveUrl}" target="_blank" class="btn btn-sm btn-info" style="margin-right: 10px;">فتح المجلد</a>` : '<span class="text-muted">(لم يتم تعيين رابط Drive في الإعدادات)</span>'}
                    </li>
                    <li>اسحب وأفلت الملف الذي تم تنزيله للتو في مجلد Drive.</li>
                    <li>تأكد من حذف النسخ الاحتياطية القديمة إذا لزم الأمر لتجنب الالتباس.</li>
                </ol>
            `;
            showInstructionsModal('دليل التصدير إلى السحابة', content, `<button type="button" class="btn btn-secondary" onclick="closeModal('instructionsModal')">حسنًا</button>`);
        }
        
        function showInstructionsModal(title, bodyHtml, footerHtml) {
            requestAnimationFrame(() => {
                setText('instructionsModalTitle', title);
                setHTML('instructionsModalBody', bodyHtml);
                setHTML('instructionsModalFooter', footerHtml);
                setStyle('instructionsModal', 'display', 'block');
            });
        }

        const JIKAN_API_BASE_URL = "https://api.jikan.moe/v4", TMDB_API_BASE_URL = "https://api.themoviedb.org/3", TMDB_API_KEY = "6b65819086d354cbdf267b26693c4147"; 
                async function fetchExternalData(type) { 
            const config = PROJECT_CONFIG[type];
            setDisabled(config.fetchButtonId, true); toggleVisibility(config.fetchLoaderId, true, false); 
            try {
                if (type === 'anime') {
                    let malId = getVal('projectMalId');
                    if (!malId && getVal('projectUrl')) { const m = getVal('projectUrl').match(/myanimelist\.net\/anime\/(\d+)/); if (m && m[1]) { malId = m[1]; setVal('projectMalId', malId); } }
                    if (!malId) { showAlert('يرجى إدخال معرف MAL أو رابط MAL صالح.', 'warning'); return; }
                    const resp = await fetch(`${JIKAN_API_BASE_URL}/anime/${malId}`); if (!resp.ok) { const err = await resp.json(); throw new Error(`MAL ${resp.status}: ${err.message || 'فشل'}`); }
                    const d = (await resp.json()).data;
                    requestAnimationFrame(() => { 
                        setVal('entityName', d.title || d.title_english || d.title_japanese || ''); 
                        setVal('projectUrl', d.url || ''); 
                        setVal('projectImageUrl', d.images?.jpg?.large_image_url || d.images?.jpg?.image_url || ''); 
                        setVal('projectAnimeType', d.type || ''); 
                        setVal('projectStudio', (d.studios || []).map(s => s.name).join(', ') || ''); 
                        setVal('projectSource', d.source || ''); 
                        setVal('projectPremiered', d.aired?.from ? new Date(d.aired.from).toLocaleDateString('en-CA') : (d.year || '')); 
                        setVal('projectGenres', (d.genres || []).map(g => g.name).join(', ')); 
                        setVal('projectThemes', (d.themes || []).map(t => t.name).join(', ')); 
                        setVal('totalEpisodes', d.episodes || ''); 
                        setVal('projectDuration', d.duration || ''); 
                        setVal('projectRating', d.rating || ''); 
                        setVal('projectScore', d.score || ''); 
                        setVal('projectSynopsis', d.synopsis || ''); 
                        showAlert('تم جلب بيانات MAL!', 'success'); 
                    });
                } else if (type === 'series') {
                    const seriesName = getVal('projectSeriesNameSearch'); if (!seriesName) { showAlert('يرجى إدخال اسم المسلسل للبحث.', 'warning'); return; }
                    if (!TMDB_API_KEY || TMDB_API_KEY === "YOUR_TMDB_API_KEY") { showAlert('مفتاح TMDB API غير مهيأ.', 'danger'); return; }
                    const resp = await fetch(`${TMDB_API_BASE_URL}/search/tv?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(seriesName)}&language=ar-SA&include_adult=false`); if (!resp.ok) throw new Error(`TMDB Search ${resp.status}: فشل`);
                    const searchData = await resp.json();
                    requestAnimationFrame(() => { const list = getEl('tmdbResultsList'); list.innerHTML = ''; if (searchData.results && searchData.results.length > 0) { searchData.results.slice(0, 10).forEach(s => { const li = document.createElement('li'); li.style.cssText = "padding:10px;border-bottom:1px solid var(--border-color);cursor:pointer;"; const year = s.first_air_date ? `(${new Date(s.first_air_date).getFullYear()})` : ''; li.textContent = `${s.name} ${year}`; li.onclick = () => { fetchTmdbSeriesDetails(s.id); closeModal('tmdbResultsModal'); }; list.appendChild(li); }); setStyle('tmdbResultsModal', 'display', 'block'); } else showAlert('لم يتم العثور على نتائج.', 'info'); });
                }
            } catch (error) { console.error(`Error fetching ${type} data:`, error); requestAnimationFrame(() => showAlert(`فشل جلب بيانات ${type}: ${error.message}`, 'danger')); }
            finally { setDisabled(config.fetchButtonId, false); toggleVisibility(config.fetchLoaderId, false, false); } 
        }
        async function fetchTmdbSeriesDetails(seriesId) {
            setDisabled(PROJECT_CONFIG.series.fetchButtonId, true); toggleVisibility(PROJECT_CONFIG.series.fetchLoaderId, true, false); 
            try { 
                const arDetailsPromise = fetch(`${TMDB_API_BASE_URL}/tv/${seriesId}?api_key=${TMDB_API_KEY}&language=ar-SA`);
                const enDetailsPromise = fetch(`${TMDB_API_BASE_URL}/tv/${seriesId}?api_key=${TMDB_API_KEY}&language=en-US`);
                const [arResp, enResp] = await Promise.all([arDetailsPromise, enDetailsPromise]);
                if (!arResp.ok || !enResp.ok) throw new Error(`TMDB Details fetch failed`); 
                const arData = await arResp.json();
                const enData = await enResp.json();
                requestAnimationFrame(() => { 
                    setVal('entityName', enData.name || arData.name || ''); 
                    setVal('projectTmdbUrl', `https://www.themoviedb.org/tv/${enData.id}`); 
                    setVal('projectSeriesYear', enData.first_air_date ? new Date(enData.first_air_date).getFullYear().toString() : ''); 
                    setVal('projectSeriesNetwork', (enData.networks || []).map(n => n.name).join(', ')); 
                    setVal('projectSeriesStatusTMDB', enData.status || ''); 
                    setVal('projectSeriesOverview', arData.overview || enData.overview || ''); 
                    setVal('projectSeriesGenres', (enData.genres || []).map(g => g.name).join(', '));
                    setVal('totalEpisodes', enData.number_of_episodes || ''); 
                    setVal('projectSeriesVoteAverage', enData.vote_average ? enData.vote_average.toFixed(1) : ''); 
                    setVal('projectSeriesPosterUrl', enData.poster_path ? `https://image.tmdb.org/t/p/w500${enData.poster_path}` : ''); 
                    setVal('projectSeriesOriginCountry', (enData.origin_country || []).join(', ')); 
                    setVal('projectSeriesOriginalLanguage', enData.original_language || ''); 
                    setVal('projectSeriesEpisodeRunTime', (enData.episode_run_time || []).join(', ') || ''); 
                    showAlert('تم جلب بيانات TMDB!', 'success'); 
                });
            } catch (error) { console.error("Error fetching TMDB details:", error); requestAnimationFrame(() => showAlert(`فشل جلب تفاصيل TMDB: ${error.message}`, 'danger')); }
            finally { setDisabled(PROJECT_CONFIG.series.fetchButtonId, false); toggleVisibility(PROJECT_CONFIG.series.fetchLoaderId, false, false); } 
        }

        function loadArchivedProjects(filterType = 'all') { 
            currentFilteredAndSortedItems.archive = getProcessedItemsForType('archive'); 
            loadDataIntoGrid('archive', currentFilteredAndSortedItems.archive); 
        }

        function logRecentActivity(message, details = null) { 
            if (!data.recentActivityLog) data.recentActivityLog = [];
            data.recentActivityLog.unshift({timestamp: new Date().toISOString(), message: message, details: details}); 
            if (data.recentActivityLog.length > 50000) data.recentActivityLog.pop(); 
            
            if (getEl('dashboard').classList.contains('active')) {
                updateRecentActivityDisplay();
            }
        }

        function updateRecentActivityDisplay() {
            requestAnimationFrame(() => {
                const listEl = getEl('recentActivityList');
                if (!listEl) return;
                
                const activitiesToDisplay = getProcessedRecentActivity().slice(0, 10); 

                if (activitiesToDisplay.length === 0) {
                    listEl.innerHTML = `<li class="text-center text-muted">لا يوجد نشاط حديث${globalSearchQuery ? ' يطابق بحثك' : ''}.</li>`;
                    return;
                }
                
                let html = '';
                activitiesToDisplay.forEach(activity => {
                    html += `<li>${activity.message} <span class="activity-time">${formatDateTime(activity.timestamp)}</span></li>`;
                });
                listEl.innerHTML = html;
            });
        }
        
        function getProcessedRecentActivity() {
            let activities = [...(data.recentActivityLog || [])];
            if (globalSearchQuery) {
                activities = activities.filter(activity =>
                    activity.message.toLowerCase().includes(globalSearchQuery)
                );
            }
            return activities;
        }


        function showProjectTeamModal(projectId, projectType) { 
            requestAnimationFrame(() => {
                const modalBody = getEl('projectTeamModalBody'); modalBody.innerHTML = '<div class="spinner"></div>'; 
                let project = [...data.anime, ...data.series].find(p => p.id === projectId);
                if (!project) { modalBody.innerHTML = '<p class="text-center text-muted">لم يتم العثور على المشروع.</p>'; setText('projectTeamModalTitle', 'فريق عمل المشروع'); setStyle('projectTeamModal', 'display', 'block'); return; }
                setText('projectTeamModalTitle', `فريق عمل: ${project.name}`); let teamHtml = ''; let hasMembers = false;
                const roles = [{role:'مترجم',id:project.translatorId,price:project.translationPrice,bonus:project.translationBonus}, {role:'مدقق',id:project.editorId,price:project.editingPrice,bonus:project.editingBonus}, {role:'محاكي',id:project.timerId,price:project.timerPrice,bonus:project.timerBonus}, {role:'موقت',id:project.subtitlerId,price:project.subtitlerPrice,bonus:project.subtitlerBonus}];
                roles.forEach(item => { if (item.id) { const member = data.members.find(m => m.id === item.id); if (member) { hasMembers = true; const payment = (project.completedEpisodes||0)*(item.price||0)+(item.bonus||0); teamHtml += `<div class="team-member-item"><img src="${member.avatarUrl||`https://placehold.co/40x40/718096/e5e7eb?text=${member.name.charAt(0)}`}" alt="${member.name}"><div class="team-member-info"><h5>${member.name}</h5><p><span class="role">${item.role}</span></p><p>الأجر: <span class="payment ${getMoneyClass(payment)}">${formatMoney(payment)}</span> (سعر الحلقة: ${formatMoney(item.price||0)}, إضافي/خصم: ${formatMoney(item.bonus||0)})</p></div></div>`; } } });
                modalBody.innerHTML = hasMembers ? teamHtml : '<p class="text-center text-muted">لم يتم تعيين أعضاء لهذا المشروع.</p>'; setStyle('projectTeamModal', 'display', 'block');
            });
        }
        
        function showProjectDetailsModal(projectId, projectType) {
            requestAnimationFrame(() => {
                const project = [...data.anime, ...data.series].find(p => p.id === projectId); 
                if (!project) { showAlert('لم يتم العثور على المشروع!', 'danger'); return; }
                
                const actualType = data.anime.some(a => a.id === projectId) ? 'anime' : 'series';
                const config = PROJECT_CONFIG[actualType]; 
                if (!config) { showAlert('نوع مشروع غير صالح!', 'danger'); return; }
                
                setText('projectDetailsModalTitle', `تفاصيل: ${project.name}`); 
                const modalBody = getEl('projectDetailsModalBody'); 
                modalBody.innerHTML = '';
                
                const addSection = (titleIcon, titleText, contentHtml) => { 
                    const section = document.createElement('div'); 
                    section.className = 'project-modal-section'; 
                    section.innerHTML = `<h5><i class="fas ${titleIcon}"></i> ${titleText}</h5>${contentHtml}`; 
                    modalBody.appendChild(section); 
                };
                
                let extInfo = '<div class="info-grid">'; 
                const addInfoItem = (lbl, val, isLink, searchTerm) => { 
                    if (val) { 
                        const cleanVal = String(val); 
                        const term = searchTerm || cleanVal; 
                        if (isLink) {
                            extInfo += `<div class="info-item"><label>${lbl}:</label> <span><a href="${cleanVal}" target="_blank" style="color:var(--accent-blue);">${cleanVal}</a></span></div>`;
                        } else {
                            extInfo += `<div class="info-item"><label>${lbl}:</label> <span class="info-clickable" onclick="closeModal('projectDetailsModal'); quickSearch('${String(term).replace(/'/g, "\\'")}')">${cleanVal}</span></div>`;
                        }
                    } 
                };
                
                addInfoItem('الحلقات', project.totalEpisodes, false); 
                addInfoItem(`رابط ${config.externalLinkName}`, project[config.externalLinkProperty], true);
                
                if (actualType === 'anime') { 
                    addInfoItem('النوع', project.animeType, false); 
                    addInfoItem('أول عرض', formatDate(project.premiered), false, String(project.premiered).split('-')[0]); 
                    addInfoItem('الاستوديو', project.studio, false); 
                    addInfoItem('المصدر', project.source, false); 
                    
                    if (project.genres && project.genres.length > 0) {
                        extInfo += '<div class="info-item"><label>التصنيفات:</label> <span>';
                        extInfo += project.genres.map(g => 
                            `<span class="info-genre-tag" onclick="closeModal('projectDetailsModal'); quickSearch('${String(g).replace(/'/g, "\\'")}')">${g}</span>`
                        ).join(' ');
                        extInfo += '</span></div>';
                    }
                    
                    if (project.themes && project.themes.length > 0) {
                        extInfo += '<div class="info-item"><label>المواضيع:</label> <span>';
                        extInfo += project.themes.map(t => 
                            `<span class="info-genre-tag" onclick="closeModal('projectDetailsModal'); quickSearch('${String(t).replace(/'/g, "\\'")}')">${t}</span>`
                        ).join(' ');
                        extInfo += '</span></div>';
                    }
                    
                    addInfoItem('المدة', project.duration, false); 
                    addInfoItem('التصنيف العمري', project.rating, false); 
                    addInfoItem('التقييم', project.score, false); 
                } else { 
                    addInfoItem('سنة أول عرض', project.seriesYear, false); 
                    addInfoItem('الشبكة', project.seriesNetwork, false); 
                    
                    if (project.seriesGenres && project.seriesGenres.length > 0) {
                        extInfo += '<div class="info-item"><label>التصنيفات:</label> <span>';
                        extInfo += project.seriesGenres.map(g => 
                            `<span class="info-genre-tag" onclick="closeModal('projectDetailsModal'); quickSearch('${String(g).replace(/'/g, "\\'")}')">${g}</span>`
                        ).join(' ');
                        extInfo += '</span></div>';
                    }
                    
                    addInfoItem('متوسط التقييم', project.seriesVoteAverage, false); 
                    addInfoItem('رابط البوستر', project.seriesPosterUrl, true); 
                    
                    if (project.seriesOriginCountry && project.seriesOriginCountry.length > 0) {
                        extInfo += '<div class="info-item"><label>بلد المنتج:</label> <span>';
                        extInfo += project.seriesOriginCountry.map(c => 
                            `<span class="info-genre-tag" onclick="closeModal('projectDetailsModal'); quickSearch('${String(c).replace(/'/g, "\\'")}')">${c}</span>`
                        ).join(' ');
                        extInfo += '</span></div>';
                    }
                    
                    addInfoItem('اللغة الأصلية', project.original_language, false); 
                    addInfoItem('مدة الحلقة', `${project.seriesEpisodeRunTime} دقيقة`, false); 
                }
                
                extInfo += '</div>'; 
                addSection('fa-info-circle', 'معلومات إضافية', extInfo || '<p class="text-sm text-muted">لا توجد.</p>');
                
                const synopsis = project.synopsis || project.seriesOverview; 
                addSection('fa-align-left', 'نبذة قصيرة', `<p class="series-overview-modal">${synopsis || 'لا توجد نبذة.'}</p>`);
                
                setStyle('projectDetailsModal', 'display', 'block');
            });
        }

        function showProjectNotesModal(projectId, projectType) {
            const project = [...data.anime, ...data.series].find(p => p.id === projectId);
            if (!project) return;
            const notes = project.notes || 'لا توجد ملاحظات داخلية لهذا المشروع.';
            const title = `ملاحظات داخلية: ${project.name}`;
            const footer = `<button type="button" class="btn btn-secondary" onclick="closeModal('instructionsModal')">إغلاق</button>`;
            showInstructionsModal(title, `<p style="white-space: pre-wrap;">${notes}</p>`, footer);
        }

        function openRawLink(url) {
            if (url && isValidUrl(url)) {
                window.open(url, '_blank');
            } else {
                showAlert('لم يتم تحديد رابط الملفات الخام لهذا المشروع. يمكنك إضافته من خلال تعديل المشروع.', 'info', 4000);
            }
        }

        function toggleProjectCostPopup(projectId, projectType, cardElement) {
            let overlay = document.querySelector('.popup-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'popup-overlay';
                document.body.appendChild(overlay);
            }
            
            let popup = document.querySelector('.project-cost-details-popup');
            if (!popup) {
                popup = document.createElement('div');
                popup.className = 'project-cost-details-popup hidden';
                popup.innerHTML = `
                    <button class="close-cost-popup">×</button>
                    <div class="cost-popup-content"></div>
                `;
                document.body.appendChild(popup);
            }
            
            const project = [...data.anime, ...data.series].find(p => p.id === projectId);
            if (!project) return;
            
            if (popup.classList.contains('hidden')) {
                const contentDiv = popup.querySelector('.cost-popup-content');
                
                const completedEps = project.completedEpisodes || 0;
                const totalEps = (project.totalEpisodes > 0) ? project.totalEpisodes : completedEps;
                const costPerEpisode = (project.translationPrice || 0) + (project.editingPrice || 0) + 
                                      (project.timerPrice || 0) + (project.subtitlerPrice || 0);
                const totalBonuses = (project.translationBonus || 0) + (project.editingBonus || 0) + 
                                    (project.timerBonus || 0) + (project.subtitlerBonus || 0);
                const finalCost = (totalEps * costPerEpisode) + totalBonuses;
                
                let html = `
                    <h5><i class="fas fa-calculator"></i> تفاصيل تكلفة: ${project.name}</h5>
                    
                    <div class="cost-summary-section">
                        <h6><i class="fas fa-chart-pie"></i> ملخص التكاليف</h6>
                        <div class="cost-item">
                            <span>التكلفة الحالية (${completedEps} حلقة):</span>
                            <strong class="${getMoneyClass(project.totalCost || 0)}">${formatMoney(project.totalCost || 0)}</strong>
                        </div>`;
                
                if (totalEps > completedEps) {
                    html += `
                        <div class="cost-item">
                            <span>التكلفة عند الاكتمال (${totalEps} حلقة):</span>
                            <strong class="${getMoneyClass(finalCost)}">${formatMoney(finalCost)}</strong>
                        </div>`;
                }
                
                html += `
                        <div class="cost-item">
                            <span>تكلفة الحلقة الواحدة:</span>
                            <strong>${formatMoney(costPerEpisode)}</strong>
                        </div>
                        <div class="cost-item">
                            <span>إجمالي المكافآت/الخصومات:</span>
                            <strong class="${getMoneyClass(totalBonuses)}">${formatMoney(totalBonuses)}</strong>
                        </div>
                    </div>`;
                
                html += '<div class="cost-summary-section"><h6><i class="fas fa-users"></i> تفاصيل الفريق</h6>';
                
                const roles = [
                    { name: 'المترجم', id: project.translatorId, price: project.translationPrice, bonus: project.translationBonus },
                    { name: 'المدقق', id: project.editorId, price: project.editingPrice, bonus: project.editingBonus },
                    { name: 'المحاكي', id: project.timerId, price: project.timerPrice, bonus: project.timerBonus },
                    { name: 'الموقت', id: project.subtitlerId, price: project.subtitlerPrice, bonus: project.subtitlerBonus }
                ];

                roles.forEach(role => {
                    if (role.id) {
                        const member = data.members.find(m => m.id === role.id);
                        if (member) {
                            const currentPayment = (completedEps * (role.price || 0)) + (role.bonus || 0);
                            const finalPayment = (totalEps * (role.price || 0)) + (role.bonus || 0);
                            
                            html += `
                                <div class="member-payment">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <strong>${role.name}: ${member.name}</strong>
                                        <span style="color: var(--accent-purple);">${formatMoney(role.price || 0)}/حلقة</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-size: 0.85em;">
                                        <span>المستحق حالياً:</span>
                                        <span class="${getMoneyClass(currentPayment)}">${formatMoney(currentPayment)}</span>
                                    </div>`;
                            
                            if (totalEps > completedEps) {
                                html += `
                                    <div style="display: flex; justify-content: space-between; font-size: 0.85em;">
                                        <span>المستحق عند الاكتمال:</span>
                                        <span class="${getMoneyClass(finalPayment)}">${formatMoney(finalPayment)}</span>
                                    </div>`;
                            }
                            
                            if (role.bonus !== 0) {
                                html += `
                                    <div style="display: flex; justify-content: space-between; font-size: 0.85em; opacity: 0.8;">
                                        <span>${role.bonus > 0 ? 'مكافأة' : 'خصم'}:</span>
                                        <span class="${getMoneyClass(role.bonus)}">${formatMoney(role.bonus)}</span>
                                    </div>`;
                            }
                            
                            html += '</div>';
                        }
                    }
                });
                
                html += '</div>';
                
                contentDiv.innerHTML = html;
                
                overlay.style.display = 'block';
                popup.classList.remove('hidden');
                
                const closeBtn = popup.querySelector('.close-cost-popup');
                const closePopup = () => {
                    popup.classList.add('hidden');
                    overlay.style.display = 'none';
                };
                
                closeBtn.onclick = closePopup;
                overlay.onclick = closePopup;
                
            } else {
                popup.classList.add('hidden');
                overlay.style.display = 'none';
            }
        }

        function showAlert(message, type = 'info', duration = 3000) { requestAnimationFrame(() => { const alertDiv = document.createElement('div'); alertDiv.className = `alert alert-${type}`; alertDiv.textContent = message; document.body.appendChild(alertDiv); setTimeout(() => alertDiv.remove(), duration); }); }
        function showImagePreview(src) { requestAnimationFrame(() => { if (src && !src.startsWith('https://placehold.co/')) { getEl('previewImage').src = src; setStyle('imagePreviewModal','display','flex'); } }); }
        
        function showFinancialSummary(type) {
            getEl('totalSummaryCard').classList.toggle('hidden', type !== 'total');
            getEl('animeSummaryCard').classList.toggle('hidden', type !== 'anime');
            getEl('seriesSummaryCard').classList.toggle('hidden', type !== 'series');
        }

        function updateDashboard() { 
            requestAnimationFrame(() => { 
                const stats = calculateDashboardStatistics(); 
                updateFinancialSummaries(stats); 
                updateDashboardCharts(stats); 
                updateDetailedStats(stats); 
                updateRecentActivityDisplay(); 
            }); 
        }

        function calculateDashboardStatistics() {
            const stats = { 
                members:{total:data.members.length,active:0,inactive:0,byRole:{translators:0,editors:0,timers:0,subtitlers:0}}, 
                projects:{total:data.anime.length+data.series.length,completed:0,active:0,upcoming:0,stopped:0,completionRate:0, anime:0, series:0},
                episodes:{total:0, totalDefined: 0, avgPerProject:0,byType:{anime:0,series:0}}, 
                financial:{totalCost:0,animeCost:0,seriesCost:0,totalPaid:0,totalRemaining:0,avgCostPerEpisode:{total:0,anime:0,series:0}}, 
                monthlyActivity:[] 
            };
            data.members.forEach(m => { if(m.lastDelivery && Math.floor((new Date()-new Date(m.lastDelivery))/(1000*60*60*24))<=30)stats.members.active++; else stats.members.inactive++; (m.roles||[]).forEach(r=>{if(r==='translator')stats.members.byRole.translators++;if(r==='editor')stats.members.byRole.editors++;if(r==='timer')stats.members.byRole.timers++;if(r==='subtitler')stats.members.byRole.subtitlers++;}); stats.financial.totalPaid+=m.amountReceived||0; });
            [...data.anime,...data.series].forEach(p => { 
                if(p.status==='مكتمل')stats.projects.completed++;else if(p.status==='جارٍ')stats.projects.active++;else if(p.status==='قريباً')stats.projects.upcoming++;else if(p.status==='متوقف')stats.projects.stopped++; 
                const compEps=p.completedEpisodes||0, pCost=p.totalCost||0, totalEps=p.totalEpisodes||0;
                stats.episodes.total+=compEps; 
                stats.episodes.totalDefined += totalEps;
                stats.financial.totalCost+=pCost; 
                if(data.anime.includes(p)){
                    stats.projects.anime++;
                    stats.episodes.byType.anime+=compEps;
                    stats.financial.animeCost+=pCost;
                }else{
                    stats.projects.series++;
                    stats.episodes.byType.series+=compEps;
                    stats.financial.seriesCost+=pCost;
                } 
            });
            stats.projects.completionRate = stats.projects.total > 0 ? Math.round((stats.projects.completed / stats.projects.total) * 100) : 0;
            stats.episodes.avgPerProject = stats.projects.total > 0 ? stats.episodes.total / stats.projects.total : 0;
            stats.financial.totalRemaining = (data.members.reduce((s,m)=>s+(m.totalFee||0),0))-stats.financial.totalPaid;
            stats.financial.avgCostPerEpisode.total = stats.episodes.total > 0 ? stats.financial.totalCost / stats.episodes.total : 0;
            stats.financial.avgCostPerEpisode.anime = stats.episodes.byType.anime > 0 ? stats.financial.animeCost / stats.episodes.byType.anime : 0;
            stats.financial.avgCostPerEpisode.series = stats.episodes.byType.series > 0 ? stats.financial.seriesCost / stats.episodes.byType.series : 0;
            
            const today=new Date();for(let i=29;i>=0;i--){const d=new Date(today);d.setDate(today.getDate()-i);const sD=new Date(d.setHours(0,0,0,0)).toISOString(),eD=new Date(d.setHours(23,59,59,999)).toISOString();stats.monthlyActivity.push({date:d.toLocaleDateString('ar-EG',{day:'numeric',month:'short'}),count:(data.recentActivityLog || []).filter(l=>l.timestamp>=sD&&l.timestamp<=eD).length});}
            return stats;
        }
        function updateFinancialSummaries(s) { setText('totalProjectsCost',formatMoney(s.financial.totalCost)); setText('totalPaidAmount',formatMoney(s.financial.totalPaid)); setText('totalRemainingAmount',formatMoney(s.financial.totalRemaining)); setText('avgCostPerEpisodeTotal',formatMoney(s.financial.avgCostPerEpisode.total)); setText('animeProjectCount',s.projects.anime); setText('animeCompletedEpisodes',s.episodes.byType.anime); setText('animeTotalCost',formatMoney(s.financial.animeCost)); setText('animeAvgCostPerEpisode',formatMoney(s.financial.avgCostPerEpisode.anime)); setText('seriesProjectCount',s.projects.series); setText('seriesCompletedEpisodes',s.episodes.byType.series); setText('seriesTotalCost',formatMoney(s.financial.seriesCost)); setText('seriesAvgCostPerEpisode',formatMoney(s.financial.avgCostPerEpisode.series)); }
        function updateDashboardCharts(s) { drawChart('activityChart','line',{labels:s.monthlyActivity.map(d=>d.date),datasets:[{label:'الأنشطة',data:s.monthlyActivity.map(d=>d.count),borderColor:getCSSVar('--accent-purple'),backgroundColor:'rgba(139,92,246,0.1)',tension:0.4,fill:true,pointBackgroundColor:getCSSVar('--accent-purple'),pointBorderColor:getCSSVar('--text-main'),pointHoverRadius:6,pointRadius:4}]},{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',titleColor:'#fff',bodyColor:'#fff',borderColor:getCSSVar('--accent-purple'),borderWidth:1,padding:10,displayColors:false}},scales:{y:{beginAtZero:true,ticks:{color:getCSSVar('--text-secondary'),stepSize:1},grid:{color:'rgba(255,255,255,0.05)'}},x:{ticks:{color:getCSSVar('--text-secondary'),maxRotation:45,minRotation:45},grid:{display:false}}}},'activityChartInstance'); drawChart('projectStatusChart','doughnut',{labels:['مكتمل','جارٍ','قريباً','متوقف'],datasets:[{data:[s.projects.completed,s.projects.active,s.projects.upcoming,s.projects.stopped],backgroundColor:[getCSSVar('--accent-blue'),getCSSVar('--accent-green'),getCSSVar('--accent-yellow'),getCSSVar('--accent-red')],borderWidth:0}]},{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:getCSSVar('--text-secondary'),padding:15,font:{size:12}}},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',titleColor:'#fff',bodyColor:'#fff',borderColor:getCSSVar('--accent-purple'),borderWidth:1,padding:10}}},'projectStatusChartInstance'); drawMonthlyPaymentsChart('monthlyPaymentsChart'); }
        function getCSSVar(varName) { return getComputedStyle(document.documentElement).getPropertyValue(varName); }
        function drawChart(canvasId,type,data,options,instanceName) { const canvas=getEl(canvasId); if(!canvas||!canvas.getContext)return; if(chartInstances[instanceName])chartInstances[instanceName].destroy(); chartInstances[instanceName]=new Chart(canvas.getContext('2d'),{type,data,options}); }
        
        function updateDetailedStats(s) { 
            let statsHtml = `
                <div class="stat-box">
                    <h5><i class="fas fa-users"></i> توزيع الأعضاء</h5>
                    <ul>
                        <li><span>المترجمون</span><strong>${s.members.byRole.translators}</strong></li>
                        <li><span>المدققون</span><strong>${s.members.byRole.editors}</strong></li>
                        <li><span>المحاكيون</span><strong>${s.members.byRole.timers}</strong></li>
                        <li><span>الموقتون</span><strong>${s.members.byRole.subtitlers}</strong></li>
                        <li><span>إجمالي الأعضاء</span><strong>${s.members.total}</strong></li>
                    </ul>
                </div>
                <div class="stat-box">
                    <h5><i class="fas fa-project-diagram"></i> حالة المشاريع</h5>
                    <ul>
                        <li><span>جارٍ</span><strong class="text-green">${s.projects.active}</strong></li>
                        <li><span>قريباً</span><strong class="text-yellow">${s.projects.upcoming}</strong></li>
                        <li><span>متوقف</span><strong class="text-red">${s.projects.stopped}</strong></li>
                        <li><span>مكتمل</span><strong class="text-blue">${s.projects.completed}</strong></li>
                        <li><span>إجمالي المشاريع</span><strong>${s.projects.total}</strong></li>
                    </ul>
                </div>
                <div class="stat-box">
                    <h5><i class="fas fa-tv"></i> ملخص الحلقات</h5>
                    <ul>
                        <li><span>إجمالي الحلقات المنجزة</span><strong>${s.episodes.total}</strong></li>
                        <li><span>إجمالي حلقات المشاريع</span><strong>${s.episodes.totalDefined}</strong></li>
                        <li><span>حلقات الأنمي</span><strong>${s.episodes.byType.anime}</strong></li>
                        <li><span>حلقات المسلسلات</span><strong>${s.episodes.byType.series}</strong></li>
                        <li><span>متوسط التكلفة/حلقة</span><strong>${formatMoney(s.financial.avgCostPerEpisode.total)}</strong></li>
                    </ul>
                </div>
            `;
            const container = getEl('detailedStatsContainer');
            if(container) container.innerHTML = statsHtml;
        }
        function drawMonthlyPaymentsChart(canvasId) { const monthlyPayments={}; const today=new Date(); for(let i=5;i>=0;i--){const d=new Date(today.getFullYear(),today.getMonth()-i,1);monthlyPayments[d.toLocaleDateString('ar-EG',{year:'numeric',month:'short'})]=0;} data.members.forEach(m=>{if(m.amountReceived&&m.amountReceived>0){const k=Object.keys(monthlyPayments)[0];monthlyPayments[k]+=(m.amountReceived/data.members.length);}}); drawChart(canvasId,'line',{labels:Object.keys(monthlyPayments),datasets:[{label:'المدفوعات',data:Object.values(monthlyPayments),backgroundColor:'rgba(16,185,129,0.2)',borderColor:getCSSVar('--accent-green'),borderWidth:2,fill:true,tension:0.4}]},{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',titleColor:'#fff',bodyColor:'#fff',borderColor:getCSSVar('--accent-green'),borderWidth:1,padding:10,callbacks:{label:c=>'المدفوعات: '+formatMoney(c.parsed.y)}}},scales:{y:{beginAtZero:true,ticks:{color:getCSSVar('--text-secondary'),callback:v=>formatMoney(v)},grid:{color:'rgba(255,255,255,0.05)'}},x:{ticks:{color:getCSSVar('--text-secondary')},grid:{display:false}}}},'monthlyPaymentsChartInstance'); }
        
        function populateMemberReportDropdown() {
            requestAnimationFrame(() => {
                const sel = getEl('reportMemberSelect');
                if (!sel) return;
                const curVal = sel.value;
                sel.innerHTML = '<option value="">تقرير عضو مفصل...</option>';
                data.members.sort((a,b) => a.name.localeCompare(b.name)).forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.name;
                    sel.appendChild(opt);
                });
                if (Array.from(sel.options).some(o => o.value === curVal)) {
                    sel.value = curVal;
                }
            });
        }

        function generateReport(type) {
            requestAnimationFrame(() => {
                let html = '';
                const reportContentEl = getEl('reportContent');
                if (!reportContentEl) return;

                switch (type) {
                    case 'projects':
                        html = generateProjectsReport();
                        break;
                    case 'financial':
                        html = generateFinancialReport();
                        break;
                    case 'memberDetailed':
                        const memberSelect = getEl('reportMemberSelect');
                        const memberId = memberSelect.value;
                        if (!memberId) {
                            reportContentEl.innerHTML = '<p class="text-center text-muted">يرجى اختيار عضو من القائمة لعرض تقريره المفصل.</p>';
                            return; 
                        }
                        html = generateDetailedMemberReport(memberId);
                        break;
                }
                reportContentEl.innerHTML = html || '<p class="text-center text-muted">لا توجد بيانات كافية لإنشاء هذا التقرير.</p>';
            });
        }

        function generateDetailedMemberReport(memberId) {
            const member = data.members.find(m => m.id === memberId);
            if (!member) return '<p class="text-center text-muted">لم يتم العثور على العضو المحدد.</p>';

            let html = `<div class="report-header"><h3>التقرير المفصل للعضو: ${member.name}</h3><p>تاريخ الإنشاء: ${new Date().toLocaleDateString('ar-EG', { dateStyle: 'full' })}</p></div>`;

            html += `<div class="report-section"><h4><i class="fas fa-wallet"></i> ملخص العمل والمستحقات</h4><ul>`;
            const remainingAmount = (member.totalFee || 0) - (member.amountReceived || 0);
            html += `<li>إجمالي الحلقات المترجمة: <strong>${member.projectTranslatedEpisodes || 0}</strong></li>`;
            html += `<li>إجمالي الحلقات المدققة: <strong>${member.projectEditedEpisodes || 0}</strong></li>`;
            html += `<li>إجمالي الحلقات المحاكية: <strong>${member.projectTimedEpisodes || 0}</strong></li>`;
            html += `<li>إجمالي الحلقات الموقتة: <strong>${member.projectSubtitledEpisodes || 0}</strong></li>`;
            html += `<hr style="margin: 10px 0; border-color: var(--border-color);">`;
            html += `<li>الأجرة الكلية المستحقة: <strong class="${getMoneyClass(member.totalFee || 0)}">${formatMoney(member.totalFee || 0)}</strong></li>`;
            html += `<li>المبلغ المستلم: <strong class="money-positive">${formatMoney(member.amountReceived || 0)}</strong></li>`;
            html += `<li>المبلغ المتبقي: <strong class="${getMoneyClass(remainingAmount)}">${formatMoney(remainingAmount)}</strong></li>`;
            html += `</ul></div>`;

            const memberProjects = [...data.anime, ...data.series]
                .map(p => {
                    const rolesInProject = [];
                    const pType = data.anime.some(a => a.id === p.id) ? 'أنمي' : 'مسلسل';
                    const compInP = p.completedEpisodes || 0;
                    if (compInP === 0) return null;

                    let earnings = 0;
                    if (p.translatorId === member.id) {
                        const earned = compInP * (p.translationPrice || 0) + (p.translationBonus || 0);
                        rolesInProject.push({ role: 'مترجم', earned });
                        earnings += earned;
                    }
                    if (p.editorId === member.id) {
                        const earned = compInP * (p.editingPrice || 0) + (p.editingBonus || 0);
                        rolesInProject.push({ role: 'مدقق', earned });
                        earnings += earned;
                    }
                    if (p.timerId === member.id) {
                        const earned = compInP * (p.timerPrice || 0) + (p.timerBonus || 0);
                        rolesInProject.push({ role: 'محاكي', earned });
                        earnings += earned;
                    }
                     if (p.subtitlerId === member.id) {
                        const earned = compInP * (p.subtitlerPrice || 0) + (p.subtitlerBonus || 0);
                        rolesInProject.push({ role: 'موقت', earned });
                        earnings += earned;
                    }

                    if (rolesInProject.length > 0) {
                        return `<tr><td>${p.name} (${pType})</td><td>${rolesInProject.map(r => r.role).join('، ')}</td><td>${compInP}</td><td class="${getMoneyClass(earnings)}">${formatMoney(earnings)}</td></tr>`;
                    }
                    return null;
                }).filter(p => p !== null);

            html += `<div class="report-section"><h4><i class="fas fa-tasks"></i> تفاصيل المشاريع</h4>`;
            if (memberProjects.length > 0) {
                html += `<div class="table-container"><table><thead><tr><th>المشروع</th><th>الدور</th><th>الحلقات المنجزة</th><th>الأجرة من المشروع</th></tr></thead><tbody>${memberProjects.join('')}</tbody></table></div>`;
            } else {
                html += `<p class="text-muted">لم يعمل هذا العضو على أي مشاريع مكتملة الحلقات بعد.</p>`;
            }
            html += `</div>`;
            return html;
        }
        
        function generateProjectsReport() {
            let html = `<div class="report-header"><h3>تقرير حالة المشاريع</h3><p>تاريخ الإنشاء: ${new Date().toLocaleDateString('ar-EG', { dateStyle: 'full' })}</p></div>`;
            const projectsByStatus = {
                'جارٍ': { title: 'المشاريع النشطة', list: [] },
                'مكتمل': { title: 'المشاريع المكتملة', list: [] },
                'قريباً': { title: 'المشاريع القادمة', list: [] },
                'متوقف': { title: 'المشاريع المتوقفة', list: [] }
            };

            [...data.anime, ...data.series].forEach(p => {
                if(projectsByStatus[p.status]) {
                    projectsByStatus[p.status].list.push(p);
                }
            });

            const genTable = (title, list) => {
                let tHtml = `<div class="report-section"><h4><i class="fas fa-folder"></i> ${title} (${list.length})</h4>`;
                if (list.length === 0) {
                    tHtml += `<p class="text-muted">لا توجد مشاريع في هذه الفئة.</p></div>`;
                    return tHtml;
                }
                tHtml += `<div class="table-container"><table><thead><tr><th>المشروع</th><th>النوع</th><th>التقدم</th><th>الفريق</th><th>التكلفة</th></tr></thead><tbody>`;
                list.forEach(p => {
                    const perc = p.totalEpisodes > 0 ? ((p.completedEpisodes / p.totalEpisodes) * 100).toFixed(1) : 0;
                    const type = data.anime.some(a => a.id === p.id) ? 'أنمي' : 'مسلسل';
                    const team = ['translatorId', 'editorId', 'timerId', 'subtitlerId']
                               .map(roleId => p[roleId] ? data.members.find(m => m.id === p[roleId])?.name : null)
                               .filter(Boolean).join('، ') || '-';
                    tHtml += `<tr><td>${p.name}</td><td>${type}</td><td>${p.completedEpisodes||0}/${p.totalEpisodes||'?'} (${perc}%)</td><td>${team}</td><td class="${getMoneyClass(p.totalCost||0)}">${formatMoney(p.totalCost||0)}</td></tr>`;
                });
                tHtml += `</tbody></table></div></div>`;
                return tHtml;
            };

            html += genTable(projectsByStatus['جارٍ'].title, projectsByStatus['جارٍ'].list);
            html += genTable(projectsByStatus['مكتمل'].title, projectsByStatus['مكتمل'].list);
            html += genTable(projectsByStatus['قريباً'].title, projectsByStatus['قريباً'].list);
            html += genTable(projectsByStatus['متوقف'].title, projectsByStatus['متوقف'].list);
            return html;
        }
        
        function generateFinancialReport() {
            const stats = calculateDashboardStatistics();
            const memberEarnings = data.members.map(member => ({
                name: member.name,
                totalFee: member.totalFee || 0,
                amountReceived: member.amountReceived || 0,
                remaining: (member.totalFee || 0) - (member.amountReceived || 0)
            })).sort((a, b) => b.remaining - a.remaining);

            let html = `
                <div class="report-header">
                    <h3>التقرير المالي الشامل</h3>
                    <p>تاريخ الإنشاء: ${new Date().toLocaleDateString('ar-EG', { dateStyle: 'full' })}</p>
                </div>
                <div class="report-section">
                    <h4><i class="fas fa-chart-bar"></i> الملخص المالي العام</h4>
                    <div class="summary-grid" style="margin-top:1rem; grid-template-columns: repeat(3, 1fr);">
                        <div class="summary-item"><label>إجمالي التكلفة</label><span class="amount ${getMoneyClass(stats.financial.totalCost)}">${formatMoney(stats.financial.totalCost)}</span></div>
                        <div class="summary-item"><label>إجمالي المدفوع</label><span class="amount money-positive">${formatMoney(stats.financial.totalPaid)}</span></div>
                        <div class="summary-item"><label>المستحقات المتبقية</label><span class="amount ${getMoneyClass(stats.financial.totalRemaining)}">${formatMoney(stats.financial.totalRemaining)}</span></div>
                    </div>
                </div>
                <div class="report-section">
                    <h4><i class="fas fa-users"></i> مستحقات الأعضاء</h4>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>العضو</th><th>إجمالي المستحقات</th><th>المدفوع</th><th>المتبقي</th></tr></thead>
                            <tbody>
                                ${memberEarnings.map(m => `
                                <tr>
                                    <td>${m.name}</td>
                                    <td>${formatMoney(m.totalFee)}</td>
                                    <td class="money-positive">${formatMoney(m.amountReceived)}</td>
                                    <td style="font-weight:bold;" class="${getMoneyClass(m.remaining)}">${formatMoney(m.remaining)}</td>
                                </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr style="font-weight:bold; background-color: var(--bg-hover-user);">
                                    <td>المجموع</td>
                                    <td>${formatMoney(stats.financial.totalCost)}</td>
                                    <td class="money-positive">${formatMoney(stats.financial.totalPaid)}</td>
                                    <td class="${getMoneyClass(stats.financial.totalRemaining)}">${formatMoney(stats.financial.totalRemaining)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;
            return html;
        }

        function printReport() {
            const content = getEl('reportContent').innerHTML;
            if (!content || content.includes("اختر نوع التقرير")) {
                showAlert('يرجى إنشاء تقرير أولاً.', 'warning');
                return;
            }
            window.print();
        }

        function saveReportAsHTML() {
            const content = getEl('reportContent').innerHTML;
            if (!content || content.trim() === '' || content.includes("اختر نوع التقرير")) {
                showAlert('يجب إنشاء تقرير أولاً.', 'warning');
                return;
            }
            const fullHtml = `<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>تقرير - ${new Date().toLocaleDateString('ar-EG')}</title><style>:root{--text-main:#f0f0f0;--text-secondary:#a0aec0;--border-color:#4a5568;--bg-primary-user:#0f0f0f;--bg-secondary-user:#1a1a1a;--bg-card-user:#242424;--bg-hover-user:#2a2a2a;--accent-green:#10b981;--accent-yellow:#f59e0b;--accent-red:#ef4444}body{font-family:Tahoma,Arial,sans-serif;direction:rtl;padding:20px;margin:0 auto;max-width:1200px;background-color:var(--bg-primary-user);color:var(--text-main)}table{width:100%;border-collapse:collapse;margin:20px 0;background-color:var(--bg-card-user)}th,td{border:1px solid var(--border-color);padding:10px;text-align:right}th{background-color:var(--bg-secondary-user)}.report-header{background:var(--bg-secondary-user);padding:20px;margin-bottom:20px;border-radius:8px;border:1px solid var(--border-color)}.report-section{margin:20px 0;padding:20px;border:1px solid var(--border-color);border-radius:8px;background:var(--bg-card-user)}.money-positive{color:var(--accent-green)!important}.money-zero{color:var(--accent-yellow)!important}.money-negative{color:var(--accent-red)!important}.table-container{overflow-x:auto}.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}.summary-item{background:var(--bg-secondary-user);padding:15px;border-radius:8px;text-align:center}.summary-item label{display:block;margin-bottom:8px;color:var(--text-secondary)}.summary-item .amount{font-size:1.5em;font-weight:bold}ul{list-style-position:inside;padding-right:20px}li{margin-bottom:8px}h3,h4{border-bottom:2px solid var(--border-color);padding-bottom:10px;margin-bottom:15px}</style></head><body><h1>ReviveSubs</h1>${content}<hr><p>تاريخ التصدير: ${new Date().toLocaleString('ar-EG')}</p></body></html>`;
            downloadFile(fullHtml, `ReviveSubs_Report_${new Date().toISOString().split('T')[0]}.html`, 'text/html');
        }
        
        function downloadFile(content, filename, contentType) {
            const a = document.createElement('a');
            const file = new Blob([content], { type: contentType });
            a.href = URL.createObjectURL(file);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }
        
        function loadSettings() { 
            requestAnimationFrame(() => { 
                updateHeaderSocialLinks(); 
                populateMemberReportDropdown();
                populateBillingCycleDates();
            }); 
        }

        function updateHeaderSocialLinks() {
            requestAnimationFrame(() => {
                const websiteLink = getEl('headerLinkWebsite');
                const discordLink = getEl('headerLinkDiscord');
                const telegramLink = getEl('headerLinkTelegram');
                const driveLink = getEl('headerLinkDrive');
                
                if (websiteLink) websiteLink.href = data.settings.headerLinkWebsiteUrl || "#";
                if (discordLink) discordLink.href = data.settings.headerLinkDiscordUrl || "#";
                if (telegramLink) telegramLink.href = data.settings.headerLinkTelegramUrl || "#";
                if (driveLink) driveLink.href = data.settings.headerLinkDriveUrl || "#";
            });
        }
        
        function validateProjectData() {
            let issues = [];
            
            ['anime', 'series'].forEach(type => {
                data[type].forEach((project, index) => {
                    if (!project.id) {
                        issues.push(`${type}[${index}]: مفقود id`);
                    }
                    if (!project.name) {
                        issues.push(`${type}[${index}]: مفقود name`);
                    }
                    if (!project.status) {
                        issues.push(`${type}[${index}]: مفقود status`);
                    }
                    
                    const config = PROJECT_CONFIG[type];
                    if (config && config.genreProperty) {
                        const genres = project[config.genreProperty];
                        if (genres && !Array.isArray(genres)) {
                            issues.push(`${type}[${index}] (${project.name}): ${config.genreProperty} ليست مصفوفة`);
                        }
                    }
                });
            });
            
            if (issues.length > 0) {
                console.warn('وُجدت مشاكل في البيانات:', issues);
            }
            
            return issues.length === 0;
        }

        function populateBillingCycleDates() {
            const startDateInput = getEl('reportStartDate');
            const endDateInput = getEl('reportEndDate');
            if (!startDateInput || !endDateInput) return;

            const today = new Date();
            endDateInput.value = today.toISOString().split('T')[0];
            
            const lastMonth = new Date();
            lastMonth.setMonth(today.getMonth() - 1);
            startDateInput.value = lastMonth.toISOString().split('T')[0];
        }

        function generateNewBillingReport() {
            const startDateValue = getEl('reportStartDate').value;
            const endDateValue = getEl('reportEndDate').value;
            
            if (!startDateValue || !endDateValue) {
                showAlert('يرجى تحديد تاريخ بدء ونهاية للتقرير.', 'warning');
                return;
            }
            const startDate = new Date(startDateValue);
            const endDate = new Date(endDateValue);
            endDate.setHours(23, 59, 59, 999);

            const reportHtml = generateBillingCycleReport(startDate, endDate);
            getEl('reportContent').innerHTML = reportHtml;
        }

                        function generateBillingCycleReport(startDate, endDate) {
            const periodLogs = (data.recentActivityLog || []).filter(log => {
                const logDate = new Date(log.timestamp);
                return log.details && log.details.type === 'EPISODE_PROGRESS' &&
                       logDate >= startDate && logDate <= endDate;
            });

            const activeMemberData = {};
            periodLogs.forEach(log => {
                const details = log.details;
                const project = [...data.anime, ...data.series].find(p => p.id === details.projectId);
                if (!project) return;
                
                Object.keys(details.team).forEach(roleKey => {
                    const roleInfo = details.team[roleKey];
                    if (roleInfo.id) {
                        const memberId = roleInfo.id;
                        if (!activeMemberData[memberId]) {
                            activeMemberData[memberId] = { workDone: {}, earningsThisPeriod: 0 };
                        }
                        const workKey = `${project.id}_${roleKey}`;
                        if (!activeMemberData[memberId].workDone[workKey]) {
                            activeMemberData[memberId].workDone[workKey] = {
                                projectName: project.name, role: roleToArabic(roleKey),
                                episodesCount: 0, costPerEpisode: (roleInfo.price || 0)
                            };
                        }
                        activeMemberData[memberId].workDone[workKey].episodesCount += details.change;
                    }
                });
            });

            for (const memberId in activeMemberData) {
                let earnings = 0;
                Object.values(activeMemberData[memberId].workDone).forEach(work => {
                    earnings += work.episodesCount * work.costPerEpisode;
                });
                activeMemberData[memberId].earningsThisPeriod = earnings;
            }
            
            const reportMembers = {};
            let grandTotalOwed = 0;

            data.members.forEach(member => {
                const totalOwedForMember = (member.totalFee || 0) - (member.amountReceived || 0);
                grandTotalOwed += totalOwedForMember;

                if (totalOwedForMember !== 0 || activeMemberData[member.id]) {
                    reportMembers[member.id] = {
                        name: member.name,
                        paymentMethod: member.paymentMethod || 'غير محدد',
                        totalFeeAllTime: member.totalFee || 0,
                        amountReceivedAllTime: member.amountReceived || 0,
                        workDone: activeMemberData[member.id] ? activeMemberData[member.id].workDone : {},
                        earningsThisPeriod: activeMemberData[member.id] ? activeMemberData[member.id].earningsThisPeriod : 0,
                    };
                }
            });

            const formattedStartDate = startDate.toLocaleDateString('ar-EG');
            const formattedEndDate = new Date(endDate.getTime()).toLocaleDateString('ar-EG');
            let html = `<div class="report-header"><h3>التقرير المالي لفترة الدفع من ${formattedStartDate} إلى ${formattedEndDate}</h3><p>تاريخ الإنشاء: ${new Date().toLocaleDateString('ar-EG', { dateStyle: 'full' })}</p></div>`;

            html += `<div class="report-section"><h4><i class="fas fa-file-invoice-dollar"></i> إجمالي المستحقات المطلوب دفعها (لكل الأعضاء)</h4><p style="font-size: 1.5em; text-align: center;" class="${getMoneyClass(grandTotalOwed)}">${formatMoney(grandTotalOwed)}</p></div>`;

            if (Object.keys(reportMembers).length === 0) {
                 html += `<div class="report-section"><p class="text-muted text-center">لا يوجد أعضاء لديهم مستحقات حالياً.</p></div>`;
                return html;
            }

            for (const memberId in reportMembers) {
                const member = reportMembers[memberId];
                const totalOwedNow = (member.totalFeeAllTime - member.amountReceivedAllTime);
                const previousBalance = totalOwedNow - member.earningsThisPeriod;

                html += `<div class="report-section"><h4><i class="fas fa-user"></i> ${member.name}</h4>`;
                
                if (member.earningsThisPeriod > 0) {
                    html += `<h5>تفاصيل العمل المنجز في هذه الفترة</h5><div class="table-container"><table><thead><tr><th>العمل والدور</th><th>عدد الحلقات</th><th>التكلفة</th></tr></thead><tbody>`;
                    Object.values(member.workDone).filter(w => w.episodesCount !== 0).forEach(work => {
                        const workTotal = work.episodesCount * work.costPerEpisode;
                        html += `<tr>
                                    <td>${work.projectName} - ${work.role}</td>
                                    <td>${work.episodesCount}</td>
                                    <td class="${getMoneyClass(workTotal)}">${formatMoney(workTotal)}</td>
                                 </tr>`;
                    });
                    html += `</tbody></table></div>`;
                } else {
                    html += `<h5>تفاصيل العمل المنجز في هذه الفترة</h5><p class="text-muted">لم يتم تسجيل أي عمل لهذا العضو خلال الفترة المحددة.</p>`;
                }
                
                html += `<div style="margin-top: 20px;">
                            <h5>الملخص المالي</h5>
                            <ul style="list-style: none; padding: 0;">
                                <li style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);"><span>الرصيد السابق المستحق:</span> <strong class="${getMoneyClass(previousBalance)}">${formatMoney(previousBalance)}</strong></li>
                                <li style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);"><span>أجرة هذه الفترة:</span> <strong class="money-positive">${formatMoney(member.earningsThisPeriod)}</strong></li>
                                <li style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 1.2em;"><strong>المجموع الكلي المطلوب دفعه:</strong> <strong class="${getMoneyClass(totalOwedNow)}">${formatMoney(totalOwedNow)}</strong></li>
                                <li style="display: flex; justify-content: space-between; padding: 8px 0;"><span>طريقة الدفع المسجلة:</span> <strong>${member.paymentMethod}</strong></li>
                            </ul>
                 </div>
                 <div style="margin-top: 20px; text-align: left;">
                    <button class="btn btn-success" id="pay-btn-${memberId}" onclick="recordPayment('${memberId}', ${totalOwedNow})" ${totalOwedNow <= 0 ? 'disabled' : ''}>
                        <i class="fas fa-check-circle"></i> تسجيل دفعة (${formatMoney(totalOwedNow)})
                    </button>
                 </div>`;
                html += `</div>`;
            }

            return html;
        }

        async function recordPayment(memberId, amount) {
            const member = data.members.find(m => m.id === memberId);
            if (!member) return;

            if (!confirm(`هل أنت متأكد من تسجيل دفعة بمبلغ ${formatMoney(amount)} للعضو ${member.name}؟`)) {
                return;
            }

            const memberBefore = JSON.parse(JSON.stringify(member));
            pushToUndoStack('RECORD_PAYMENT', { member: memberBefore }, `دفعة لـ ${member.name}`);

            member.amountReceived = (member.amountReceived || 0) + amount;
            
            logRecentActivity(`تم تسجيل دفعة للعضو ${member.name}`, {
                type: 'PAYMENT_MADE',
                memberId: memberId,
                amount: amount
            });
            
            unsavedChanges = true;
            const success = await saveData();
            
            if (success) {
                showAlert('تم تسجيل الدفعة بنجاح!', 'success');
                
                const payButton = getEl(`pay-btn-${memberId}`);
                if(payButton) {
                    payButton.innerHTML = `<i class="fas fa-check"></i> تم الدفع`;
                    payButton.disabled = true;
                }

                generateNewBillingReport();
                updateDashboard();
                updateCardInDOM('member', memberId, member);
            } else {
                member.amountReceived -= amount;
                unsavedChanges = true;
                showAlert('فشل تسجيل الدفعة.', 'danger');

                undoStack.pop(); 
                updateUndoButtonState();
            }
        }
    </script>
</body>
</html>
